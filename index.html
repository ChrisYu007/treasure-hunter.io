<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d2b45">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    <title>å¯»å®çŒäººå†…æµ‹1.42 - ä¸­åç¾é£Ÿé¦†+è‡ªåŠ¨ç‚¹å‡»å¡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }
        
        body {
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
            overflow: hidden;
            height: 100vh;
            background-color: #0d2b45;
        }
        
        /* å¼€æœºé¡µé¢æ ·å¼ */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(13, 43, 69, 0) 0%, rgba(13, 43, 69, 1) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            animation: fadeIn 1.5s ease-out forwards;
            overflow: hidden;
        }
        
        #splash-screen.fade-out {
            animation: fadeOutToWhite 1.5s ease-out forwards;
        }
        
        #splash-screen .splash-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #87CEEB, #0d2b45);
            z-index: -1;
        }
        
        .splash-bubbles {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .splash-bubble {
            position: absolute;
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.8), rgba(173, 216, 230, 0.6) 60%);
            border-radius: 50%;
            box-shadow: 
                inset 0 0 15px rgba(255, 255, 255, 0.7),
                0 0 15px rgba(173, 216, 230, 0.5);
            animation: float-up-splash 8s infinite ease-in-out;
        }
        
        @keyframes float-up-splash {
            0% { transform: translateY(100vh) translateX(0) scale(0.5); opacity: 0; }
            10% { opacity: 0.8; }
            90% { opacity: 0.8; }
            100% { transform: translateY(-100px) translateX(20px) scale(1); opacity: 0; }
        }
        
        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        @keyframes fadeOutToWhite {
            0% { opacity: 1; background-color: transparent; }
            100% { opacity: 0; background-color: white; }
        }
        
        #white-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 90;
            opacity: 0;
            pointer-events: none;
        }
        
        #white-overlay.fade-in {
            animation: fadeInWhite 1.5s ease-out forwards;
        }
        
        #white-overlay.fade-out {
            animation: fadeOutWhite 1.5s ease-out forwards;
        }
        
        @keyframes fadeInWhite {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        @keyframes fadeOutWhite {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        .splash-content {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    z-index: 2;
    animation: contentFadeIn 2s ease-out forwards;
}
        
        @keyframes contentFadeIn {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        .splash-title {
            font-size: 48px;
            font-weight: bold;
            color: white;
            text-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            margin-bottom: 40px;
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
        }
        
        .splash-subtitle {
            font-size: 24px;
            color: #ffcc00;
            margin-bottom: 60px;
            text-shadow: 0 3px 10px rgba(0, 0, 0, 0.5);
        }
        
        #start-game-btn {
            background: linear-gradient(to right, #3498db, #2ecc71);
            color: white;
            border: none;
            padding: 18px 45px;
            border-radius: 40px;
            cursor: pointer;
            font-size: 24px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
            letter-spacing: 1px;
        }
        
/* æ–°å¢ï¼šé˜²æ²‰è¿·æç¤ºæ ·å¼ */
.anti-addiction-notice {
    position: absolute;
    bottom: 10px;  /* æ”¹ä¸º10pxï¼Œç´§è´´åº•éƒ¨ */
    left: 0;
    width: 100%;
    color: rgba(255, 255, 255, 0.7);
    font-size: 16px;
    text-align: center;
    padding: 10px;
    background-color: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(3px);
    font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
    line-height: 1.5;
    animation: noticeFadeIn 2.5s ease-out forwards;
    opacity: 0;
}

/* æ–°å¢ï¼šé˜²æ²‰è¿·æç¤ºåŠ¨ç”» */
@keyframes noticeFadeIn {
    0% { opacity: 0; transform: translateY(20px); }
    70% { opacity: 0; transform: translateY(20px); }
    100% { opacity: 0.7; transform: translateY(0); }
}

        #start-game-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.5);
        }
        
        /* æ¸¸æˆå®¹å™¨æ ·å¼ */
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            opacity: 0;
            transition: background-image 1.5s ease-in-out;
        }
        
        #game-container.fade-in {
            animation: fadeInGame 1.5s ease-out forwards;
        }
        
        /* åœºæ™¯åˆ‡æ¢åŠ¨ç”» */
        .scene-transition {
            animation: fadeOutIn 1.5s ease-in-out;
        }
        
        @keyframes fadeOutIn {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        
        @keyframes fadeInGame {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        /* æµ·åº•èƒŒæ™¯æ•ˆæœ */
        .seaweed {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 100px;
            background: linear-gradient(to top, rgba(0, 100, 0, 0.7), transparent);
            z-index: 1;
        }
        
        .bubble {
            position: absolute;
            width: 100px;
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 2s linear;
            z-index: 1010;
            filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.3));
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .bubble-outer {
            position: absolute;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.9), rgba(173, 216, 230, 0.7) 60%);
            border-radius: 50%;
            box-shadow: 
                inset 0 0 20px rgba(255, 255, 255, 0.8),
                0 0 20px rgba(173, 216, 230, 0.6);
            animation: float 3s infinite ease-in-out;
        }
        
        .bubble-inner {
            position: absolute;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle at 40% 40%, rgba(255, 255, 255, 0.6), transparent 70%);
            border-radius: 50%;
        }
        
        .bubble-highlight {
            position: absolute;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            top: 20px;
            left: 20px;
            filter: blur(2px);
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-5px) scale(1.05); }
        }
        
        /* æ°”æ³¡çˆ†ç ´æ•ˆæœ */
        .bubble-pop {
            animation: pop 0.5s forwards;
        }
        
        @keyframes pop {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(0); opacity: 0; }
        }
        
        .icon {
            font-size: 35px;
            position: absolute;
            z-index: 1011;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            transition: opacity 0.3s ease;
        }
        
        #question {
            display: block;
            color: #ffcc00; /* äº®é»„è‰² */
        }
        
        #exclamation {
            display: none;
            color: #ffcc00; /* äº®é»„è‰² */
            animation: pulse 1s infinite;
        }
        
@keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.8; }
    100% { transform: scale(1); opacity: 1; }
}
        
        #message {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 24px;
            display: none;
            z-index: 2000;
            text-align: center;
            width: 80%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            border: 2px solid gold;
        }
        
        #instructions {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            color: white;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 15px;
            font-size: 18px;
            z-index: 5;
        }
        
        /* é¡¶éƒ¨æŒ‰é’®æ  - å¢åŠ æŒ‰é’®æ•°é‡ï¼Œè°ƒæ•´å¸ƒå±€ */
        #top-buttons {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            z-index: 100; /* æé«˜z-indexç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
            max-width: 70%;
            justify-content: flex-end;
        }
        
        .top-button {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            text-align: center;
            min-width: 60px;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        
        .top-button:hover {
            background-color: rgba(0, 0, 0, 0.9);
            transform: scale(1.05);
        }
        
        /* èµ„æºæ˜¾ç¤º */
        #resources {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
            z-index: 5;
        }
        
        .resource {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* åœºæ™¯æ˜¾ç¤º */
        #current-scene {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 16px;
            z-index: 5;
            text-align: center;
        }
        
        /* æµ·åº•æ°”æ³¡èƒŒæ™¯ */
        .background-bubbles {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        
        .background-bubble {
            position: absolute;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: float-up 15s infinite linear;
        }
        
        @keyframes float-up {
            0% { transform: translateY(100vh) translateX(0); opacity: 0; }
            10% { opacity: 0.5; }
            90% { opacity: 0.5; }
            100% { transform: translateY(-100px) translateX(20px); opacity: 0; }
        }
        
        /* æ¨¡æ€æ¡†é€šç”¨æ ·å¼ */
        .modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1500;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: #1e3a5f;
            border-radius: 15px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            border: 2px solid #3498db;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #3498db;
            padding-bottom: 10px;
        }
        
        .modal-title {
    font-size: 24px;
    color: white;
}

/* æ–°å¢ï¼šå¯ç¼–è¾‘æ ‡é¢˜æ ·å¼ */
#exhibition-title[contenteditable="true"] {
    border-bottom: 1px dashed rgba(255, 255, 255, 0.5);
    padding-bottom: 2px;
    cursor: text;
}

#exhibition-title[contenteditable="true"]:focus {
    outline: 1px solid rgba(52, 152, 219, 0.8);
    background-color: rgba(255, 255, 255, 0.1);
}
        
        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        /* èƒŒåŒ…æ ·å¼ */
        #backpack-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
        }
        
        .treasure-item {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .treasure-item:hover {
            transform: scale(1.05);
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .treasure-icon {
            width: 50px;
            height: 50px;
            object-fit: contain;
            margin: 0 auto 5px;
        }
        
        .treasure-name {
            font-size: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* ä¿®æ”¹ï¼šè—å“æ•°é‡æ˜¾ç¤ºåœ¨å³ä¸Šè§’ */
        .treasure-count {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            z-index: 5;
        }
        
        /* å“è´¨ç­›é€‰æ ‡ç­¾ */
        #quality-tabs {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
            border-bottom: 1px solid #3498db;
            padding-bottom: 10px;
        }
        
        .quality-tab {
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .quality-tab.active {
            background-color: rgba(255, 255, 255, 0.2);
            font-weight: bold;
        }
        
        .quality-all { color: white; }
        .quality-orange { color: #ff9900; }
        .quality-purple { color: #cc66ff; }
        .quality-magenta { color: #ff69b4; } /* ç«çº¢è‰²å“è´¨ */
        .quality-cyan { color: #00ffff; } /* é’è‰²å“è´¨ */
        .quality-blue { color: #3399ff; }
        .quality-green { color: #66cc66; }
        .quality-white { color: #cccccc; }
        .quality-gray { color: #888888; } /* æ–°å¢ï¼šç°è‰²å“è´¨ */
        .quality-box { color: #ffcc00; }
        
        /* å±•è§ˆæ¨¡æ€æ¡†æ ·å¼ */
        #exhibition-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stat {
            text-align: center;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: gold;
        }
        
        .stat-label {
            font-size: 14px;
            color: #ccc;
        }
        
        #exhibition-timer {
            text-align: center;
            font-size: 18px;
            margin: 15px 0;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            color: white;
        }
        
        #exhibition-income {
            text-align: center;
            font-size: 20px;
            margin: 15px 0;
            color: gold;
        }
        
        /* ç ”å‘æ¨¡æ€æ¡†æ ·å¼ */
        .upgrade-item {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .upgrade-name {
            font-size: 18px;
            margin-bottom: 5px;
            color: white;
        }
        
        .upgrade-desc {
            font-size: 14px;
            color: #ccc;
            margin-bottom: 5px;
        }
        
        .upgrade-effect {
            font-size: 14px;
            color: #aaffaa;
            margin-bottom: 5px;
        }
        
        .upgrade-level {
            font-size: 14px;
            color: gold;
            margin-bottom: 5px;
        }
        
        .upgrade-cost {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }
        
        .cost-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: white;
        }
        
        .upgrade-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .upgrade-button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        
        /* å›¾é‰´æ¨¡æ€æ¡†æ ·å¼ - ä¿®æ”¹ä¸ºè—å“å›¾é‰´ */
        #handbook-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
        }
        
        .handbook-item {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            min-height: 100px;
        }
        
        .handbook-item.unknown {
            background-color: rgba(0, 0, 0, 0.3);
        }
        
        .handbook-item.unknown .handbook-icon {
            filter: grayscale(1) brightness(0.3);
        }
        
        /* æœªè·å¾—çš„è—å“ä¸æ˜¾ç¤ºåç§° */
        .handbook-item.unknown .handbook-name {
            display: none;
        }
        
        .handbook-icon {
            width: 50px;
            height: 50px;
            object-fit: contain;
            margin: 0 auto 5px;
        }
        
        .handbook-name {
            font-size: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: white;
        }
        
        /* ç§»é™¤çŠ¶æ€æ˜¾ç¤º */
        .handbook-status {
            display: none;
        }
        
        /* å®ç‰©æç¤ºæ¡† */
        .treasure-tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 2000;
            width: 200px;
            display: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }
        
        .treasure-tooltip .name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .treasure-tooltip .quality {
            margin-bottom: 5px;
        }
        
        .treasure-tooltip .level {
            margin-bottom: 5px;
        }
        
        .treasure-tooltip .description {
            font-size: 14px;
        }
        
        /* å®ç‰©è¯¦æƒ…å¼¹çª— - ä¼˜åŒ–å¸ƒå±€ */
        #treasure-detail {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, rgba(0, 0, 0, 0.95), rgba(20, 40, 70, 0.95));
            color: white;
            padding: 25px;
            border-radius: 20px;
            z-index: 2500;
            display: none;
            text-align: center;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
            border: 3px solid;
            backdrop-filter: blur(10px);
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        #treasure-detail .treasure-image-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            overflow: hidden;
        }
        
        #treasure-detail .treasure-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            position: relative;
            z-index: 2;
            border-radius: 5px;
        }
        
        #treasure-detail .treasure-glow {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 10px;
            filter: blur(15px);
            opacity: 0.8;
            z-index: 1;
            animation: glow-pulse 2s infinite alternate;
        }
        
        @keyframes glow-pulse {
            0% { transform: scale(0.95); opacity: 0.7; }
            100% { transform: scale(1.05); opacity: 0.9; }
        }
        
        #treasure-detail .name {
            font-size: 26px;
            margin: 10px 0 5px;
            font-weight: 700;
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
            letter-spacing: 0.5px;
        }
        
        #treasure-detail .quality {
            font-size: 20px;
            margin-bottom: 8px;
            font-weight: 600;
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
        }
        
        #treasure-detail .level {
            font-size: 18px;
            margin-bottom: 15px;
            color: #ffd700;
            font-weight: 500;
        }
        
        #treasure-detail .description {
            font-size: 17px;
            margin-bottom: 25px;
            line-height: 1.5;
            color: #e0e0e0;
            font-weight: 400;
            padding: 0 10px;
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
            text-align: center;
        }
        
        #close-detail {
            background: linear-gradient(to right, #3498db, #2ecc71);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
        }
        
        #close-detail:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }
        
        /* ç¦»çº¿æ”¶å…¥ç»“ç®—æ¡† - ä¿®æ”¹ä¸ºä¸å®ç‰©è¯¦æƒ…å¼¹çª—ç›¸åŒé…è‰² */
        #offline-income-modal .modal-content {
            background: linear-gradient(145deg, rgba(0, 0, 0, 0.95), rgba(20, 40, 70, 0.95));
            border: 3px solid #3498db;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            max-width: 450px;
            padding: 25px;
        }
        
        #offline-income-content {
            text-align: center;
            padding: 10px 0;
        }
        
        #offline-income-content h3 {
            color: gold;
            margin-bottom: 15px;
            font-size: 26px;
            font-weight: 700;
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
        }
        
        #offline-income-content p {
            font-size: 17px;
            color: #e0e0e0;
            margin-bottom: 20px;
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
        }
        
        #offline-income-amount {
            font-size: 36px;
            color: #2ecc71;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
        }
        
        #offline-time {
            font-size: 18px;
            color: #ccc;
            margin-bottom: 25px;
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
        }
        
        #close-offline-income-btn {
            background: linear-gradient(to right, #3498db, #2ecc71);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
        }
        
        #close-offline-income-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }
        
        #close-offline-income {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        #close-offline-income:hover {
            color: #3498db;
        }
        
        /* å•†åº—æ ·å¼ - æ–°å¢ */
#shop-items {
    display: grid; /* æ”¹ä¸ºgridå¸ƒå±€ */
    grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); /* æ·»åŠ è¿™è¡Œï¼šæ¯åˆ—æœ€å°110pxï¼Œè‡ªåŠ¨å¡«å…… */
    gap: 15px; /* å‡å°‘é—´è· */
    padding: 15px;
    max-height: 60vh; /* é™åˆ¶æœ€å¤§é«˜åº¦ä¸ºè§†å£çš„60% */
    overflow-y: auto; /* æ·»åŠ å‚ç›´æ»šåŠ¨æ¡ */
    scrollbar-width: thin; /* Firefoxæ»šåŠ¨æ¡å®½åº¦ */
    scrollbar-color: rgba(155, 89, 182, 0.5) rgba(0, 0, 0, 0.1); /* Firefoxæ»šåŠ¨æ¡é¢œè‰² */
}

/* Webkitæµè§ˆå™¨æ»šåŠ¨æ¡æ ·å¼ */
#shop-items::-webkit-scrollbar {
    width: 8px;
}

#shop-items::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 4px;
}

#shop-items::-webkit-scrollbar-thumb {
    background: rgba(155, 89, 182, 0.5);
    border-radius: 4px;
}

#shop-items::-webkit-scrollbar-thumb:hover {
    background: rgba(155, 89, 182, 0.7);
}

.shop-item {
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 12px;
    margin: 8px;
    border: 2px solid #ffcc00;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    transition: all 0.3s;
    width: 100%;
    min-height: 150px;
}

.shop-item-image {
    margin-bottom: 8px;
    display: flex;
    justify-content: center;
    align-items: center;
}

.shop-item-image img {
    width: 70px; /* å‡å°å›¾ç‰‡å°ºå¯¸ */
    height: 70px; /* å‡å°å›¾ç‰‡å°ºå¯¸ */
    object-fit: contain;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.shop-item-name {
    font-size: 14px; /* å‡å°å­—ä½“å¤§å° */
    color: #ffcc00;
    margin-bottom: 8px;
    font-weight: 600;
    line-height: 1.3; /* æ·»åŠ è¡Œé«˜ */
    word-break: break-word; /* å…è®¸å•è¯æ¢è¡Œ */
    margin-top: auto; /* ä½¿åç§°é åº•éƒ¨å¯¹é½ */
}

.shop-item-description {
    font-size: 12px; /* å‡å°å­—ä½“å¤§å° */
    color: #ccc;
    margin-bottom: 8px;
    line-height: 1.2; /* å‡å°è¡Œé«˜ */
    display: -webkit-box;
    -webkit-line-clamp: 2; /* æœ€å¤šæ˜¾ç¤º2è¡Œ */
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-align: center; /* æ–‡å­—å±…ä¸­ */
}

.shop-item-price {
    font-size: 14px; /* å‡å°å­—ä½“å¤§å° */
    color: #2ecc71;
    margin-bottom: 8px;
    font-weight: bold;
}

.shop-item-cooldown {
    font-size: 12px; /* å‡å°å­—ä½“å¤§å° */
    color: #3498db;
    margin-bottom: 8px;
}

.shop-item-button {
    padding: 8px 15px; /* å‡å°æŒ‰é’®å†…è¾¹è· */
    border-radius: 20px; /* è°ƒæ•´åœ†è§’ */
    cursor: pointer;
    font-size: 14px; /* å‡å°å­—ä½“å¤§å° */
    font-weight: 600;
    transition: all 0.3s;
    width: 100%;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    min-height: 30px; /* è®¾ç½®æœ€å°é«˜åº¦ */
}

.shop-item-button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
}

.shop-item-button:disabled {
    background: linear-gradient(to right, #666, #777);
    color: #aaa;
    cursor: not-allowed;
    opacity: 0.7;
}

/* å®ç®±æ‰“å¼€å¯¹è¯æ¡†æ ·å¼ - æ–°å¢ */
#open-box-dialog .modal-content {
    max-width: 450px;
    text-align: center;
}

.box-dialog-content {
    padding: 20px 0;
}

.box-dialog-title {
    font-size: 24px;
    color: #ffcc00;
    margin-bottom: 15px;
}

.box-dialog-image {
    width: 150px;
    height: 150px;
    object-fit: contain;
    margin: 0 auto 15px;
    border-radius: 10px;
}

.box-dialog-description {
    font-size: 16px;
    color: #ccc;
    margin-bottom: 20px;
    padding: 0 10px;
}

.box-dialog-buttons {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 20px;
}

.box-dialog-button {
    padding: 12px 30px;
    border-radius: 25px;
    cursor: pointer;
    font-size: 18px;
    font-weight: 600;
    transition: all 0.3s;
    border: none;
    min-width: 120px;
}

.box-dialog-button.open {
    background: linear-gradient(to right, #2ecc71, #27ae60);
    color: white;
}

.box-dialog-button.close {
    background: linear-gradient(to right, #e74c3c, #c0392b);
    color: white;
}

/* åœºæ™¯æ¨¡æ€æ¡†æ ·å¼ */
#scenes-modal .modal-content {
    max-width: 400px;
}
        
        .scene-item {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .scene-item:hover {
            transform: scale(1.05);
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .scene-item.current {
            border: 2px solid #3498db;
        }
        
        .scene-name {
            font-size: 18px;
            color: white;
            margin-bottom: 5px;
        }
        
        .scene-status {
            font-size: 14px;
            color: #ccc;
        }
        
        .scene-status.developing {
            color: #ff9900;
        }

.scene-status.requirement-met {
    color: #66cc66; /* ç»¿è‰²ï¼Œå·²æ»¡è¶³ */
}

.scene-status.requirement-not-met {
    color: #ff6666; /* çº¢è‰²ï¼Œæœªæ»¡è¶³ */
}

        /* å­˜æ¡£æ¨¡æ€æ¡†æ ·å¼ */
        #save-modal .modal-content {
            max-width: 400px;
        }
        
        .save-action {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .save-action:hover {
            transform: scale(1.05);
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .save-action-title {
            font-size: 18px;
            color: white;
            margin-bottom: 5px;
        }
        
        .save-action-desc {
            font-size: 14px;
            color: #ccc;
        }
        
        /* æ–‡ä»¶ä¸Šä¼ æ ·å¼ */
        .file-upload-container {
            margin-top: 10px;
            text-align: center;
        }
        
        .file-input-label {
            display: inline-block;
            background-color: #3498db;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 10px;
            width: 100%;
        }
        
        .file-input-label:hover {
            background-color: #2980b9;
        }
        
        #import-file-input {
            display: none;
        }
        
        #import-message {
            margin-top: 10px;
            text-align: center;
            font-size: 14px;
        }
        
        .save-action-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            width: 100%;
            transition: all 0.3s;
        }
        
        .save-action-button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }
        
        .file-info {
            margin-top: 10px;
            font-size: 12px;
            color: #aaa;
            text-align: center;
        }
        
        /* é­”æ³•å¸ˆäº‹ä»¶æ¨¡æ€æ¡†æ ·å¼ - æ–°å¢ */
#wizard-event-modal .modal-content {
    background: linear-gradient(145deg, rgba(30, 60, 114, 0.95), rgba(15, 30, 60, 0.95));
    border: 3px solid #9b59b6;
    max-width: 500px;
}

/* åˆæˆæ¨¡æ€æ¡†æ ·å¼ - æ–°å¢ */
.synthesis-item {
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    transition: all 0.3s;
}

.synthesis-item:hover {
    background-color: rgba(255, 255, 255, 0.15);
    transform: translateY(-3px);
}

.synthesis-name {
    font-size: 20px;
    color: #ffcc00;
    margin-bottom: 10px;
    font-weight: bold;
}

.synthesis-description {
    font-size: 14px;
    color: #ccc;
    margin-bottom: 15px;
    line-height: 1.4;
}

.synthesis-materials {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 15px;
    padding: 10px;
    background-color: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
}

.material-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 60px;
}

.material-icon {
    width: 40px;
    height: 40px;
    object-fit: contain;
    margin-bottom: 5px;
}

.material-name {
    font-size: 11px;
    text-align: center;
    color: #aaa;
    margin-bottom: 3px;
}

.material-count {
    font-size: 12px;
    color: #ffcc00;
}

.material-count.insufficient {
    color: #ff6666;
}

.synthesis-result {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
    padding: 10px;
    background-color: rgba(46, 204, 113, 0.1);
    border-radius: 8px;
    border-left: 3px solid #2ecc71;
}

.result-arrow {
    font-size: 20px;
    color: #2ecc71;
}

.result-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 60px;
}

.result-icon {
    width: 50px;
    height: 50px;
    object-fit: contain;
    margin-bottom: 5px;
}

.result-name {
    font-size: 12px;
    text-align: center;
    color: #2ecc71;
    font-weight: bold;
}

.synthesis-button {
    background: linear-gradient(to right, #2ecc71, #27ae60);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s;
    width: 100%;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
}

.synthesis-button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
}

.synthesis-button:disabled {
    background: linear-gradient(to right, #666, #777);
    cursor: not-allowed;
    opacity: 0.7;
}

.synthesis-status {
    text-align: center;
    font-size: 14px;
    margin-top: 10px;
    min-height: 20px;
}

.synthesis-status.success {
    color: #2ecc71;
}

.synthesis-status.error {
    color: #e74c3c;
}
        
/* åˆæˆå›¾æ ‡æ ·å¼ */
#synthesis-icons {
    display: grid; /* æ”¹ä¸ºgridå¸ƒå±€ */
    grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); /* æ·»åŠ è¿™è¡Œï¼šæ¯åˆ—æœ€å°110pxï¼Œè‡ªåŠ¨å¡«å…… */
    gap: 15px; /* å‡å°‘é—´è· */
    padding: 15px;
    max-height: 60vh; /* é™åˆ¶æœ€å¤§é«˜åº¦ä¸ºè§†å£çš„60% */
    overflow-y: auto; /* æ·»åŠ å‚ç›´æ»šåŠ¨æ¡ */
    scrollbar-width: thin; /* Firefoxæ»šåŠ¨æ¡å®½åº¦ */
    scrollbar-color: rgba(155, 89, 182, 0.5) rgba(0, 0, 0, 0.1); /* Firefoxæ»šåŠ¨æ¡é¢œè‰² */
}

/* Webkitæµè§ˆå™¨æ»šåŠ¨æ¡æ ·å¼ */
#synthesis-icons::-webkit-scrollbar {
    width: 8px;
}

#synthesis-icons::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 4px;
}

#synthesis-icons::-webkit-scrollbar-thumb {
    background: rgba(155, 89, 182, 0.5);
    border-radius: 4px;
}

#synthesis-icons::-webkit-scrollbar-thumb:hover {
    background: rgba(155, 89, 182, 0.7);
}

.synthesis-icon-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    transition: all 0.3s;
    padding: 12px; /* å‡å°‘å†…è¾¹è· */
    border-radius: 12px; /* ç¨å¾®å‡å°åœ†è§’ */
    background-color: rgba(255, 255, 255, 0.1);
    width: 100%; /* æ”¹ä¸º100%å®½åº¦ï¼Œç”±gridæ§åˆ¶ */
    min-height: 150px; /* è®¾ç½®æœ€å°é«˜åº¦ */
}

.synthesis-icon-item:hover {
    transform: scale(1.05);
    background-color: rgba(255, 255, 255, 0.15);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.synthesis-icon-item img {
    width: 70px; /* å‡å°å›¾ç‰‡å°ºå¯¸ */
    height: 70px; /* å‡å°å›¾ç‰‡å°ºå¯¸ */
    object-fit: contain;
    margin-bottom: 8px;
}

.synthesis-icon-name {
    font-size: 14px; /* å‡å°å­—ä½“å¤§å° */
    text-align: center;
    color: white;
    font-weight: 600;
    line-height: 1.3; /* æ·»åŠ è¡Œé«˜ */
    word-break: break-word; /* å…è®¸å•è¯æ¢è¡Œ */
    margin-top: auto; /* ä½¿åç§°é åº•éƒ¨å¯¹é½ */
}

/* åˆæˆå¯¹è¯æ¡†ææ–™æ ·å¼ */
.material-status {
    background-color: rgba(0, 0, 0, 0.3);
    border-radius: 10px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.material-status img {
    width: 50px;
    height: 50px;
    object-fit: contain;
    margin-bottom: 8px;
}

.material-status-name {
    font-size: 12px;
    margin-bottom: 5px;
    color: #ccc;
}

.material-status-count {
    font-size: 14px;
    font-weight: bold;
}

.material-status-count.enough {
    color: #2ecc71;
}

.material-status-count.not-enough {
    color: #e74c3c;
}

        .wizard-event-title {
            font-size: 28px;
            color: #ffcc00;
            text-align: center;
            margin-bottom: 15px;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
        }
        
        .wizard-event-description {
            font-size: 18px;
            color: #e0e0e0;
            text-align: center;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        
        .event-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .event-option {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
            position: relative;
        }
        
        .event-option:hover {
            transform: translateY(-3px);
            background-color: rgba(255, 255, 255, 0.15);
            border-color: #3498db;
        }
        
.event-option.selected {
    border-color: #2ecc71;
    box-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
    background-color: rgba(46, 204, 113, 0.1);
}

        .event-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .event-option.disabled:hover {
            transform: none;
            background-color: rgba(255, 255, 255, 0.1);
            border-color: transparent;
        }
        
        .event-option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .event-option-title {
            font-size: 18px;
            font-weight: bold;
            color: white;
        }
        
        .event-option-probability {
            font-size: 14px;
            color: #ffcc00;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .event-option-cost {
            font-size: 16px;
            color: #ff6666;
            margin-bottom: 5px;
        }
        
        .event-option-effect {
            font-size: 16px;
            color: #66cc66;
        }
        
        .wizard-event-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .wizard-event-button {
            background: linear-gradient(to right, #9b59b6, #3498db);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .wizard-event-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }
        
        .wizard-event-button.confirm {
    background: linear-gradient(to right, #2ecc71, #27ae60);
}

.wizard-event-button.cancel {
    background: linear-gradient(to right, #e74c3c, #c0392b);
}
        
        .current-buff-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(52, 152, 219, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 10;
            display: none;
        }
        
        .buff-effect {
            position: absolute;
            bottom: 60px;
            right: 10px;
            background-color: rgba(155, 89, 182, 0.8);
            color: white;
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 10;
            display: none;
            text-align: center;
            max-width: 200px;
        }
    </style>
</head>
<body>
    <!-- å¼€æœºé¡µé¢ -->
    <div id="splash-screen">
        <div class="splash-background"></div>
        <div class="splash-bubbles" id="splash-bubbles"></div>
        <div class="splash-content">
            <h1 class="splash-title">å¯»å®çŒäººå†…æµ‹1.42 - ä¸­åç¾é£Ÿé¦†+è‡ªåŠ¨ç‚¹å‡»å¡</h1>
            <div class="splash-subtitle">ç‚¹å‡»é¼ æ ‡ï¼Œä¸€èµ·æ¥å¯»å®</div>
            <button id="start-game-btn">å¼€å§‹æ¸¸æˆ</button>
        </div>
<div class="anti-addiction-notice">é€‚åº¦æ¸¸æˆç›Šè„‘ï¼Œæ²‰è¿·æ¸¸æˆä¼¤èº«ã€‚åˆç†å®‰æ’æ—¶é—´ï¼Œäº«å—å¥åº·ç”Ÿæ´»ã€‚</div>
    </div>
    
    <!-- ç™½è‰²æ¸å˜é®ç½©å±‚ -->
    <div id="white-overlay"></div>
    
    <!-- æ¸¸æˆå®¹å™¨ -->
    <div id="game-container">
        <div class="seaweed"></div>
        <div class="background-bubbles" id="background-bubbles"></div>
        
        <!-- å½“å‰BUFFæ•ˆæœæ˜¾ç¤º -->
        <div class="buff-effect" id="buff-effect"></div>
        
        <!-- èµ„æºæ˜¾ç¤º - å·²ç§»é™¤é‡‘å¸æ˜¾ç¤º -->
        <div id="resources" style="display: none;">
            <div class="resource">
                <span>ğŸ’°</span>
                <span id="gold-count">0</span>
            </div>
        </div>
        
        <!-- å½“å‰åœºæ™¯æ˜¾ç¤º -->
        <div id="current-scene">å½“å‰åœºæ™¯ï¼šåœºæ™¯1ï¼šç«¥å¹´å›å¿†</div>
        
        <!-- é¡¶éƒ¨æŒ‰é’®æ  - å°†æ‰€æœ‰æŒ‰é’®æ”¾åœ¨ä¸€èµ· -->
        <div id="top-buttons">
            <div class="top-button" id="handbook-btn">å›¾é‰´</div>
            <div class="top-button" id="exhibition-btn">å±•è§ˆ</div>
            <div class="top-button" id="research-btn">ç ”å‘</div>
            <div class="top-button" id="backpack-btn">èƒŒåŒ…</div>
<div class="top-button" id="synthesis-btn">åˆæˆ</div>
<div class="top-button" id="hire-btn">é›‡ä½£</div>
<div class="top-button" id="shop-btn">å•†åº—</div>
            <div class="top-button" id="scene-btn">åœºæ™¯</div>
            <div class="top-button" id="save-btn">å­˜æ¡£</div>
        </div>
        
        <!-- æ°”æ³¡ -->
        <div class="bubble" id="bubble">
            <div class="bubble-outer"></div>
            <div class="bubble-inner"></div>
            <div class="bubble-highlight"></div>
            <span class="icon" id="question">â“</span>
            <span class="icon" id="exclamation">â—</span>
        </div>
        
        <div id="message"></div>
        <div id="instructions">ç‚¹å‡»å¼€å§‹å¯»å®ï¼</div>
        
        <!-- è‡ªåŠ¨ç‚¹å‡»å¡å€’è®¡æ—¶ -->
        <div id="auto-click-timer" style="position: absolute; bottom: 20px; left: 20px; display: none; flex-direction: row; align-items: center; justify-content: flex-start; gap: 10px; z-index: 1000;">
            <div id="auto-click-countdown" style="font-size: 8px; color: white; background-color: rgba(0, 0, 0, 0.7); padding: 4px 8px; border-radius: 4px;"></div>
            <button id="auto-click-toggle" style="background-color: rgba(52, 152, 219, 0.8); color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 6px;">æš‚åœ</button>
        </div>
        
        <!-- èƒŒåŒ…æ¨¡æ€æ¡† -->
        <div class="modal" id="backpack-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">æˆ‘çš„èƒŒåŒ…</div>
                    <button class="close-modal" id="close-backpack">Ã—</button>
                </div>
                <div id="quality-tabs">
                    <div class="quality-tab quality-all active" data-quality="all">å…¨éƒ¨</div>
                    <div class="quality-tab quality-orange" data-quality="orange">ä¼ è¯´</div>
                    <div class="quality-tab quality-purple" data-quality="purple">å²è¯—</div>
<div class="quality-tab quality-cyan" data-quality="cyan">ç¥ç§˜</div> <!-- æ–°å¢é’è‰²å“è´¨ -->
                    <div class="quality-tab quality-blue" data-quality="blue">ç¨€æœ‰</div>
                    <div class="quality-tab quality-green" data-quality="green">ç²¾è‰¯</div>
                    <div class="quality-tab quality-white" data-quality="white">æ™®é€š</div>
<div class="quality-tab quality-gray" data-quality="gray">ææ–™</div> <!-- æ–°å¢ç°è‰²å“è´¨ -->
<div class="quality-tab quality-box" data-quality="box">å®ç®±</div> <!-- æ–°å¢å®ç®±ç­›é€‰ -->
                </div>
                <div id="backpack-items">
                    <!-- å®ç‰©ç‰©å“å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                </div>
            </div>
        </div>
        
        <!-- å±•è§ˆæ¨¡æ€æ¡† -->
        <div class="modal" id="exhibition-modal">
            <div class="modal-content">
                <div class="modal-header">
    <div class="modal-title" id="exhibition-title" contenteditable="true">å®ç‰©å±•è§ˆ</div>
    <button class="close-modal" id="close-exhibition">Ã—</button>
</div>
                <div id="exhibition-stats">
    <div class="stat">
        <div class="stat-value" id="total-treasures">0</div>
        <div class="stat-label">æ€»è—å“æ•°</div>
    </div>
    <div class="stat">
        <div class="stat-value" id="orange-treasures">0</div>
        <div class="stat-label">ä¼ è¯´è—å“</div>
    </div>
    <div class="stat">
        <div class="stat-value" id="purple-treasures">0</div>
        <div class="stat-label">å²è¯—è—å“</div>
    </div>
    <!-- æ–°å¢ï¼šç¨€æœ‰è—å“ -->
    <div class="stat">
        <div class="stat-value" id="blue-treasures">0</div>
        <div class="stat-label">ç¨€æœ‰è—å“</div>
    </div>
    <!-- æ–°å¢ï¼šç²¾è‰¯è—å“ -->
    <div class="stat">
        <div class="stat-value" id="green-treasures">0</div>
        <div class="stat-label">ç²¾è‰¯è—å“</div>
    </div>
    <!-- æ–°å¢ï¼šæ™®é€šè—å“ -->
    <div class="stat">
        <div class="stat-value" id="white-treasures">0</div>
        <div class="stat-label">æ™®é€šè—å“</div>
    </div>
    <div class="stat">
        <div class="stat-value" id="current-gold">0</div>
        <div class="stat-label">å½“å‰é‡‘å¸</div>
    </div>
    <div class="stat">
    <div class="stat-value" id="research-keys">0</div>
    <div class="stat-label">ç ”å‘å¯†åŒ™</div>
</div>
<div class="stat">
    <div class="stat-value" id="orange-streak">0</div>
    <div class="stat-label">è¿ç»­æœªå‡ºæ©™è‰²</div>
</div>
<div class="stat">
    <div class="stat-value" id="next-key-giveaway">ç«‹å³é¢†å–</div>
    <div class="stat-label">ä¸‹æ¬¡é¢†é’¥åŒ™</div>
</div>
</div>
                <div id="exhibition-timer">
                    ä¸‹æ¬¡æ”¶å…¥: <span id="income-timer">5:00</span>
                </div>
                <div id="exhibition-income">
                    é—¨ç¥¨æ”¶å…¥: <span id="income-amount">0</span> é‡‘å¸
                </div>
            </div>
        </div>
        
        <!-- ç ”å‘æ¨¡æ€æ¡† -->
        <div class="modal" id="research-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">ç ”å‘ä¸­å¿ƒ</div>
                    <button class="close-modal" id="close-research">Ã—</button>
                </div>
                <div id="research-items">
                    <!-- ç ”å‘é¡¹ç›®å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                </div>
            </div>
        </div>
        
        <!-- å›¾é‰´æ¨¡æ€æ¡† -->
        <div class="modal" id="handbook-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">è—å“å›¾é‰´</div> <!-- ä¿®æ”¹ï¼šå®ç‰©å›¾é‰´æ”¹ä¸ºè—å“å›¾é‰´ -->
                    <button class="close-modal" id="close-handbook">Ã—</button>
                </div>
                <div id="handbook-items">
                    <!-- å›¾é‰´ç‰©å“å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                </div>
            </div>
        </div>
        
        <!-- åœºæ™¯æ¨¡æ€æ¡† -->
        <div class="modal" id="scenes-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">é€‰æ‹©åœºæ™¯</div>
                    <button class="close-modal" id="close-scenes">Ã—</button>
                </div>
                <div id="scenes-list">
                    <!-- åœºæ™¯é€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                </div>
            </div>
        </div>

        <!-- å­˜æ¡£æ¨¡æ€æ¡† -->
        <div class="modal" id="save-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">å­˜æ¡£ç®¡ç†</div>
                    <button class="close-modal" id="close-save">Ã—</button>
                </div>
                <div id="save-actions">
                    <!-- å­˜æ¡£æ“ä½œå°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                </div>
            </div>
        </div>

        <!-- é­”æ³•å¸ˆäº‹ä»¶æ¨¡æ€æ¡† - æ–°å¢ -->
        <div class="modal" id="wizard-event-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">é­”æ³•å¸ˆçš„äº¤æ˜“</div>
                    <button class="close-modal" id="close-wizard-event">Ã—</button>
                </div>
                <div id="wizard-event-content">
                    <div class="wizard-event-title">âœ¨ å¯»å®é­”æ³•å¸ˆ âœ¨</div>
                    <div class="wizard-event-description">çœŸå¹¸è¿ï¼Œä½ é‡åˆ°äº†å¯»å®é­”æ³•å¸ˆï¼æ‘†åœ¨çœ¼å‰çš„æ˜¯ä¸€ç¬”äº¤æ˜“â€¦â€¦</div>
                    <div class="event-options" id="event-options">
                        <!-- äº‹ä»¶é€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                    </div>
                    <div class="wizard-event-actions">
    <button class="wizard-event-button confirm" id="confirm-event-btn">ç¡®è®¤äº¤æ˜“</button>
    <button class="wizard-event-button cancel" id="cancel-event-btn">æ”¾å¼ƒäº¤æ˜“</button>
</div>
                </div>
            </div>
        </div>
        
<div class="modal" id="synthesis-modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">åˆæˆå·¥åŠ</div>
            <button class="close-modal" id="close-synthesis">Ã—</button>
        </div>
        <div id="synthesis-icons">
            <!-- åˆæˆé…æ–¹å›¾æ ‡å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
        </div>
    </div>
</div>

<!-- é›‡ä½£æ¨¡æ€æ¡† - æ–°å¢ -->
<div class="modal" id="hire-modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">é›‡ä½£å¯»å®è€…</div>
            <button class="close-modal" id="close-hire">Ã—</button>
        </div>
        <div style="padding: 15px;">
            <div style="margin-bottom: 15px;">
                <label>é›‡ä½£å¯»å®è€…äººæ•°ï¼š</label>
                <select id="hire-count">
                    <option value="1">1äºº</option>
                    <option value="2">2äºº</option>
                </select>
            </div>
            <div style="margin-bottom: 15px;">
                <label>å¯»å®æ—¶é—´ï¼š</label>
                <select id="hire-duration">
                    <option value="4">4å°æ—¶</option>
                </select>
            </div>
            <div style="margin-bottom: 15px; font-size: 16px; color: #ffcc00;">
                <p>è´¹ç”¨ï¼šæ¯åå¯»å®è€…200ä¸‡é‡‘å¸</p>
<p>æ”¶ç›Šï¼šæ¯åå¯»å®è€…å¯è·å¾—1-3ä¸ªè—å“å®ç®±</p>
<p>æœ€å¤šå¯åŒæ—¶é›‡ä½£2åå¯»å®è€…</p>
            </div>
            <div style="margin-bottom: 15px;">
                <button id="hire-confirm" style="background: linear-gradient(to right, #2ecc71, #27ae60); color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; margin-right: 10px;">ç¡®è®¤é›‡ä½£</button>
                <button id="hire-collect" style="background: linear-gradient(to right, #3498db, #2ecc71); color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 16px;">æ”¶å–ç»“æœ</button>
            </div>
            <div id="hire-status" style="margin-top: 15px; padding: 10px; background-color: rgba(0, 0, 0, 0.3); border-radius: 8px;">
                <div id="hire-status-content">å½“å‰æ²¡æœ‰è¿›è¡Œä¸­çš„é›‡ä½£ä»»åŠ¡</div>
            </div>
        </div>
    </div>
</div>

<!-- å•†åº—æ¨¡æ€æ¡† - æ–°å¢ -->
<div class="modal" id="shop-modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">å•†åº—</div>
            <button class="close-modal" id="close-shop">Ã—</button>
        </div>
        <div id="shop-items">
            <!-- å•†åº—å•†å“å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
        </div>
    </div>
</div>

<!-- æ–°å¢åˆæˆè¯¦æƒ…å¯¹è¯æ¡† -->
<div class="modal" id="synthesis-detail-dialog">
    <div class="modal-content" style="background: linear-gradient(145deg, rgba(0, 0, 0, 0.95), rgba(30, 60, 114, 0.95)); border: 3px solid #9b59b6; max-width: 450px; max-height: 80vh; overflow-y: auto; backdrop-filter: blur(10px);">
        <div class="modal-header">
            <div class="modal-title" style="color: #ffcc00;">åˆæˆè¯¦æƒ…</div>
            <button class="close-modal" id="synthesis-dialog-close">Ã—</button>
        </div>
        <div style="padding: 15px;">
            <div style="margin-bottom: 20px; text-align: center;">
                <img id="synthesis-dialog-image" src="" alt="åˆæˆç›®æ ‡" style="width: 100px; height: 100px; object-fit: contain; border-radius: 10px; margin-bottom: 12px;">
                <div style="font-size: 20px; font-weight: 600; margin-bottom: 8px;" id="synthesis-dialog-name">åˆæˆåç§°</div>
                <div style="font-size: 15px; color: #e0e0e0; margin-bottom: 20px; line-height: 1.4;" id="synthesis-dialog-description">åˆæˆæè¿°</div>
            </div>
            <div style="margin-bottom: 20px;">
                <div style="font-size: 17px; margin-bottom: 12px; color: #ffcc00;">æ‰€éœ€ææ–™ï¼š</div>
                <div id="synthesis-dialog-materials" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; max-height: 150px; overflow-y: auto; padding-right: 5px; scrollbar-width: thin; scrollbar-color: rgba(155, 89, 182, 0.5) rgba(0, 0, 0, 0.1);">
                    <!-- ææ–™å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                </div>
            </div>
            <div id="synthesis-dialog-status" style="margin-bottom: 20px; font-size: 18px; text-align: center;"></div>
            <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
                <button id="synthesis-dialog-confirm" style="background: linear-gradient(to right, #2ecc71, #27ae60); color: white; border: none; padding: 12px 30px; border-radius: 30px; cursor: pointer; font-size: 18px; font-weight: 600; transition: all 0.3s; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);">åˆæˆ</button>
                <button id="synthesis-dialog-cancel" style="background: linear-gradient(to right, #e74c3c, #c0392b); color: white; border: none; padding: 12px 30px; border-radius: 30px; cursor: pointer; font-size: 18px; font-weight: 600; transition: all 0.3s; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
</div>

        <!-- å®ç‰©è¯¦æƒ…å¼¹çª— -->
        <div id="treasure-detail">
            <div class="treasure-image-container">
                <div class="treasure-glow" id="detail-glow"></div>
                <img class="treasure-image" id="detail-image" src="" alt="å®ç‰©å›¾ç‰‡">
            </div>
            <div class="name" id="detail-name">å®ç‰©åç§°</div>
            <div class="quality" id="detail-quality">å“è´¨ï¼šç™½è‰²</div>
            <div class="level" id="detail-level">ç­‰çº§ï¼š1</div>
            <div class="description" id="detail-description">å®ç‰©æè¿°</div>
            <button id="close-detail">ç¡®å®š</button>
        </div>
        
        <!-- ç¦»çº¿æ”¶å…¥ç»“ç®—æ¡† -->
        <div class="modal" id="offline-income-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">ç¦»çº¿ç»“ç®—</div>
                    <button class="close-modal" id="close-offline-income">Ã—</button>
                </div>
                <div id="offline-income-content">
                    <h3>æ¬¢è¿å›æ¥ï¼</h3>
                    <p>æ‚¨ç¦»çº¿æœŸé—´ï¼Œå±•è§ˆé¦†æŒç»­ä¸ºæ‚¨èµšå–é‡‘å¸ï¼š</p>
                    <div id="offline-income-amount">0 é‡‘å¸</div>
                    <div id="offline-time">ç¦»çº¿æ—¶é—´ï¼š0åˆ†é’Ÿ</div>
                    <button id="close-offline-income-btn">ç¡®å®š</button>
                </div>
            </div>
        </div>
        
        <!-- å®ç‰©æç¤ºæ¡† -->
        <div class="treasure-tooltip" id="treasure-tooltip">
            <div class="name">å®ç‰©åç§°</div>
            <div class="quality">å“è´¨ï¼šç™½è‰²</div>
            <div class="level">ç­‰çº§ï¼š1</div>
            <div class="description">å®ç‰©æè¿°</div>
        </div>
        
        <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† -->
        <input type="file" id="import-file-input" accept=".json,.txt" style="display: none;">
    </div>
    
    <!-- å¼•å…¥è—å“æ•°æ® -->
    <script src="treasure-data.js"></script>
    
    <!-- å¼•å…¥ç­–ç•¥ -->
    <script src="game.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // è·å–DOMå…ƒç´ 
            const splashScreen = document.getElementById('splash-screen');
            const splashBubbles = document.getElementById('splash-bubbles');
            const startGameBtn = document.getElementById('start-game-btn');
            const whiteOverlay = document.getElementById('white-overlay');
            const gameContainer = document.getElementById('game-container');
            
            // æ¸¸æˆç›¸å…³DOMå…ƒç´ 
            const bubble = document.getElementById('bubble');
            const question = document.getElementById('question');
            const exclamation = document.getElementById('exclamation');
            const message = document.getElementById('message');
            const instructions = document.getElementById('instructions');
            const backgroundBubbles = document.getElementById('background-bubbles');
            const handbookBtn = document.getElementById('handbook-btn');
            const handbookModal = document.getElementById('handbook-modal');
            const handbookItems = document.getElementById('handbook-items');
            const closeHandbook = document.getElementById('close-handbook');
            const exhibitionBtn = document.getElementById('exhibition-btn');
            const exhibitionModal = document.getElementById('exhibition-modal');
            const closeExhibition = document.getElementById('close-exhibition');
            const researchBtn = document.getElementById('research-btn');
            const researchModal = document.getElementById('research-modal');
            const closeResearch = document.getElementById('close-research');
            const researchItems = document.getElementById('research-items');
            const backpackBtn = document.getElementById('backpack-btn');
            const backpackModal = document.getElementById('backpack-modal');
            const backpackItems = document.getElementById('backpack-items');
            const closeBackpack = document.getElementById('close-backpack');
            const treasureDetail = document.getElementById('treasure-detail');
            const detailImage = document.getElementById('detail-image');
            const detailGlow = document.getElementById('detail-glow');
            const detailName = document.getElementById('detail-name');
            const detailQuality = document.getElementById('detail-quality');
            const detailLevel = document.getElementById('detail-level');
            const detailDescription = document.getElementById('detail-description');
            const closeDetail = document.getElementById('close-detail');
            const treasureTooltip = document.getElementById('treasure-tooltip');
            const goldCountElement = document.getElementById('gold-count');
            const totalTreasuresElement = document.getElementById('total-treasures');
            const orangeTreasuresElement = document.getElementById('orange-treasures');
            const purpleTreasuresElement = document.getElementById('purple-treasures');
            const blueTreasuresElement = document.getElementById('blue-treasures');
            const greenTreasuresElement = document.getElementById('green-treasures');
            const whiteTreasuresElement = document.getElementById('white-treasures');
            const incomeTimerElement = document.getElementById('income-timer');
            const incomeAmountElement = document.getElementById('income-amount');
            const qualityTabs = document.querySelectorAll('.quality-tab');

// æ·»åŠ ç«çº¢è‰²å“è´¨æ ‡ç­¾æ”¯æŒ
const allQualityTab = document.querySelector('.quality-tab[data-quality="all"]');
const qualityTabsContainer = allQualityTab.parentElement;
const magentaTab = document.createElement('div');
magentaTab.className = 'quality-tab quality-magenta';
magentaTab.setAttribute('data-quality', 'magenta');
magentaTab.textContent = 'ç‰¹æ®Š';

// æ’å…¥åˆ°é’è‰²æ ‡ç­¾ä¹‹å‰
const cyanTab = document.querySelector('.quality-tab[data-quality="cyan"]');
qualityTabsContainer.insertBefore(magentaTab, cyanTab);

// æ›´æ–°qualityTabså˜é‡å¹¶é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶
const updatedQualityTabs = document.querySelectorAll('.quality-tab');
// é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œç¡®ä¿æ‰€æœ‰æ ‡ç­¾ï¼ˆåŒ…æ‹¬æ–°æ·»åŠ çš„ç‰¹æ®Šæ ‡ç­¾ï¼‰éƒ½èƒ½æ­£å¸¸å·¥ä½œ
updatedQualityTabs.forEach(tab => {
    tab.addEventListener('click', function() {
        updatedQualityTabs.forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        currentQualityFilter = this.getAttribute('data-quality');
        updateBackpackDisplay();
    });
});
            const currentGoldElement = document.getElementById('current-gold');
            const researchKeysElement = document.getElementById('research-keys');
            const offlineIncomeModal = document.getElementById('offline-income-modal');
            const offlineIncomeAmount = document.getElementById('offline-income-amount');
            const offlineTimeElement = document.getElementById('offline-time');
            const closeOfflineIncomeBtn = document.getElementById('close-offline-income-btn');
            const closeOfflineIncome = document.getElementById('close-offline-income');
            const importFileInput = document.getElementById('import-file-input');
            const currentSceneElement = document.getElementById('current-scene');
            const buffEffectElement = document.getElementById('buff-effect');

            // åˆæˆç›¸å…³DOMå…ƒç´  - æ–°å¢
            let synthesisBtn, synthesisModal, closeSynthesis, synthesisIconsContainer, synthesisDetailDialog, synthesisDetailClose;
            
            // å•†åº—ç›¸å…³DOMå…ƒç´  - æ–°å¢
            let shopBtn, shopModal, closeShop, shopItemsContainer;
            
            // é›‡ä½£ç›¸å…³DOMå…ƒç´  - æ–°å¢
            let hireBtn, hireModal, closeHire, hireCountSelect, hireDurationSelect, hireConfirmBtn, hireCollectBtn, hireStatusContent;
            
            // é­”æ³•å¸ˆäº‹ä»¶ç›¸å…³DOMå…ƒç´  - æ–°å¢
            let wizardEventModal, closeWizardEvent, cancelEventBtn, eventOptionsContainer;

document.getElementById('exhibition-title').addEventListener('blur', function() {
    localStorage.setItem('exhibition-title', this.textContent);
});

            // æ¸¸æˆçŠ¶æ€å˜é‡
let isMoving = false;
let isReturning = false;
let isPopping = false;
let moveInterval;
let treasureTimeout;
let treasureCount = 0; // æ€»å¯»å®æ¬¡æ•°
let backpack = [];
let gold = 0;
let researchKeys = 0;
let lastIncomeTime = Date.now();
let incomeInterval;
let currentQualityFilter = 'all';
let currentScene = 1; // å½“å‰åœºæ™¯
let hasCollectedAllTreasures = false; // æ˜¯å¦å·²æ”¶é›†å…¨éƒ¨è—å“

// æ–°å¢ï¼šæ©™è‰²ç‰©å“ä¿åº•è®¡æ•°å™¨
let orangeGuaranteeCounter = 0; // è¿ç»­æœªå‡ºæ©™è‰²æ¬¡æ•°
let lastOrangeCount = 0; // ä¸Šæ¬¡è·å¾—æ©™è‰²æ—¶çš„å¯»å®æ¬¡æ•°

// æ–°å¢ï¼šæ›¾ç»è·å¾—è¿‡çš„å”¯ä¸€è—å“è®°å½•ï¼ˆåŒ…æ‹¬å·²ç»æ¶ˆè€—æ‰çš„ï¼‰
let obtainedUniqueTreasures = [];

// é­”æ³•å¸ˆäº‹ä»¶ç›¸å…³å˜é‡ - æ–°å¢
let currentBuff = null;
let isEventTriggered = false;
let currentSelectedEvent = null;

// å•†åº—ç›¸å…³å˜é‡ - æ–°å¢
let lastBoxPurchaseTime = 0; // ä¸Šæ¬¡è´­ä¹°å®ç®±çš„æ—¶é—´
let boxPurchaseCount = 0; // å·²è´­ä¹°çš„å®ç®±æ•°é‡
const BOX_COOLDOWN = 0; // 4å°æ—¶å†·å´æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ -> 0 è¡¨ç¤ºæ— å†·å´
const BOX_PURCHASE_LIMIT = 999999; // æ¯5ä¸ªè¿›å…¥å†·å´ -> 999999 è¡¨ç¤ºå‡ ä¹æ— é™åˆ¶

// é›‡ä½£ç›¸å…³å˜é‡ - æ–°å¢
let hireJobs = JSON.parse(localStorage.getItem('hireJobs') || '[]');
let hireInterval;

// è‡ªåŠ¨ç‚¹å‡»ç›¸å…³å˜é‡ - æ–°å¢
let isAutoClicking = false; // æ˜¯å¦æ­£åœ¨è‡ªåŠ¨ç‚¹å‡»
let autoClickTimer = null; // è‡ªåŠ¨ç‚¹å‡»å®šæ—¶å™¨
let autoClickDuration = 0; // å‰©ä½™è‡ªåŠ¨ç‚¹å‡»æ—¶é—´ï¼ˆç§’ï¼‰
let autoClickInterval = null; // è‡ªåŠ¨ç‚¹å‡»é—´éš”å®šæ—¶å™¨
let isAutoClickPaused = false; // è‡ªåŠ¨ç‚¹å‡»æ˜¯å¦æš‚åœ
const AUTO_CLICK_INTERVAL = 100; // è‡ªåŠ¨ç‚¹å‡»é—´éš”ï¼ˆæ¯«ç§’ï¼‰

// æ–°å¢ï¼š12å°æ—¶èµ é€ç ”å‘å¯†åŒ™ç›¸å…³
let lastKeyGiveawayTime = Date.now(); // ä¸Šæ¬¡èµ é€é’¥åŒ™çš„æ—¶é—´
const TWELVE_HOURS = 12 * 60 * 60 * 1000; // 12å°æ—¶çš„æ¯«ç§’æ•°

            // è‡ªåŠ¨ä¿å­˜å±•è§ˆæ ‡é¢˜
            const exhibitionTitle = document.getElementById('exhibition-title');
            if (exhibitionTitle) {
                // ä»æœ¬åœ°å­˜å‚¨è¯»å–ä¿å­˜çš„æ ‡é¢˜
                const savedTitle = localStorage.getItem('exhibition-title');
                if (savedTitle) {
                    exhibitionTitle.textContent = savedTitle;
                }
                
                // æ·»åŠ å¤±å»ç„¦ç‚¹æ—¶è‡ªåŠ¨ä¿å­˜
                exhibitionTitle.addEventListener('blur', function() {
                    localStorage.setItem('exhibition-title', this.textContent);
                });
            }
            
            // ç ”å‘å‡çº§æ•°æ® - ä¿®æ”¹ï¼šç¬¬ä¸€çº§æ¶ˆè€—10000é‡‘å¸ï¼Œç ”å‘é¡¹ç›®1æ”¹ä¸ºæå‡ç´«è‰²åŠä»¥ä¸Šè—å“æ‰ç‡
            let upgrades = {
                treasureRate: { level: 0, maxLevel: 10, cost: 10000, keyCost: 1, effect: 0.10 }, // ä¿®æ”¹ï¼šæ¯çº§æé«˜10%ç´«è‰²åŠä»¥ä¸Šæ‰ç‡
                incomeRate: { level: 0, maxLevel: 10, cost: 10000, keyCost: 1, effect: 0.05 },
                doubleTreasure: { level: 0, maxLevel: 10, cost: 10000, keyCost: 2, effect: 0.005 }
            };
            


            // å½“å‰åœºæ™¯çš„å®ç‰©æ•°æ®
            let currentTreasures = scenes[0].treasures;


            // åˆå§‹åŒ–æ¸¸æˆ
function initGame() {
    bubble.style.left = '50%';
    bubble.style.top = '50%';
    
    createBackgroundBubbles();
    
    loadGame();
    
    // æ–°å¢ï¼šæ£€æŸ¥å¹¶èµ é€æ¯æ—¥ç ”å‘å¯†åŒ™
    checkAndGiveDailyKey();
    
    startIncomeTimer();
    
    updateHandbookDisplay();
    
    // åˆå§‹åŒ–å­˜æ¡£ç›¸å…³å…ƒç´ 
    initSaveElements();
    
    // åˆå§‹åŒ–é­”æ³•å¸ˆäº‹ä»¶ç›¸å…³å…ƒç´ 
    initWizardEventElements();

// åˆå§‹åŒ–é›‡ä½£ç›¸å…³å…ƒç´ 
initHireElements();
initHireSystem();

    // è®¾ç½®åˆå§‹èƒŒæ™¯
    gameContainer.style.backgroundImage = `url('${scenes[currentScene - 1].background}')`;
    gameContainer.style.backgroundSize = 'cover';
    gameContainer.style.backgroundPosition = 'center';
}
            
// æŒ‰é’®æ”¶çº³å±•å¼€ç›¸å…³å˜é‡
let isButtonsExpanded = true;

// åˆ›å»ºå±•å¼€/æ”¶èµ·æŒ‰é’®
function createExpandButton() {
    const topButtons = document.getElementById('top-buttons');
    
    // åˆ›å»ºå±•å¼€æŒ‰é’®
    const expandBtn = document.createElement('div');
    expandBtn.className = 'top-button';
    expandBtn.id = 'expand-btn';
    expandBtn.textContent = 'â–¶'; // åˆå§‹ä¸ºå±•å¼€çŠ¶æ€ï¼Œç®­å¤´å‘å³
    expandBtn.style.cursor = 'pointer';
    
    expandBtn.addEventListener('click', toggleButtons);
    
    // åœ¨å…¶ä»–æŒ‰é’®ä¹‹å‰æ’å…¥å±•å¼€æŒ‰é’®
    topButtons.insertBefore(expandBtn, topButtons.firstChild);
}

// åˆ‡æ¢æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
function toggleButtons() {
    const topButtons = document.getElementById('top-buttons');
    const allButtons = topButtons.querySelectorAll('.top-button:not(#expand-btn)');
    const expandBtn = document.getElementById('expand-btn');
    
    if (isButtonsExpanded) {
        // æ”¶èµ·æŒ‰é’®
        allButtons.forEach(btn => {
            btn.style.display = 'none';
        });
        expandBtn.textContent = 'â—€'; // æ”¶èµ·æ—¶ç®­å¤´å‘å·¦
        isButtonsExpanded = false;
    } else {
        // å±•å¼€æŒ‰é’®
        allButtons.forEach(btn => {
            btn.style.display = 'block';
        });
        expandBtn.textContent = 'â–¶'; // å±•å¼€æ—¶ç®­å¤´å‘å³
        isButtonsExpanded = true;
    }
}



            // ========== åˆæˆåŠŸèƒ½ç›¸å…³å‡½æ•° ========== - æ–°å¢

            // æ›´æ–°åˆæˆæ˜¾ç¤º - ä¿®æ”¹ä¸ºå›¾æ ‡å½¢å¼
function updateSynthesisDisplay() {
    // æ¸…ç©ºç°æœ‰å†…å®¹
    synthesisIconsContainer.innerHTML = '';
    
    synthesisRecipes.forEach(recipe => {
        const iconItem = document.createElement('div');
        iconItem.className = 'synthesis-icon-item';
        iconItem.dataset.recipeId = recipe.id;
        
        // è·å–å“è´¨å¯¹åº”çš„é¢œè‰²
        const qualityColor = qualityColors[recipe.result.quality] || '#ffffff';
        
        iconItem.innerHTML = `
            <img src="${recipe.result.image}" alt="${recipe.result.name}">
            <div class="synthesis-icon-name" style="color: ${qualityColor}">${recipe.result.name}</div>
        `;
        
        // ç‚¹å‡»å›¾æ ‡æ˜¾ç¤ºåˆæˆè¯¦æƒ…å¯¹è¯æ¡†
        iconItem.addEventListener('click', function() {
            showSynthesisDetailDialog(recipe.id);
        });
        
        synthesisIconsContainer.appendChild(iconItem);
    });
}

// æ˜¾ç¤ºåˆæˆè¯¦æƒ…å¯¹è¯æ¡† - æ–°å¢
function showSynthesisDetailDialog(recipeId) {
    const recipe = synthesisRecipes.find(r => r.id === recipeId);
    if (!recipe) return;
    
    // æ›´æ–°å¯¹è¯æ¡†å†…å®¹
document.getElementById('synthesis-dialog-image').src = recipe.result.image;
document.getElementById('synthesis-dialog-image').alt = recipe.result.name;

// è·å–åˆæˆç»“æœçš„å“è´¨é¢œè‰²
const resultQualityColor = qualityColors[recipe.result.quality] || '#ffffff';
const dialogNameElement = document.getElementById('synthesis-dialog-name');
dialogNameElement.textContent = recipe.result.name;
dialogNameElement.style.color = resultQualityColor;

document.getElementById('synthesis-dialog-description').textContent = recipe.description;
    
    // æ¸…ç©ºææ–™å®¹å™¨
    const materialsContainer = document.getElementById('synthesis-dialog-materials');
    materialsContainer.innerHTML = '';
    
    // æ£€æŸ¥ææ–™æ˜¯å¦è¶³å¤Ÿ
    let canCraft = true;
    
    // æ·»åŠ ææ–™æ˜¾ç¤º
    recipe.materials.forEach(material => {
    const materialInBackpack = backpack.find(item => item.name === material.name);
    const hasCount = materialInBackpack ? materialInBackpack.count : 0;
    const hasEnough = hasCount >= material.count;
    
    // æŸ¥æ‰¾ææ–™çš„å›¾ç‰‡å’Œå“è´¨
    let materialImage = '';
    let materialQuality = 'white'; // é»˜è®¤å“è´¨
    for (const scene of scenes) {
        const found = scene.treasures.find(t => t.name === material.name);
        if (found) {
            materialImage = found.image;
            materialQuality = found.quality;
            break;
        }
    }
    
    // è·å–å“è´¨å¯¹åº”çš„é¢œè‰²
    const qualityColor = qualityColors[materialQuality] || '#cccccc';
    
    const materialElement = document.createElement('div');
    materialElement.className = 'material-status';
    materialElement.innerHTML = `
        <img src="${materialImage}" alt="${material.name}">
        <div class="material-status-name" style="color: ${qualityColor}">${material.name}</div>
        <div class="material-status-count ${hasEnough ? 'enough' : 'not-enough'}">
            ${hasCount}/${material.count}
        </div>
    `;
    
    materialsContainer.appendChild(materialElement);
        
        if (!hasEnough) {
            canCraft = false;
        }
    });
    
    // æ›´æ–°çŠ¶æ€å’ŒæŒ‰é’®
    const statusElement = document.getElementById('synthesis-dialog-status');
    const confirmButton = document.getElementById('synthesis-dialog-confirm');
    
    if (canCraft) {
        statusElement.textContent = "ææ–™å……è¶³ï¼Œå¯ä»¥è¿›è¡Œåˆæˆ";
        statusElement.style.color = "#2ecc71";
        confirmButton.disabled = false;
        confirmButton.style.opacity = "1";
    } else {
        statusElement.textContent = "ææ–™ä¸è¶³ï¼Œæ— æ³•åˆæˆ";
        statusElement.style.color = "#e74c3c";
        confirmButton.disabled = true;
        confirmButton.style.opacity = "0.5";
    }
    
// æ˜¾ç¤ºå¯¹è¯æ¡†
document.getElementById('synthesis-detail-dialog').style.display = 'flex';
    
// ç»‘å®šåˆæˆæŒ‰é’®äº‹ä»¶
confirmButton.onclick = function() {
    craftRecipe(recipeId);
    document.getElementById('synthesis-detail-dialog').style.display = 'none';
};

// ç»‘å®šå–æ¶ˆæŒ‰é’®äº‹ä»¶
document.getElementById('synthesis-dialog-cancel').onclick = function() {
    document.getElementById('synthesis-detail-dialog').style.display = 'none';
};

// ç»‘å®šå…³é—­æŒ‰é’®äº‹ä»¶
document.getElementById('synthesis-dialog-close').onclick = function() {
    document.getElementById('synthesis-detail-dialog').style.display = 'none';
};
}

            // æ£€æŸ¥åˆæˆææ–™æ˜¯å¦è¶³å¤Ÿ - æ–°å¢
            function checkRecipeMaterials(recipe) {
                for (const material of recipe.materials) {
                    const materialInBackpack = backpack.find(item => item.name === material.name);
                    if (!materialInBackpack || materialInBackpack.count < material.count) {
                        return false;
                    }
                }
                return true;
            }

            // æ‰§è¡Œåˆæˆ - æ–°å¢
            function craftRecipe(recipeId) {
                const recipe = synthesisRecipes.find(r => r.id === recipeId);
                if (!recipe) return;
                
                // å†æ¬¡æ£€æŸ¥ææ–™
                if (!checkRecipeMaterials(recipe)) {
                    showStatusMessage(recipeId, "ææ–™ä¸è¶³ï¼Œæ— æ³•åˆæˆï¼", "error");
                    return;
                }
                
                // ä»èƒŒåŒ…ä¸­æ‰£é™¤ææ–™
                let allDeducted = true;
                for (const material of recipe.materials) {
                    const materialIndex = backpack.findIndex(item => item.name === material.name);
                    if (materialIndex !== -1) {
                        if (backpack[materialIndex].count > material.count) {
                            backpack[materialIndex].count -= material.count;
                        } else {
                            // åˆšå¥½ç”¨å®Œæˆ–ä¸å¤Ÿ
                            if (backpack[materialIndex].count >= material.count) {
                                backpack.splice(materialIndex, 1);
                            } else {
                                allDeducted = false;
                                break;
                            }
                        }
                    }
                }
                
                if (!allDeducted) {
                    showStatusMessage(recipeId, "åˆæˆå¤±è´¥ï¼Œææ–™æ•°é‡å¼‚å¸¸ï¼", "error");
                    return;
                }
                
                // æ·»åŠ åˆæˆç»“æœåˆ°èƒŒåŒ…
                const existingResult = backpack.find(item => item.name === recipe.result.name);
                if (existingResult) {
                    existingResult.count += 1;
                } else {
                    backpack.push({
                        ...recipe.result,
                        count: 1
                    });
                }
                
                // æ›´æ–°UI
                updateBackpackDisplay();
                updateHandbookDisplay();
                updateExhibitionStats();
                updateSynthesisDisplay();
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showStatusMessage(recipeId, "åˆæˆæˆåŠŸï¼", "success");
                
                // æ˜¾ç¤ºè·å¾—çš„å®ç‰©è¯¦æƒ…
                setTimeout(() => {
                    showTreasureDetail(recipe.result);
                }, 500);
                
                // ä¿å­˜æ¸¸æˆ
                saveGame();
            }

            // æ˜¾ç¤ºåˆæˆçŠ¶æ€æ¶ˆæ¯ - æ–°å¢
            function showStatusMessage(recipeId, message, type) {
                const statusElement = document.getElementById(`status-${recipeId}`);
                if (statusElement) {
                    statusElement.textContent = message;
                    statusElement.className = `synthesis-status ${type}`;
                    
                    // 3ç§’åæ¸…é™¤æ¶ˆæ¯
                    setTimeout(() => {
                        statusElement.textContent = '';
                        statusElement.className = 'synthesis-status';
                    }, 3000);
                }
            }


// ä½¿ç”¨æ•°å­¦å…¬å¼çš„ç®€åŒ–é€’å‡ç®—æ³•ï¼ˆæ¯ä¸ªè—å“ç‹¬ç«‹è®¡ç®—ï¼‰
function calculateEffectiveCount(actualCount) {
    if (actualCount <= 1) return 1;
    if (actualCount >= 20) return 10.5; // 20ä¸ªä»¥åå›ºå®šä¸º3.5
    
    // é€’å‡å…¬å¼ï¼š1 + 0.95 + 0.90 + ... + (1-(n-1)*0.05)
    // æ¯å¢åŠ ä¸€ä¸ªï¼Œé€’å‡5%çš„æƒé‡
    let effectiveCount = 1;
    for (let i = 2; i <= actualCount; i++) {
        const decrement = (i - 1) * 0.05;
        effectiveCount += 1.0 - decrement;
    }
    
    return effectiveCount;
}

            
            // å“è´¨é¢œè‰²æ˜ å°„
const qualityColors = {
    orange: "#ff9900",
    purple: "#cc66ff", 
    magenta: "#ff69b4", // ç«çº¢è‰²å“è´¨
    cyan: "#00ffff", // é’è‰²å“è´¨
    blue: "#3399ff",
    green: "#66cc66",
    white: "#cccccc",
    gray: "#888888",  // æ–°å¢ï¼šç°è‰²å“è´¨
    box: "#ffcc00"    // æ–°å¢ï¼šå®ç®±å“è´¨ï¼ˆé‡‘è‰²ï¼‰
};
            
            // å“è´¨åç§°æ˜ å°„
const qualityNames = {
    orange: "ä¼ è¯´",
    purple: "å²è¯—", 
    magenta: "ç‰¹æ®Š", // ç«çº¢è‰²å“è´¨
    cyan: "ç¥ç§˜", // é’è‰²å“è´¨
    blue: "ç¨€æœ‰",
    green: "ç²¾è‰¯",
    white: "æ™®é€š",
    gray: "ææ–™",  // æ–°å¢ï¼šç°è‰²å“è´¨
    box: "å®ç®±"    // æ–°å¢ï¼šå®ç®±å“è´¨
};
            
// ä½¿ç”¨æ•°å­¦å…¬å¼çš„ç®€åŒ–é€’å‡ç®—æ³•ï¼ˆæ¯ä¸ªè—å“ç‹¬ç«‹è®¡ç®—ï¼Œæ”¯æŒæ— é™é€’å‡ï¼‰
function calculateEffectiveCount(actualCount) {
    if (actualCount <= 1) return 1;
    
    // å¯¹äºå‰20ä¸ªï¼Œä½¿ç”¨é€’å‡ç®—æ³•
    if (actualCount <= 20) {
        let effectiveCount = 1;
        for (let i = 2; i <= actualCount; i++) {
            const decrement = (i - 1) * 0.05;
            effectiveCount += Math.max(0, 1.0 - decrement);
        }
        return effectiveCount;
    } 
    // å¯¹äºç¬¬21ä¸ªåŠä»¥åï¼Œç»§ç»­åº”ç”¨é€’å‡ç®—æ³•
    else {
        let effectiveCount = 1;
        for (let i = 2; i <= actualCount; i++) {
            const decrement = (i - 1) * 0.05;
            effectiveCount += Math.max(0, 1.0 - decrement);
        }
        return effectiveCount;
    }
}

            // å“è´¨åŸºç¡€å€¼ï¼ˆç”¨äºè®¡ç®—å±•è§ˆæ”¶å…¥ï¼‰
const qualityBaseValues = {
    orange: 100,
    purple: 60,
    magenta: 45, // ç«çº¢è‰²å“è´¨
    cyan: 0,
    blue: 30,
    green: 15,
    white: 5,
    gray: 0,
    box: 0  // æ–°å¢ï¼šå®ç®±ä¸è®¡å…¥å±•è§ˆæ”¶å…¥
};


// å“è´¨æ’åºæƒé‡
const qualityWeights = {
    box: 10,
    orange: 6,
    purple: 5,
    magenta: 4.75, // ç«çº¢è‰²å“è´¨
    cyan: 4.5,
    blue: 3,
    green: 2,
    white: 1,
    gray: 0.5
};
            
            // é­”æ³•å¸ˆäº‹ä»¶é…ç½® - æ–°å¢
            const wizardEvents = [
                {
                    id: 1,
                    title: "è“è‰²è—å“äº¤æ˜“",
                    costType: "blueTreasure",
                    costAmount: 1,
                    effect: { type: "blue", rate: 0.10, hunts: 10 },
                    probability: 0.25,
                    description: "æäº¤ä¸€ä¸ªè“è‰²è—å“ï¼Œæœªæ¥10æ¬¡å¯»å®ï¼Œè“è‰²è—å“æ¦‚ç‡æé«˜è‡³10%ã€‚"
                },
                {
                    id: 2,
                    title: "ç´«è‰²è—å“äº¤æ˜“",
                    costType: "purpleTreasure",
                    costAmount: 1,
                    effect: { type: "purple", rate: 0.10, hunts: 10 },
                    probability: 0.20,
                    description: "æäº¤ä¸€ä¸ªç´«è‰²è—å“ï¼Œæœªæ¥10æ¬¡å¯»å®ï¼Œç´«è‰²è—å“æ¦‚ç‡æé«˜è‡³10%ã€‚"
                },
                {
                    id: 3,
                    title: "æ©™è‰²è—å“äº¤æ˜“",
                    costType: "orangeTreasure",
                    costAmount: 1,
                    effect: { type: "orange", rate: 0.10, hunts: 10 },
                    probability: 0.05,
                    description: "æäº¤ä¸€ä¸ªæ©™è‰²è—å“ï¼Œæœªæ¥10æ¬¡å¯»å®ï¼Œæ©™è‰²è—å“æ¦‚ç‡æé«˜è‡³10%ã€‚"
                },
                {
                    id: 4,
                    title: "é’¥åŒ™äº¤æ˜“ï¼ˆè“è‰²ï¼‰",
                    costType: "key",
                    costAmount: 1,
                    effect: { type: "blue", rate: 0.10, hunts: 10 },
                    probability: 0.25,
                    description: "æäº¤1æŠŠé’¥åŒ™ï¼Œæœªæ¥10æ¬¡å¯»å®ï¼Œè“è‰²è—å“æ¦‚ç‡æé«˜è‡³10%ã€‚"
                },
                {
                    id: 5,
                    title: "é’¥åŒ™äº¤æ˜“ï¼ˆç´«è‰²ï¼‰",
                    costType: "key",
                    costAmount: 3,
                    effect: { type: "purple", rate: 0.08, hunts: 10 },
                    probability: 0.20,
                    description: "æäº¤3æŠŠé’¥åŒ™ï¼Œæœªæ¥10æ¬¡å¯»å®ï¼Œç´«è‰²è—å“æ¦‚ç‡æé«˜è‡³8%ã€‚"
                },
                {
                    id: 6,
                    title: "é’¥åŒ™äº¤æ˜“ï¼ˆæ©™è‰²ï¼‰",
                    costType: "key",
                    costAmount: 5,
                    effect: { type: "orange", rate: 0.05, hunts: 10 },
                    probability: 0.05,
                    description: "æäº¤5æŠŠé’¥åŒ™ï¼Œæœªæ¥10æ¬¡å¯»å®ï¼Œæ©™è‰²è—å“æ¦‚ç‡æé«˜è‡³5%ã€‚"
                }
            ];
            
            // ========== å¼€æœºé¡µé¢åŠŸèƒ½ ==========
            
            // åˆ›å»ºå¼€æœºé¡µé¢çš„æ°”æ³¡
            function createSplashBubbles() {
                for (let i = 0; i < 20; i++) {
                    const bubble = document.createElement('div');
                    bubble.className = 'splash-bubble';
                    
                    const size = Math.random() * 40 + 20;
                    const left = Math.random() * 100;
                    const delay = Math.random() * 8;
                    const duration = Math.random() * 6 + 6;
                    
                    bubble.style.width = `${size}px`;
                    bubble.style.height = `${size}px`;
                    bubble.style.left = `${left}%`;
                    bubble.style.animationDelay = `${delay}s`;
                    bubble.style.animationDuration = `${duration}s`;
                    
                    splashBubbles.appendChild(bubble);
                }
            }
            
            // å¼€å§‹æ¸¸æˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            startGameBtn.addEventListener('click', function() {
                // ç¬¬ä¸€æ­¥ï¼šå¼€æœºé¡µé¢æ¸å‡ºåˆ°ç™½è‰²
                splashScreen.classList.add('fade-out');
                
                // ç¬¬äºŒæ­¥ï¼šæ˜¾ç¤ºç™½è‰²é®ç½©å±‚
                setTimeout(() => {
                    whiteOverlay.classList.add('fade-in');
                    
                    // ç¬¬ä¸‰æ­¥ï¼šéšè—å¼€æœºé¡µé¢ï¼Œæ˜¾ç¤ºæ¸¸æˆå®¹å™¨å¹¶æ¸å…¥
                    setTimeout(() => {
                        splashScreen.style.display = 'none';
                        whiteOverlay.classList.remove('fade-in');
                        whiteOverlay.classList.add('fade-out');
                        
                        // ç¬¬å››æ­¥ï¼šæ¸¸æˆå®¹å™¨æ¸å…¥
                        setTimeout(() => {
                            gameContainer.classList.add('fade-in');
                            whiteOverlay.style.display = 'none';
                            
                            // åˆå§‹åŒ–æ¸¸æˆ
                            initGame();
                        }, 1500);
                    }, 1500);
                }, 1500);
            });
            
            // è‡ªåŠ¨ç‚¹å‡»æ§åˆ¶æŒ‰é’®äº‹ä»¶ç›‘å¬
            const autoClickToggleBtn = document.getElementById('auto-click-toggle');
            if (autoClickToggleBtn) {
                autoClickToggleBtn.addEventListener('click', toggleAutoClick);
            }
            
            // ========== æ¸¸æˆåŠŸèƒ½ ==========
            
            // æ£€æŸ¥æ˜¯å¦å·²æ”¶é›†å…¨éƒ¨æ™®é€šè—å“ï¼ˆç”¨äºè§¦å‘å…¨æ”¶é›†å‹‹ç« ï¼‰
            function checkAllTreasuresCollected() {
                // æ£€æŸ¥é™¤äº†å…¨æ”¶é›†å‹‹ç« å¤–çš„æ‰€æœ‰æ™®é€šè—å“æ˜¯å¦éƒ½å·²è·å¾—
                const regularTreasures = currentTreasures.filter(t => !t.unique);
                let allCollected = true;
                
                for (const treasure of regularTreasures) {
                    const hasTreasure = backpack.some(item => item.name === treasure.name);
                    if (!hasTreasure) {
                        allCollected = false;
                        break;
                    }
                }
                
                return allCollected;
            }

// ========== å•†åº—åŠŸèƒ½ç›¸å…³å‡½æ•° ========== - æ–°å¢

// æ›´æ–°å•†åº—æ˜¾ç¤º
function updateShopDisplay() {
    shopItemsContainer.innerHTML = '';
    
    shopItems.forEach(item => {
        const shopItemElement = document.createElement('div');
        shopItemElement.className = 'shop-item';
        
        // æ£€æŸ¥å†·å´æ—¶é—´ - ä¿®æ”¹ï¼šæ¯5ä¸ªè¿›å…¥å†·å´
        const now = Date.now();
        const timePassed = now - lastBoxPurchaseTime;
        let canBuy = true;
        let cooldownText = `å·²è´­ä¹°ï¼š${boxPurchaseCount}/${BOX_PURCHASE_LIMIT}`;
        
        // å¦‚æœæ˜¯è—å“å®ç®±ï¼Œæ£€æŸ¥å†·å´æ—¶é—´
        if (item.name === "è—å“å®ç®±") {
            if (boxPurchaseCount >= BOX_PURCHASE_LIMIT && timePassed < BOX_COOLDOWN) {
                canBuy = false;
                const timeLeft = BOX_COOLDOWN - timePassed;
                const hours = Math.floor(timeLeft / (60 * 60 * 1000));
                const minutes = Math.floor((timeLeft % (60 * 60 * 1000)) / (60 * 1000));
                cooldownText = `å†·å´ä¸­: ${hours}å°æ—¶${minutes}åˆ†é’Ÿåå¯å†æ¬¡è´­ä¹° (${boxPurchaseCount}/${BOX_PURCHASE_LIMIT})`;
            } else if (boxPurchaseCount >= BOX_PURCHASE_LIMIT && timePassed >= BOX_COOLDOWN) {
                // å†·å´æ—¶é—´å·²åˆ°ï¼Œé‡ç½®è´­ä¹°æ•°é‡
                boxPurchaseCount = 0;
                lastBoxPurchaseTime = 0;
                cooldownText = `å·²è´­ä¹°ï¼š${boxPurchaseCount}/${BOX_PURCHASE_LIMIT}`;
            }
        } else {
            // éå®ç®±å•†å“æ²¡æœ‰å†·å´æ—¶é—´
            cooldownText = "";
        }
        
        shopItemElement.innerHTML = `
            <div class="shop-item-image">
                <img src="${item.image}" alt="${item.name}">
            </div>
            <div class="shop-item-name">${item.name}</div>
            <div class="shop-item-description">${item.description}</div>
            <div class="shop-item-price">å”®ä»·ï¼š${item.price.toLocaleString()}é‡‘å¸</div>
            ${item.name === "è—å“å®ç®±" ? `<div class="shop-item-cooldown">${cooldownText}</div>` : ''}
            <button class="shop-item-button" id="buy-${item.id}" ${!canBuy || gold < item.price ? 'disabled' : ''}>
                ${item.name === "è—å“å®ç®±" ? `è´­ä¹° (${boxPurchaseCount}/${BOX_PURCHASE_LIMIT})` : 'è´­ä¹°'}
            </button>
        `;
        
        shopItemsContainer.appendChild(shopItemElement);
        
        // ç»‘å®šè´­ä¹°äº‹ä»¶
        const buyButton = document.getElementById(`buy-${item.id}`);
        if (buyButton) {
            buyButton.addEventListener('click', function() {
                buyShopItem(item);
            });
        }
    });
}    


// ========== é›‡ä½£åŠŸèƒ½ç›¸å…³å‡½æ•° ========== - æ–°å¢

// æ›´æ–°é›‡ä½£æ˜¾ç¤º
function updateHireDisplay() {
    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    const statusContent = document.getElementById('hire-status-content');
    if (hireJobs.length === 0) {
        statusContent.innerHTML = 'å½“å‰æ²¡æœ‰è¿›è¡Œä¸­çš„é›‡ä½£ä»»åŠ¡';
        document.getElementById('hire-collect').disabled = true;
        return;
    }

    const now = Date.now();
    let activeJobs = 0;
    let completedJobs = 0;
    
    let statusHTML = '<div style="margin-bottom: 10px;"><strong>é›‡ä½£çŠ¶æ€ï¼š</strong></div>';
    
    hireJobs.forEach((job, index) => {
        const timeLeft = job.endTime - now;
        if (timeLeft > 0) {
            activeJobs++;
            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            statusHTML += `<div style="margin: 5px 0; color: #66cc66;">å¯»å®è€… #${index + 1}ï¼šå‰©ä½™æ—¶é—´ ${hours}å°æ—¶${minutes}åˆ†é’Ÿ</div>`;
        } else {
            completedJobs++;
            statusHTML += `<div style="margin: 5px 0; color: #2ecc71;">å¯»å®è€… #${index + 1}ï¼šä»»åŠ¡å®Œæˆï¼<span id="collect-${index}" style="color: #3498db; cursor: pointer; margin-left: 10px;">[é¢†å–]</span></div>`;
        }
    });
    
    statusContent.innerHTML = statusHTML;
    
    // ç»‘å®šé¢†å–æŒ‰é’®äº‹ä»¶
    hireJobs.forEach((job, index) => {
        const collectBtn = document.getElementById(`collect-${index}`);
        if (collectBtn && (job.endTime <= now)) {
            collectBtn.onclick = function() {
                collectHireResult(index);
            };
        }
    });
    
    // æ›´æ–°æ”¶å–æŒ‰é’®çŠ¶æ€
    document.getElementById('hire-collect').disabled = (completedJobs === 0);
}

// é›‡ä½£å¯»å®è€…
function hireTreasureHunters() {
    const count = parseInt(document.getElementById('hire-count').value);
    const duration = parseInt(document.getElementById('hire-duration').value); // ç°åœ¨åº”è¯¥æ˜¯4
    
    // è®¡ç®—æ€»è´¹ç”¨
    const totalCost = count * 2000000; // 200ä¸‡é‡‘å¸æ¯åå¯»å®è€…
    
    if (gold < totalCost) {
        showMessage('é‡‘å¸ä¸è¶³ï¼');
        return;
    }
    
    // æ£€æŸ¥æ˜¯å¦è¶…è¿‡æœ€å¤§äººæ•°
    const activeJobs = hireJobs.filter(job => job.endTime > Date.now()).length;
    if (activeJobs + count > 2) {
        showMessage('æœ€å¤šåªèƒ½é›‡ä½£2åå¯»å®è€…ï¼');
        return;
    }
    
    // æ‰£é™¤é‡‘å¸
    gold -= totalCost;
    
    // åˆ›å»ºé›‡ä½£ä»»åŠ¡
    const now = Date.now();
    const endTime = now + (duration * 60 * 60 * 1000); // 4å°æ—¶å

    for (let i = 0; i < count; i++) {
        // æ¯ä¸ªå¯»å®è€…è·å¾—1-3ä¸ªè—å“å®ç®±
        const treasureCount = Math.floor(Math.random() * 3) + 1; // 1-3ä¸ª
        hireJobs.push({
            startTime: now,
            endTime: endTime,
            treasureCount: treasureCount
        });
    }
    
    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    localStorage.setItem('hireJobs', JSON.stringify(hireJobs));
    
    // æ›´æ–°UI
    updateExhibitionStats();
    updateHireDisplay();
    
    showMessage(`æˆåŠŸé›‡ä½£${count}åå¯»å®è€…ï¼Œ${duration}å°æ—¶åå¯æ”¶å–ç»“æœï¼`);
    
    // ä¿å­˜æ¸¸æˆ
    saveGame();
}

// æ”¶å–é›‡ä½£ç»“æœ
function collectHireResult(jobIndex) {
    const job = hireJobs[jobIndex];
    if (!job || job.endTime > Date.now()) {
        return; // ä»»åŠ¡æœªå®Œæˆ
    }
    
    // è·å¾—è—å“å®ç®±
    for (let i = 0; i < job.treasureCount; i++) {
        // æ·»åŠ è—å“å®ç®±åˆ°èƒŒåŒ…
        const treasureBox = {
            name: "è—å“å®ç®±",
            quality: "box",
            level: 1,
            icon: "ğŸ",
            description: "æ‰“å¼€åéšæœºè·å¾—ä¸€ä»¶è—å“ã€‚",
            image: "images/treasures/è—å“å®ç®±.png",
            isBox: true
        };
        
        const existingBox = backpack.find(item => item.name === treasureBox.name && item.isBox);
        if (existingBox) {
            existingBox.count += 1;
        } else {
            backpack.push({
                ...treasureBox,
                count: 1
            });
        }
    }
    
    // ä»é›‡ä½£åˆ—è¡¨ä¸­ç§»é™¤å·²å®Œæˆçš„ä»»åŠ¡
    hireJobs.splice(jobIndex, 1);
    
    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    localStorage.setItem('hireJobs', JSON.stringify(hireJobs));
    
    // æ›´æ–°UI
    updateBackpackDisplay();
    updateExhibitionStats();
    updateHireDisplay();
    
    showMessage(`æˆåŠŸæ”¶å–${job.treasureCount}ä¸ªè—å“å®ç®±ï¼`);
    
    // ä¿å­˜æ¸¸æˆ
    saveGame();
}

// åˆå§‹åŒ–é›‡ä½£ç³»ç»Ÿ
function initHireSystem() {
    // æ£€æŸ¥æ˜¯å¦æœ‰è¿‡æœŸä»»åŠ¡éœ€è¦å¤„ç†
    const now = Date.now();
    let hasExpiredJobs = false;
    
// ä¿ç•™æœªå®Œæˆçš„ä»»åŠ¡ï¼Œä»¥åŠå·²å®Œæˆä½†æœªè¶…è¿‡240å°æ—¶çš„ä»»åŠ¡
hireJobs = hireJobs.filter(job => {
    const timeSinceEnd = now - job.endTime;
    return job.endTime > now || (timeSinceEnd <= 240 * 60 * 60 * 1000); // 240å°æ—¶å†…å¯é¢†å–
});
    
    // ä¿å­˜æ¸…ç†åçš„ä»»åŠ¡åˆ—è¡¨
    localStorage.setItem('hireJobs', JSON.stringify(hireJobs));
    
    // è®¾ç½®å®šæ—¶å™¨æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
    if (hireInterval) {
        clearInterval(hireInterval);
    }
    
    hireInterval = setInterval(() => {
        updateHireDisplay();
    }, 60000); // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
}

// è´­ä¹°å•†åº—å•†å“
function buyShopItem(item) {
    if (gold < item.price) {
        showMessage('é‡‘å¸ä¸è¶³ï¼');
        return;
    }
    
    // å¦‚æœæ˜¯è—å“å®ç®±ï¼Œæ£€æŸ¥å†·å´æ—¶é—´
    if (item.name === "è—å“å®ç®±") {
        const now = Date.now();
        const timePassed = now - lastBoxPurchaseTime;
        
        // æ£€æŸ¥å†·å´æ—¶é—´ - ä¿®æ”¹ï¼šæ¯5ä¸ªè¿›å…¥å†·å´
        if (boxPurchaseCount >= BOX_PURCHASE_LIMIT && timePassed < BOX_COOLDOWN) {
            const timeLeft = BOX_COOLDOWN - timePassed;
            const hours = Math.floor(timeLeft / (60 * 60 * 1000));
            const minutes = Math.floor((timeLeft % (60 * 60 * 1000)) / (60 * 1000));
            showMessage(`å·²è´­ä¹°${BOX_PURCHASE_LIMIT}ä¸ªå®ç®±ï¼Œè¿›å…¥å†·å´æœŸï¼Œè¯·ç­‰å¾…${hours}å°æ—¶${minutes}åˆ†é’Ÿåå†è´­ä¹°ï¼`);
            return;
        }
        
        // æ›´æ–°è´­ä¹°æ•°é‡
        boxPurchaseCount++;
        
        // å¦‚æœè¾¾åˆ°è´­ä¹°é™åˆ¶ï¼Œå¼€å§‹å†·å´
        if (boxPurchaseCount >= BOX_PURCHASE_LIMIT) {
            lastBoxPurchaseTime = now;
        }
    }
    
    // æ‰£é™¤é‡‘å¸
    gold -= item.price;
    
    // å¦‚æœæ˜¯åŒå€å¡åˆ¸ï¼Œç›´æ¥æ·»åŠ åˆ°èƒŒåŒ…
    if (item.name === "åŒå€å¡åˆ¸") {
        // æ·»åŠ åŒå€å¡åˆ¸åˆ°èƒŒåŒ…
        const doubleCoupon = {
            name: item.name,
            quality: "box", // ä½¿ç”¨å®ç®±å“è´¨ï¼Œä¹Ÿå¯ä»¥åˆ›å»ºæ–°çš„å“è´¨
            level: 3,
            icon: item.icon,
            description: item.description,
            image: item.image,
            isBuffItem: true, // æ ‡è®°ä¸ºbuffç‰©å“
            buffType: item.buffType,
            buffDuration: item.buffDuration
        };
        
        // æ·»åŠ åˆ°èƒŒåŒ…
        const existingItem = backpack.find(b => b.name === item.name && b.isBuffItem);
        if (existingItem) {
            existingItem.count += 1;
        } else {
            backpack.push({
                ...doubleCoupon,
                count: 1
            });
        }
        
        showMessage(`è´­ä¹°æˆåŠŸï¼è·å¾—äº†${item.name}ï¼Œå·²æ”¾å…¥èƒŒåŒ…ã€‚`);
    } else if (item.name === "è—å“å®ç®±") {
        // åˆ›å»ºå®ç®±ç‰©å“å¹¶æ·»åŠ åˆ°èƒŒåŒ…
        const treasureBox = {
            name: item.name,
            quality: "box", // æ–°å¢ä¸€ä¸ªå“è´¨ï¼Œç”¨äºåŒºåˆ†å®ç®±
            level: 1,
            icon: item.icon,
            description: item.description,
            image: item.image,
            isBox: true // æ ‡è®°ä¸ºå®ç®±
        };
        
        // æ·»åŠ åˆ°èƒŒåŒ…
        const existingBox = backpack.find(b => b.name === item.name && b.isBox);
        if (existingBox) {
            existingBox.count += 1;
        } else {
            backpack.push({
                ...treasureBox,
                count: 1
            });
        }
        
        showMessage(`è´­ä¹°æˆåŠŸï¼è·å¾—äº†${item.name}ï¼Œå·²æ”¾å…¥èƒŒåŒ…ã€‚å½“å‰å·²è´­ä¹°ï¼š${boxPurchaseCount}/${BOX_PURCHASE_LIMIT}`);
    }
    
    // æ›´æ–°UI
    updateExhibitionStats();
    updateBackpackDisplay();
    updateShopDisplay();
    saveGame();
}

// æ‰“å¼€è—å“å®ç®±
function openTreasureBox(treasureBox) {
    // åˆ›å»ºæ‰“å¼€è—å“å®ç®±çš„å¯¹è¯æ¡†
    const dialog = document.createElement('div');
    dialog.className = 'modal';
    dialog.id = 'open-box-dialog';
    dialog.style.display = 'flex';
    dialog.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">æ‰“å¼€å®ç®±</div>
                <button class="close-modal" id="close-box-dialog">Ã—</button>
            </div>
            <div class="box-dialog-content">
                <div class="box-dialog-title">${treasureBox.name}</div>
                <img class="box-dialog-image" src="${treasureBox.image}" alt="${treasureBox.name}">
                <div class="box-dialog-description">${treasureBox.description}</div>
                <div class="box-dialog-buttons">
                    <button class="box-dialog-button open" id="open-box-btn">æ‰“å¼€</button>
                    <button class="box-dialog-button close" id="close-box-btn">å…³é—­</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(dialog);
    
    // ç»‘å®šå…³é—­æŒ‰é’®äº‹ä»¶
    document.getElementById('close-box-dialog').addEventListener('click', function() {
        document.body.removeChild(dialog);
    });
    document.getElementById('close-box-btn').addEventListener('click', function() {
        document.body.removeChild(dialog);
    });
    
    // ç»‘å®šæ‰“å¼€æŒ‰é’®äº‹ä»¶
    document.getElementById('open-box-btn').addEventListener('click', function() {
        // ä»èƒŒåŒ…ä¸­ç§»é™¤ä¸€ä¸ªå®ç®± - ä¿®å¤ï¼šæŸ¥æ‰¾æ‰€æœ‰åç§°åŒ¹é…çš„å®ç®±ï¼ˆä¸ç®¡æ˜¯å¦æœ‰isBoxæ ‡è®°ï¼‰
        const boxIndex = backpack.findIndex(item => item.name === treasureBox.name);
        if (boxIndex !== -1) {
            if (backpack[boxIndex].count > 1) {
                backpack[boxIndex].count -= 1;
            } else {
                backpack.splice(boxIndex, 1);
            }
        }
        
        // éšæœºè·å¾—ä¸€ä»¶è—å“ï¼ˆææ–™ã€ç ”å‘å¯†åŒ™ã€åˆæˆå¯†é’¥é™¤å¤–ï¼‰
        const treasure = getRandomTreasureFromBox();
        
        // æ·»åŠ åˆ°èƒŒåŒ…
        addToBackpack(treasure);
        
        // å…³é—­å¯¹è¯æ¡†
        document.body.removeChild(dialog);
        
        // æ›´æ–°èƒŒåŒ…æ˜¾ç¤º
        updateBackpackDisplay();
        saveGame();
    });
}

// ä»å®ç®±ä¸­éšæœºè·å–è—å“ï¼ˆæ’é™¤ææ–™ã€ç ”å‘å¯†åŒ™ã€åˆæˆå¯†é’¥ï¼‰
function getRandomTreasureFromBox() {
    // æ’é™¤ææ–™ï¼ˆç°è‰²ï¼‰ã€ç ”å‘å¯†åŒ™ï¼ˆé’è‰²ï¼‰ã€åˆæˆå¯†é’¥ï¼ˆé’è‰²ï¼‰
    const excludedNames = ["ç ”å‘å¯†åŒ™", "åˆæˆå¯†é’¥"];
    
    // æ”¶é›†æ‰€æœ‰åœºæ™¯çš„å®è—ï¼Œæ’é™¤ææ–™ï¼ˆç°è‰²ï¼‰å’Œæ’é™¤åˆ—è¡¨ä¸­çš„
    let allTreasures = [];
    scenes.forEach(scene => {
        scene.treasures.forEach(treasure => {
            if (treasure.quality !== "gray" && !excludedNames.includes(treasure.name)) {
                allTreasures.push(treasure);
            }
        });
    });
    
    // è®¾ç½®æ¦‚ç‡
    const random = Math.random() * 100;
    let selectedQuality;
    if (random < 1) {
        selectedQuality = "orange";
    } else if (random < 6) {
        selectedQuality = "purple";
    } else if (random < 31) {
        selectedQuality = "blue";
    } else if (random < 61) {
        selectedQuality = "green";
    } else {
        selectedQuality = "white";
    }
    
    // ä»ç¬¦åˆå“è´¨çš„å®è—ä¸­éšæœºé€‰æ‹©
    const qualityTreasures = allTreasures.filter(t => t.quality === selectedQuality);
    const randomIndex = Math.floor(Math.random() * qualityTreasures.length);
    return {...qualityTreasures[randomIndex]};
}

// ä½¿ç”¨åŒå€å¡åˆ¸å‡½æ•°
function useDoubleCoupon(coupon) {
// åˆ›å»ºä½¿ç”¨åŒå€å¡åˆ¸çš„å¯¹è¯æ¡†
const dialog = document.createElement('div');
dialog.className = 'modal';
dialog.id = 'use-coupon-dialog';
dialog.style.display = 'flex';
dialog.innerHTML = `
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">ä½¿ç”¨åŒå€å¡åˆ¸</div>
            <button class="close-modal" id="close-coupon-dialog">Ã—</button>
        </div>
        <div class="box-dialog-content">
            <div class="box-dialog-title">${coupon.name}</div>
            <div style="display: flex; justify-content: center; align-items: center; margin: 15px 0;">
                <img class="box-dialog-image" src="${coupon.image}" alt="${coupon.name}" style="display: block;">
            </div>
            <div class="box-dialog-description">${coupon.description}</div>
            <div class="box-dialog-buttons">
                <button class="box-dialog-button open" id="use-coupon-btn">ä½¿ç”¨</button>
                <button class="box-dialog-button close" id="close-coupon-btn">å…³é—­</button>
            </div>
        </div>
    </div>
`;
    document.body.appendChild(dialog);
    
    // ç»‘å®šå…³é—­æŒ‰é’®äº‹ä»¶
    document.getElementById('close-coupon-dialog').addEventListener('click', function() {
        document.body.removeChild(dialog);
    });
    document.getElementById('close-coupon-btn').addEventListener('click', function() {
        document.body.removeChild(dialog);
    });
    
    // ç»‘å®šä½¿ç”¨æŒ‰é’®äº‹ä»¶
    document.getElementById('use-coupon-btn').addEventListener('click', function() {
        // ä»èƒŒåŒ…ä¸­ç§»é™¤ä¸€ä¸ªåŒå€å¡åˆ¸
        const couponIndex = backpack.findIndex(item => item.name === coupon.name && item.isBuffItem);
        if (couponIndex !== -1) {
            if (backpack[couponIndex].count > 1) {
                backpack[couponIndex].count -= 1;
            } else {
                backpack.splice(couponIndex, 1);
            }
        }
        
        // åº”ç”¨åŒå€å¡åˆ¸æ•ˆæœ
        applyDoubleCouponEffect(coupon);
        
        // å…³é—­å¯¹è¯æ¡†
        document.body.removeChild(dialog);
        
        // æ›´æ–°èƒŒåŒ…æ˜¾ç¤º
        updateBackpackDisplay();
        saveGame();
        
        showMessage(`åŒå€å¡åˆ¸æ•ˆæœå·²æ¿€æ´»ï¼ç´«ã€æ©™è—å“çˆ†ç‡æå‡100%ï¼ŒæŒç»­30åˆ†é’Ÿã€‚`);
    });
}

// åº”ç”¨åŒå€å¡åˆ¸æ•ˆæœå‡½æ•°
function applyDoubleCouponEffect(coupon) {
    // æ£€æŸ¥æ˜¯å¦å·²æœ‰å…¶ä»–å¡åˆ¸æ•ˆæœ
    if (currentBuff && currentBuff.type === "double-coupon") {
        // å¦‚æœå·²æœ‰åŒå€å¡åˆ¸æ•ˆæœï¼Œå»¶é•¿å…¶æŒç»­æ—¶é—´
        currentBuff.endTime = Date.now() + coupon.buffDuration;
    } else {
        // è®¾ç½®æ–°çš„åŒå€å¡åˆ¸æ•ˆæœ
        currentBuff = {
            type: "double-coupon",
            effect: "purple-orange-rate", // æå‡ç´«æ©™çˆ†ç‡
            multiplier: 2, // 100%æå‡å³ç¿»å€
            endTime: Date.now() + coupon.buffDuration, // ç»“æŸæ—¶é—´
            originalPurpleRate: upgrades.treasureRate.level * upgrades.treasureRate.effect, // è®°å½•åŸå§‹åŠ æˆ
            originalOrangeRate: upgrades.treasureRate.level * upgrades.treasureRate.effect // è®°å½•åŸå§‹åŠ æˆ
        };
    }
    
    // æ›´æ–°BUFFæ˜¾ç¤º
    updateBuffDisplay();
}

// æ‰“å¼€é‡‘å¸å®ç®±
function openGoldTreasureBox(treasureBox) {
    // åˆ›å»ºæ‰“å¼€å®ç®±çš„å¯¹è¯æ¡†
const dialog = document.createElement('div');
dialog.className = 'modal';
dialog.id = 'open-gold-box-dialog';
dialog.style.display = 'flex';
dialog.innerHTML = `
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">æ‰“å¼€é‡‘å¸å®ç®±</div>
            <button class="close-modal" id="close-gold-box-dialog">Ã—</button>
        </div>
        <div class="box-dialog-content">
            <div class="box-dialog-title">${treasureBox.name}</div>
            <div style="display: flex; justify-content: center; align-items: center; margin: 15px 0;">
                <img class="box-dialog-image" src="${treasureBox.image}" alt="${treasureBox.name}" style="display: block;">
            </div>
            <div class="box-dialog-description">${treasureBox.description}</div>
            <div class="box-dialog-buttons">
                <button class="box-dialog-button open" id="open-gold-box-btn">æ‰“å¼€</button>
                <button class="box-dialog-button close" id="close-gold-box-btn">å…³é—­</button>
            </div>
        </div>
    </div>
`;
    document.body.appendChild(dialog);
    
    // ç»‘å®šå…³é—­æŒ‰é’®äº‹ä»¶
    document.getElementById('close-gold-box-dialog').addEventListener('click', function() {
        document.body.removeChild(dialog);
    });
    document.getElementById('close-gold-box-btn').addEventListener('click', function() {
        document.body.removeChild(dialog);
    });
    
    // ç»‘å®šæ‰“å¼€æŒ‰é’®äº‹ä»¶
    document.getElementById('open-gold-box-btn').addEventListener('click', function() {
        // ä»èƒŒåŒ…ä¸­ç§»é™¤ä¸€ä¸ªé‡‘å¸å®ç®±
        const boxIndex = backpack.findIndex(item => item.name === treasureBox.name);
        if (boxIndex !== -1) {
            if (backpack[boxIndex].count > 1) {
                backpack[boxIndex].count -= 1;
            } else {
                backpack.splice(boxIndex, 1);
            }
        }
        
// éšæœºè·å¾—100-200ä¸‡é‡‘å¸
const goldAmount = Math.floor(Math.random() * 101) * 10000 + 1000000; // 1000000-2000000
gold += goldAmount;
        
        // å…³é—­å¯¹è¯æ¡†
        document.body.removeChild(dialog);
        
        // æ›´æ–°èƒŒåŒ…æ˜¾ç¤ºå’Œé‡‘å¸æ˜¾ç¤º
        updateBackpackDisplay();
        updateExhibitionStats();
        saveGame();
        
        // æ˜¾ç¤ºè·å¾—é‡‘å¸çš„æ¶ˆæ¯
        showMessage(`æ­å–œï¼è·å¾—äº† ${goldAmount.toLocaleString()} é‡‘å¸ï¼`);
    });
}

// ä½¿ç”¨è‡ªåŠ¨ç‚¹å‡»å¡å‡½æ•°
function useAutoClickCard(card) {
    // åˆ›å»ºä½¿ç”¨è‡ªåŠ¨ç‚¹å‡»å¡çš„å¯¹è¯æ¡†
    const dialog = document.createElement('div');
    dialog.className = 'modal';
    dialog.id = 'use-auto-click-dialog';
    dialog.style.display = 'flex';
    dialog.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ä½¿ç”¨è‡ªåŠ¨ç‚¹å‡»å¡</div>
                <button class="close-modal" id="close-auto-click-dialog">Ã—</button>
            </div>
            <div class="box-dialog-content">
                <div class="box-dialog-title">${card.name}</div>
                <div style="display: flex; justify-content: center; align-items: center; margin: 15px 0;">
                    <img class="box-dialog-image" src="${card.image}" alt="${card.name}" style="display: block;">
                </div>
                <div class="box-dialog-description">${card.description}</div>
                <div class="box-dialog-buttons">
                    <button class="box-dialog-button open" id="use-auto-click-btn">ä½¿ç”¨</button>
                    <button class="box-dialog-button close" id="close-auto-click-btn">å…³é—­</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(dialog);
    
    // ç»‘å®šå…³é—­æŒ‰é’®äº‹ä»¶
    document.getElementById('close-auto-click-dialog').addEventListener('click', function() {
        document.body.removeChild(dialog);
    });
    document.getElementById('close-auto-click-btn').addEventListener('click', function() {
        document.body.removeChild(dialog);
    });
    
    // ç»‘å®šä½¿ç”¨æŒ‰é’®äº‹ä»¶
    document.getElementById('use-auto-click-btn').addEventListener('click', function() {
        // ä»èƒŒåŒ…ä¸­ç§»é™¤ä¸€ä¸ªè‡ªåŠ¨ç‚¹å‡»å¡
        const cardIndex = backpack.findIndex(item => item.name === card.name);
        if (cardIndex !== -1) {
            if (backpack[cardIndex].count > 1) {
                backpack[cardIndex].count -= 1;
            } else {
                backpack.splice(cardIndex, 1);
            }
        }
        
        // å¼€å§‹è‡ªåŠ¨ç‚¹å‡»
        startAutoClick(card.duration || 300); // é»˜è®¤5åˆ†é’Ÿ
        
        // å…³é—­å¯¹è¯æ¡†
        document.body.removeChild(dialog);
        
        // æ›´æ–°èƒŒåŒ…æ˜¾ç¤º
        updateBackpackDisplay();
        saveGame();
        
        showMessage(`è‡ªåŠ¨ç‚¹å‡»åŠŸèƒ½å·²æ¿€æ´»ï¼æŒç»­5åˆ†é’Ÿã€‚`);
    });
}

// å¼€å§‹è‡ªåŠ¨ç‚¹å‡»
function startAutoClick(duration) {
    // å¦‚æœå·²ç»åœ¨è‡ªåŠ¨ç‚¹å‡»ï¼Œå…ˆç»“æŸå½“å‰çš„
    if (isAutoClicking) {
        stopAutoClick();
    }
    
    isAutoClicking = true;
    isAutoClickPaused = false;
    autoClickDuration = duration;
    
    // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
    updateAutoClickCountdown();
    document.getElementById('auto-click-timer').style.display = 'flex';
    
    // è®¾ç½®è‡ªåŠ¨ç‚¹å‡»é—´éš”ä¸º2ç§’
    autoClickInterval = setInterval(() => {
        if (!isAutoClickPaused && isAutoClicking) {
            // æ¨¡æ‹Ÿæ°”æ³¡ç‚¹å‡»é€»è¾‘
            if (!isMoving && !isReturning && !isPopping) {
                startTreasureHunt();
            } else if (isMoving && exclamation.style.display === 'block') {
                completeTreasureHunt();
            }
        }
    }, 2000);
    
    // è®¾ç½®å€’è®¡æ—¶å®šæ—¶å™¨
    autoClickTimer = setInterval(() => {
        // åªæœ‰åœ¨æœªæš‚åœçŠ¶æ€ä¸‹æ‰å‡å°‘å€’è®¡æ—¶
        if (!isAutoClickPaused) {
            autoClickDuration--;
            updateAutoClickCountdown();
            
            if (autoClickDuration <= 0) {
                stopAutoClick();
            }
        }
    }, 1000);
}

// åœæ­¢è‡ªåŠ¨ç‚¹å‡»
function stopAutoClick() {
    isAutoClicking = false;
    isAutoClickPaused = false;
    autoClickDuration = 0;
    
    // æ¸…é™¤å®šæ—¶å™¨
    if (autoClickInterval) {
        clearInterval(autoClickInterval);
        autoClickInterval = null;
    }
    if (autoClickTimer) {
        clearInterval(autoClickTimer);
        autoClickTimer = null;
    }
    
    // éšè—å€’è®¡æ—¶æ˜¾ç¤º
    document.getElementById('auto-click-timer').style.display = 'none';
}

// æ›´æ–°è‡ªåŠ¨ç‚¹å‡»å€’è®¡æ—¶æ˜¾ç¤º
function updateAutoClickCountdown() {
    const minutes = Math.floor(autoClickDuration / 60);
    const seconds = autoClickDuration % 60;
    const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    document.getElementById('auto-click-countdown').textContent = `è‡ªåŠ¨ç‚¹å‡»ï¼š${formattedTime}`;
}

// åˆ‡æ¢è‡ªåŠ¨ç‚¹å‡»æš‚åœ/ç»§ç»­
function toggleAutoClick() {
    if (!isAutoClicking) return;
    
    isAutoClickPaused = !isAutoClickPaused;
    const toggleBtn = document.getElementById('auto-click-toggle');
    toggleBtn.textContent = isAutoClickPaused ? 'ç»§ç»­' : 'æš‚åœ';
}

            // è‡ªåŠ¨å­˜æ¡£åŠŸèƒ½
function saveGame() {
    const gameData = {
        backpack: backpack,
        treasureCount: treasureCount,
        gold: gold,
        researchKeys: researchKeys,
        upgrades: upgrades,
        lastIncomeTime: lastIncomeTime,
        currentScene: currentScene,
        hasCollectedAllTreasures: hasCollectedAllTreasures,
        currentBuff: currentBuff,
        orangeGuaranteeCounter: orangeGuaranteeCounter,
        lastOrangeCount: lastOrangeCount,
        lastKeyGiveawayTime: lastKeyGiveawayTime,
        obtainedUniqueTreasures: obtainedUniqueTreasures,
hireJobs: hireJobs,
        lastBoxPurchaseTime: lastBoxPurchaseTime, // æ–°å¢ï¼šä¿å­˜å®ç®±è´­ä¹°æ—¶é—´
        boxPurchaseCount: boxPurchaseCount // æ–°å¢ï¼šä¿å­˜å·²è´­ä¹°æ•°é‡
    };
    localStorage.setItem('treasureHuntGame', JSON.stringify(gameData));
}
            
            // åŠ è½½æ¸¸æˆ
function loadGame() {
    const savedGame = localStorage.getItem('treasureHuntGame');
    if (savedGame) {
        const gameData = JSON.parse(savedGame);
        backpack = gameData.backpack || [];
// ========== æ–°å¢ï¼šæ›´æ–°èƒŒåŒ…ä¸­è—å“çš„ç­‰çº§ ==========
        // éå†æ‰€æœ‰åœºæ™¯ï¼Œæ„å»ºä¸€ä¸ªåç§°åˆ°æœ€æ–°å®ç‰©æ•°æ®çš„æ˜ å°„
        const allTreasuresMap = {};
        scenes.forEach(scene => {
            scene.treasures.forEach(treasure => {
                allTreasuresMap[treasure.name] = treasure;
            });
        });
        
        // æ›´æ–°èƒŒåŒ…ä¸­æ¯ä¸ªè—å“çš„ç­‰çº§å’Œå±æ€§
        backpack.forEach(item => {
            const latestTreasure = allTreasuresMap[item.name];
            if (latestTreasure) {
                // æ›´æ–°ç­‰çº§å’Œå…¶ä»–å¯èƒ½éœ€è¦åŒæ­¥çš„å±æ€§
                item.level = latestTreasure.level;
                // å¦‚æœéœ€è¦ï¼Œä¹Ÿå¯ä»¥æ›´æ–°å…¶ä»–å±æ€§
                item.description = latestTreasure.description;
                item.image = latestTreasure.image;
                item.icon = latestTreasure.icon;
                item.quality = latestTreasure.quality;
            }
        });
        // ========== æ–°å¢ä»£ç ç»“æŸ ==========
        treasureCount = gameData.treasureCount || 0;
        gold = gameData.gold || 0;
        researchKeys = gameData.researchKeys || 0;
        upgrades = gameData.upgrades || {
            treasureRate: { level: 0, maxLevel: 10, cost: 10000, keyCost: 1, effect: 0.10 },
            incomeRate: { level: 0, maxLevel: 10, cost: 10000, keyCost: 1, effect: 0.05 },
            doubleTreasure: { level: 0, maxLevel: 10, cost: 10000, keyCost: 2, effect: 0.005 }
        };

        // å¦‚æœä»å­˜æ¡£åŠ è½½ï¼Œç¡®ä¿effectå€¼æ­£ç¡®
        if (gameData.upgrades) {
            upgrades.treasureRate.effect = 0.10; // å¼ºåˆ¶è®¾ç½®ä¸º0.10
        }

        // å¼ºåˆ¶æ›´æ–°costä¸º10000ï¼Œç¡®ä¿å³ä½¿ä»æ—§å­˜æ¡£åŠ è½½ä¹Ÿä½¿ç”¨æ–°ä»·æ ¼
        for (const key in upgrades) {
            upgrades[key].cost = 10000;
        }

        lastIncomeTime = gameData.lastIncomeTime || Date.now();
        currentScene = gameData.currentScene || 1;
        hasCollectedAllTreasures = gameData.hasCollectedAllTreasures || false;
        currentBuff = gameData.currentBuff || null; // æ–°å¢ï¼šåŠ è½½å½“å‰BUFFçŠ¶æ€
        
        // æ–°å¢ï¼šåŠ è½½æ©™è‰²ä¿åº•è®¡æ•°å™¨ - ç¡®ä¿ä»å­˜æ¡£æ­£ç¡®åŠ è½½
        orangeGuaranteeCounter = gameData.orangeGuaranteeCounter || 0;
        lastOrangeCount = gameData.lastOrangeCount || 0;
        
        // æ–°å¢ï¼šå¦‚æœå­˜æ¡£ä¸­æ²¡æœ‰lastOrangeCountï¼Œä½†å·²æœ‰å¯»å®æ¬¡æ•°ï¼Œåˆ™è®¾ä¸ºå¯»å®æ¬¡æ•°ï¼ˆé¿å…å¼‚å¸¸ï¼‰
        if (lastOrangeCount === 0 && treasureCount > 0) {
            lastOrangeCount = treasureCount;
        }
        
// æ–°å¢ï¼šåŠ è½½ä¸Šæ¬¡èµ é€é’¥åŒ™æ—¶é—´
lastKeyGiveawayTime = gameData.lastKeyGiveawayTime || Date.now();

// æ–°å¢ï¼šåŠ è½½ä¸Šæ¬¡è´­ä¹°å®ç®±æ—¶é—´
lastBoxPurchaseTime = gameData.lastBoxPurchaseTime || 0;

// æ–°å¢ï¼šåŠ è½½å·²è´­ä¹°å®ç®±æ•°é‡
boxPurchaseCount = gameData.boxPurchaseCount || 0;

// æ–°å¢ï¼šåŠ è½½æ›¾ç»è·å¾—è¿‡çš„å”¯ä¸€è—å“è®°å½•
obtainedUniqueTreasures = gameData.obtainedUniqueTreasures || [];

// æ–°å¢ï¼šåŠ è½½é›‡ä½£æ•°æ®
hireJobs = gameData.hireJobs || [];
                    
                    // æ›´æ–°å½“å‰åœºæ™¯çš„å®ç‰©æ•°æ®
                    updateCurrentSceneTreasures();
                    
                    // æ›´æ–°UI
                    updateBackpackDisplay();
                    updateHandbookDisplay();
                    updateExhibitionStats();
                    updateSceneDisplay();
                    
                    // æ›´æ–°BUFFæ˜¾ç¤º
                    updateBuffDisplay();
                    
                    // è®¡ç®—ç¦»çº¿æ”¶å…¥å¹¶æ˜¾ç¤ºç»“ç®—æ¡†
                    const offlineIncome = calculateOfflineIncome();
                    if (offlineIncome.income > 0) {
                        showOfflineIncome(offlineIncome);
                    }
                }
            }
            
            // æ›´æ–°å½“å‰åœºæ™¯çš„å®ç‰©æ•°æ®
            function updateCurrentSceneTreasures() {
                currentTreasures = scenes[currentScene - 1].treasures;
            }
            
            // è®¡ç®—ç¦»çº¿æ”¶å…¥
            function calculateOfflineIncome() {
    const now = Date.now();
    let timeDiff = now - lastIncomeTime;
    const fiveMinutes = 5 * 60 * 1000; // 5åˆ†é’Ÿ
    const maxOfflineTime = 12 * 60 * 60 * 1000; // 12å°æ—¶ï¼Œæœ€å¤§å€¼é™åˆ¶
    
    // é™åˆ¶ç¦»çº¿æ—¶é—´ä¸è¶…è¿‡12å°æ—¶
    if (timeDiff > maxOfflineTime) {
        timeDiff = maxOfflineTime;
    }
    
    if (timeDiff >= fiveMinutes) {
        const incomeCycles = Math.floor(timeDiff / fiveMinutes);
        const income = calculateIncome() * incomeCycles;
        const minutes = Math.floor(timeDiff / (60 * 1000));
        
        if (income > 0) {
            gold += income;
            // æ›´æ–°æœ€åæ”¶å…¥æ—¶é—´ï¼šå½“å‰æ—¶é—´å‡å»ï¼ˆæ—¶é—´å·®å¯¹5åˆ†é’Ÿå–ä½™ï¼‰ï¼Œä½†ä¸è¶…è¿‡æœ€å¤§ç¦»çº¿æ—¶é—´
            lastIncomeTime = now - (timeDiff % fiveMinutes);
            saveGame();
            return { income, minutes };
        }
    }
    return { income: 0, minutes: 0 };
}
            
            // æ˜¾ç¤ºç¦»çº¿æ”¶å…¥ç»“ç®—æ¡†
            function showOfflineIncome(offlineIncome) {
                offlineIncomeAmount.textContent = `${offlineIncome.income} é‡‘å¸`;
                offlineTimeElement.textContent = `ç¦»çº¿æ—¶é—´ï¼š${offlineIncome.minutes}åˆ†é’Ÿ`;
                offlineIncomeModal.style.display = 'flex';
            }
            
            // åˆ›å»ºèƒŒæ™¯æ°”æ³¡
            function createBackgroundBubbles() {
                // æ¸…é™¤ç°æœ‰æ°”æ³¡
                backgroundBubbles.innerHTML = '';
                
                for (let i = 0; i < 15; i++) {
                    const bubble = document.createElement('div');
                    bubble.className = 'background-bubble';
                    
                    const size = Math.random() * 30 + 10;
                    const left = Math.random() * 100;
                    const delay = Math.random() * 15;
                    const duration = Math.random() * 10 + 10;
                    
                    bubble.style.width = `${size}px`;
                    bubble.style.height = `${size}px`;
                    bubble.style.left = `${left}%`;
                    bubble.style.animationDelay = `${delay}s`;
                    bubble.style.animationDuration = `${duration}s`;
                    
                    backgroundBubbles.appendChild(bubble);
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ‰è½å…¨æ”¶é›†å‹‹ç« 
function canDropAllCollectionMedal() {
    // ç¡®å®šå½“å‰åœºæ™¯çš„å…¨æ”¶é›†å‹‹ç« åç§°å’Œå¯¹åº”åœºæ™¯çš„å®è—
    let medalName = "";
    let sceneTreasures = [];
    
    if (currentScene === 1) {
        medalName = "åœºæ™¯1å…¨æ”¶é›†å‹‹ç« ï¼ˆé™é‡1æšï¼‰";
        sceneTreasures = scenes[0].treasures;
    } else if (currentScene === 2) {
        medalName = "åœºæ™¯2å…¨æ”¶é›†å‹‹ç« ï¼ˆé™é‡1æšï¼‰";
        sceneTreasures = scenes[1].treasures;
    } else if (currentScene === 3) {
        medalName = "åœºæ™¯3å…¨æ”¶é›†å‹‹ç« ï¼ˆé™é‡1æšï¼‰";
        sceneTreasures = scenes[2].treasures;
    } else if (currentScene === 4) {
        medalName = "åœºæ™¯4å…¨æ”¶é›†å‹‹ç« ï¼ˆé™é‡1æšï¼‰";
        sceneTreasures = scenes[3].treasures;
    } else {
        return false;
    }
    
    // é˜²æ­¢é‡å¤æ‰è½å·²æ‹¥æœ‰çš„å…¨æ”¶é›†å‹‹ç« 
    if (backpack.some(item => item.name === medalName)) {
        return false;
    }
    
    // æ£€æŸ¥å½“å‰åœºæ™¯æ˜¯å¦å·²æ”¶é›†å…¨éƒ¨æ™®é€šè—å“ï¼ˆæ’é™¤å”¯ä¸€è—å“ï¼‰
    const regularTreasures = sceneTreasures.filter(t => !t.unique);
    let allCollected = true;
    
    for (const treasure of regularTreasures) {
        const hasTreasure = backpack.some(item => item.name === treasure.name);
        if (!hasTreasure) {
            allCollected = false;
            break;
        }
    }
    
    return allCollected;
}
            
// æ›´æ–°BUFFæ˜¾ç¤º - æ–°å¢
function updateBuffDisplay() {
    if (currentBuff) {
        // æ£€æŸ¥åŒå€å¡åˆ¸æ˜¯å¦ä»åœ¨æœ‰æ•ˆæœŸå†…
        if (currentBuff.type === "double-coupon" && Date.now() >= currentBuff.endTime) {
            // åŒå€å¡åˆ¸æ•ˆæœå·²è¿‡æœŸï¼Œç§»é™¤æ•ˆæœ
            currentBuff = null;
            showMessage("åŒå€å¡åˆ¸æ•ˆæœå·²ç»“æŸï¼");
        } else if (currentBuff.type === "double-coupon") {
            // åŒå€å¡åˆ¸ä»åœ¨æœ‰æ•ˆæœŸå†…
            const timeLeft = currentBuff.endTime - Date.now();
            const minutes = Math.floor(timeLeft / (60 * 1000));
            const seconds = Math.floor((timeLeft % (60 * 1000)) / 1000);
            buffEffectElement.textContent = `âœ¨ ç´«ã€æ©™è—å“çˆ†ç‡æå‡100% (å‰©ä½™${minutes}åˆ†${seconds}ç§’)`;
            buffEffectElement.style.display = 'block';
        } else {
            // æ˜¾ç¤ºå…¶ä»–ç±»å‹çš„BUFF
            const buffTypeNames = {
                blue: "è“è‰²è—å“",
                purple: "ç´«è‰²è—å“", 
                orange: "æ©™è‰²è—å“"
            };
            buffEffectElement.textContent = `âœ¨ ${buffTypeNames[currentBuff.type]}çˆ†ç‡æå‡è‡³${(currentBuff.rate * 100).toFixed(1)}% (å‰©ä½™${currentBuff.remainingHunts}æ¬¡)`;
            buffEffectElement.style.display = 'block';
        }
    } else {
        buffEffectElement.style.display = 'none';
    }
}
            
            // åº”ç”¨BUFFæ•ˆæœå¹¶å‡å°‘å‰©ä½™æ¬¡æ•° - æ–°å¢
function applyBuffAndDecrease() {
    if (currentBuff) {
        currentBuff.remainingHunts--;
        
        if (currentBuff.remainingHunts <= 0) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯æ©™è‰²BUFFä¸”æœªè·å¾—æ©™è‰²ç‰©å“
            if (currentBuff.type === 'orange' && currentBuff.orangeCount === 0) {
                // è¡¥å¿ä¸€æŠŠç ”å‘å¯†åŒ™
                giveResearchKey();
                showMessage(`é­”æ³•å¸ˆçš„æ©™è‰²BUFFç»“æŸï¼ŒæœŸé—´æœªè·å¾—æ©™è‰²è—å“ï¼Œè¡¥å¿ä¸€æŠŠç ”å‘å¯†åŒ™ï¼`);
            } else {
                showMessage(`é­”æ³•å¸ˆçš„BUFFæ•ˆæœå·²ç»“æŸï¼`);
            }
            currentBuff = null;
        }
        
        updateBuffDisplay();
        saveGame();
    }
}
            
            // éšæœºè·å–å®ç‰© - ä¿®æ”¹ï¼šè€ƒè™‘BUFFæ•ˆæœå’Œä¿åº•æœºåˆ¶
function getRandomTreasure() {
    // é¦–å…ˆæ£€æŸ¥æ˜¯å¦å¯ä»¥æ‰è½å…¨æ”¶é›†å‹‹ç« 
if (canDropAllCollectionMedal()) {
    let medalTreasure = null;
    if (currentScene === 1) {
        medalTreasure = currentTreasures.find(t => t.name === "åœºæ™¯1å…¨æ”¶é›†å‹‹ç« ï¼ˆé™é‡1æšï¼‰");
    } else if (currentScene === 2) {
        medalTreasure = currentTreasures.find(t => t.name === "åœºæ™¯2å…¨æ”¶é›†å‹‹ç« ï¼ˆé™é‡1æšï¼‰");
    } else if (currentScene === 3) {
        medalTreasure = currentTreasures.find(t => t.name === "åœºæ™¯3å…¨æ”¶é›†å‹‹ç« ï¼ˆé™é‡1æšï¼‰");
    } else if (currentScene === 4) {  // æ–°å¢åœºæ™¯4çš„å¤„ç†
        medalTreasure = currentTreasures.find(t => t.name === "åœºæ™¯4å…¨æ”¶é›†å‹‹ç« ï¼ˆé™é‡1æšï¼‰");
    }
    
    if (medalTreasure) {
        hasCollectedAllTreasures = true;
        return {...medalTreasure};  // ç«‹å³è¿”å›ï¼Œä¸å†æ‰§è¡Œåç»­é€»è¾‘
    }
}
    
    // ========== æ©™è‰²ä¿åº•æ£€æŸ¥ ==========
    // è®¡ç®—å½“å‰å¯»å®æ¬¡æ•°ä¸ä¸Šæ¬¡è·å¾—æ©™è‰²æ¬¡æ•°çš„å·®å€¼
    const huntsSinceLastOrange = treasureCount - lastOrangeCount;
    
    // å¦‚æœå·²ç»è¿ç»­9999æ¬¡æ²¡æœ‰è·å¾—æ©™è‰²ï¼Œç¬¬10000æ¬¡å¼ºåˆ¶è·å¾—æ©™è‰²
    if (orangeGuaranteeCounter >= 9999) {
        // å¼ºåˆ¶è·å¾—å½“å‰åœºæ™¯çš„æ©™è‰²ç‰©å“
        const orangeTreasures = currentTreasures.filter(t => t.quality === "orange");
        if (orangeTreasures.length > 0) {
            const randomIndex = Math.floor(Math.random() * orangeTreasures.length);
            const guaranteedTreasure = {...orangeTreasures[randomIndex]};
            
            // é‡ç½®ä¿åº•è®¡æ•°å™¨
            orangeGuaranteeCounter = 0;
            lastOrangeCount = treasureCount;
            
            // æ˜¾ç¤ºä¿åº•æç¤º
            showMessage("ğŸ‰ ä¿åº•è§¦å‘ï¼è·å¾—äº†æ©™è‰²ç‰©å“ï¼");
            
            return guaranteedTreasure;
        }
    }
    
    // åŸºç¡€çˆ†ç‡æƒé‡
const baseWeights = {
    orange: 1,     // 0.01%
    purple: 10,    // 0.1%
    magenta: 100,   // 1%
    cyan: 20,      // 0.2%
    blue: 100,     // 1%
    green: 500,    // 5%
    white: 9249,   // è°ƒæ•´ä¸º9249ï¼Œç¡®ä¿æ€»æƒé‡ä¸º10000
    gray: 10,
    box: 10
};
                
                // è·å–ç´«è‰²åŠä»¥ä¸Šæ‰ç‡æå‡æ•ˆæœï¼ˆç ”å‘åŠ æˆï¼‰
                const purpleAndAboveBonus = upgrades.treasureRate.level * upgrades.treasureRate.effect;
                
                // è·å–åŒå€å¡åˆ¸å¯¹ç´«æ©™è—å“çš„é¢å¤–åŠ æˆ
                let doubleCouponBonus = 0;
                if (currentBuff && currentBuff.type === "double-coupon" && Date.now() < currentBuff.endTime) {
                    doubleCouponBonus = currentBuff.originalPurpleRate; // åŒå€å¡åˆ¸æä¾›100%çš„åŠ æˆï¼Œå³ç­‰äºåŸå§‹åŠ æˆ
                }
                
                // åˆå§‹è°ƒæ•´æƒé‡
                let adjustedWeights = {
                    orange: Math.floor(baseWeights.orange * (1 + purpleAndAboveBonus + doubleCouponBonus)),
                    purple: Math.floor(baseWeights.purple * (1 + purpleAndAboveBonus + doubleCouponBonus)),
                    magenta: baseWeights.magenta, // ç«çº¢è‰²å®ç‰©
                    cyan: baseWeights.cyan, // é’è‰²å®ç‰©ä¸å—å½±å“
                    blue: baseWeights.blue,
                    green: baseWeights.green,
                    white: baseWeights.white,
                    gray: baseWeights.gray,
                    box: baseWeights.box
                };
                
                // åº”ç”¨é­”æ³•å¸ˆBUFFæ•ˆæœ - ç®€åŒ–ç‰ˆ
if (currentBuff && currentBuff.type !== "double-coupon") { // åŒå€å¡åˆ¸æ•ˆæœä¸ä¸é­”æ³•å¸ˆæ•ˆæœå åŠ 
    const targetQuality = currentBuff.type;
    const targetRate = currentBuff.rate;
    
    console.log(`åº”ç”¨BUFF: ${targetQuality}å“è´¨ï¼Œç›®æ ‡æ¦‚ç‡: ${targetRate * 100}%`);
    
    // è·å–æ‰€æœ‰éç›®æ ‡å“è´¨çš„æ€»æƒé‡
    let otherWeights = 0;
    for (const quality in adjustedWeights) {
        if (quality !== targetQuality) {
            otherWeights += adjustedWeights[quality];
        }
    }
    
    // æ ¹æ®ç›®æ ‡æ¦‚ç‡è®¡ç®—ç›®æ ‡å“è´¨åº”æœ‰çš„æƒé‡
    // å…¬å¼ï¼šç›®æ ‡æƒé‡ / (ç›®æ ‡æƒé‡ + å…¶ä»–æƒé‡) = ç›®æ ‡æ¦‚ç‡
    // æ‰€ä»¥ï¼šç›®æ ‡æƒé‡ = å…¶ä»–æƒé‡ * ç›®æ ‡æ¦‚ç‡ / (1 - ç›®æ ‡æ¦‚ç‡)
    const targetWeight = Math.floor(otherWeights * targetRate / (1 - targetRate));
    adjustedWeights[targetQuality] = targetWeight;
    
    console.log(`BUFFè°ƒæ•´ - ${targetQuality}æƒé‡è®¾ä¸º: ${targetWeight}`);
}

// è®¡ç®—æ€»æƒé‡
let totalWeight = 0;
for (const quality in adjustedWeights) {
    totalWeight += adjustedWeights[quality];
}
                
                const random = Math.random() * totalWeight;

let currentWeight = 0;
let selectedQuality = "white";

// æŒ‰ç…§å›ºå®šé¡ºåºéå†å“è´¨ï¼Œç¡®ä¿ä¸€è‡´æ€§
const qualityOrder = ['orange', 'magenta', 'purple', 'cyan', 'blue', 'green', 'white', 'gray', 'box'];
for (const quality of qualityOrder) {
    currentWeight += adjustedWeights[quality];
    if (random <= currentWeight) {
        selectedQuality = quality;
        break;
    }
}
                
                // è¿‡æ»¤æ‰å·²è·å¾—ä¸”æ˜¯å”¯ä¸€çš„è—å“
let qualityTreasures = currentTreasures.filter(t => t.quality === selectedQuality);

// å¦‚æœè¿‡æ»¤åæ²¡æœ‰å¯æ‰è½çš„è—å“ï¼Œåˆ™æ‰è½ç™½è‰²å“è´¨
if (qualityTreasures.length === 0) {
    selectedQuality = "white";
    qualityTreasures = currentTreasures.filter(t => t.quality === "white" && !t.unique);
}

// æ£€æŸ¥æ˜¯å¦æœ‰ç‰©å“è®¾ç½®äº†æƒé‡
const hasWeightedItems = qualityTreasures.some(item => item.weight !== undefined);

if (hasWeightedItems) {
    // ä½¿ç”¨åŠ æƒéšæœºé€‰æ‹©
    let totalWeight = 0;
    // è®¡ç®—æ€»æƒé‡
    qualityTreasures.forEach(item => {
        totalWeight += (item.weight || 1); // å¦‚æœæ²¡æœ‰è®¾ç½®æƒé‡ï¼Œé»˜è®¤ä¸º1
    });

    // éšæœºé€‰æ‹©
    let random = Math.random() * totalWeight;
    let currentWeight = 0;

    for (const item of qualityTreasures) {
        currentWeight += (item.weight || 1);
        if (random <= currentWeight) {
            return {...item};
        }
    }
    
    // å¦‚æœç”±äºæµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜æ²¡æœ‰é€‰ä¸­ï¼Œè¿”å›æœ€åä¸€ä¸ª
    return {...qualityTreasures[qualityTreasures.length - 1]};
} else {
    // æ²¡æœ‰æƒé‡è®¾ç½®ï¼Œä½¿ç”¨åŸå§‹éšæœºé€‰æ‹©
    const randomIndex = Math.floor(Math.random() * qualityTreasures.length);
    return {...qualityTreasures[randomIndex]};
}

const randomIndex = Math.floor(Math.random() * qualityTreasures.length);

return {...qualityTreasures[randomIndex]};
}
            
            // æ·»åŠ å®ç‰©åˆ°èƒŒåŒ…
function addToBackpack(treasure) {
    const doubleChance = upgrades.doubleTreasure.level * upgrades.doubleTreasure.effect;
    const getDouble = Math.random() < doubleChance;
    
    // å¦‚æœè·å¾—äº†æ©™è‰²ç‰©å“ï¼Œæ›´æ–°æœ€åä¸€æ¬¡è·å¾—æ©™è‰²çš„æ—¶é—´
    if (treasure.quality === "orange") {
        lastOrangeCount = treasureCount;
    }
                
    const existingItemIndex = backpack.findIndex(item => 
        item.name === treasure.name && item.quality === treasure.quality
    );
                
    if (existingItemIndex !== -1) {
        backpack[existingItemIndex].count += getDouble ? 2 : 1;
    } else {
        backpack.push({
            ...treasure,
            count: getDouble ? 2 : 1
        });
        
// æ–°å¢ï¼šå¦‚æœæ˜¯å”¯ä¸€è—å“ï¼ˆè§‚å½±åˆ¸é™¤å¤–ï¼‰ï¼Œè®°å½•åˆ°æ›¾ç»è·å¾—è¿‡çš„åˆ—è¡¨ä¸­
if (treasure.unique && !treasure.name.includes("æ®‹ç¼ºçš„è§‚å½±åˆ¸")) {
    obtainedUniqueTreasures.push(treasure.name);
}
    }
                
    updateBackpackDisplay();
    updateHandbookDisplay();
                
    // æ˜¾ç¤ºå®ç‰©è¯¦æƒ…ï¼ˆå¯»å®æ—¶è·å¾—ç‰©å“ä¾ç„¶å¼¹å‡ºï¼‰
    showTreasureDetail(treasure, getDouble);
                
    // æ£€æŸ¥æ˜¯å¦è·å¾—ç ”å‘å¯†åŒ™ï¼ˆé’è‰²è—å“"ç ”å‘å¯†åŒ™"ï¼‰
    if (treasure.name === "ç ”å‘å¯†åŒ™") {
        researchKeys += getDouble ? 2 : 1;
        updateExhibitionStats();
    }
                
// æ£€æŸ¥æ˜¯å¦è·å¾—å…¨æ”¶é›†å‹‹ç« 
if (treasure.name === "åœºæ™¯1å…¨æ”¶é›†å‹‹ç« ï¼ˆé™é‡1æšï¼‰" || treasure.name === "åœºæ™¯2å…¨æ”¶é›†å‹‹ç« ï¼ˆé™é‡1æšï¼‰" || treasure.name === "åœºæ™¯3å…¨æ”¶é›†å‹‹ç« ï¼ˆé™é‡1æšï¼‰" || treasure.name === "åœºæ™¯4å…¨æ”¶é›†å‹‹ç« ï¼ˆé™é‡1æšï¼‰") {  // æ·»åŠ åœºæ™¯4å‹‹ç« 
    hasCollectedAllTreasures = true;
    const sceneNum = treasure.name.includes("åœºæ™¯1") ? "1" : (treasure.name.includes("åœºæ™¯2") ? "2" : (treasure.name.includes("åœºæ™¯3") ? "3" : "4"));  // ä¿®æ”¹è¿™ä¸€è¡Œä»¥æ”¯æŒåœºæ™¯4
    showMessage(`æ­å–œï¼æ‚¨è·å¾—äº†åœºæ™¯${sceneNum}å…¨æ”¶é›†å‹‹ç« ï¼`);
}
                
    saveGame();
}
            
            // æ›´æ–°èƒŒåŒ…æ˜¾ç¤º
function updateBackpackDisplay() {
    backpackItems.innerHTML = '';
    
    const sortedBackpack = [...backpack].sort((a, b) => {
        // è‡ªåŠ¨ç‚¹å‡»å¡ç½®é¡¶
        if (a.name === "è‡ªåŠ¨ç‚¹å‡»å¡") return -1;
        if (b.name === "è‡ªåŠ¨ç‚¹å‡»å¡") return 1;
        
        // é¦–å…ˆæŒ‰å“è´¨æƒé‡æ’åºï¼ˆåŒ…å«å®ç®±ï¼‰
        if (qualityWeights[a.quality] !== qualityWeights[b.quality]) {
            return qualityWeights[b.quality] - qualityWeights[a.quality];
        }
        
        // ç›¸åŒå“è´¨ä¸‹æŒ‰ç­‰çº§æ’åº
        if (a.level !== b.level) {
            return b.level - a.level;
        }
        
        // ç›¸åŒå“è´¨å’Œç­‰çº§ä¸‹æŒ‰æ•°é‡æ’åº
        if (a.count !== b.count) {
            return b.count - a.count;
        }
        
        // æœ€åæŒ‰åç§°æ’åº
        return a.name.localeCompare(b.name);
    });
    
    const filteredBackpack = currentQualityFilter === 'all' 
        ? sortedBackpack 
        : sortedBackpack.filter(item => item.quality === currentQualityFilter);
    
    filteredBackpack.forEach((treasure, index) => {
        const item = document.createElement('div');
        item.className = 'treasure-item';
        item.setAttribute('data-index', index);
        
        const nameColor = qualityColors[treasure.quality];
        
        item.innerHTML = `
            <img class="treasure-icon" src="${treasure.image}" alt="${treasure.name}">
            <div class="treasure-name" style="color: ${nameColor}">${treasure.name}</div>
            <div class="treasure-count">${treasure.count}</div> <!-- ä¿®æ”¹ï¼šæ•°é‡æ˜¾ç¤ºåœ¨å³ä¸Šè§’ -->
        `;
        
        item.addEventListener('mouseover', function(e) {
    const rect = this.getBoundingClientRect();
    treasureTooltip.innerHTML = `
        <div class="name" style="color: ${nameColor}">${treasure.name}</div>
        <div class="quality" style="color: ${nameColor}">å“è´¨ï¼š${qualityNames[treasure.quality]}</div>
        <div class="level">ç­‰çº§ï¼š${treasure.level}</div>
        <div class="description">${treasure.description}</div>
    `;
    treasureTooltip.style.display = 'block';
    treasureTooltip.style.left = (rect.left + rect.width/2 - 100) + 'px';
    treasureTooltip.style.top = (rect.top - treasureTooltip.offsetHeight - 10) + 'px';
});

item.addEventListener('mouseout', function() {
    treasureTooltip.style.display = 'none';
});

// æ–°å¢ï¼šç‚¹å‡»èƒŒåŒ…ç‰©å“æ˜¾ç¤ºè¯¦æƒ…å¼¹çª—
item.addEventListener('click', function() {
    // æ£€æŸ¥æ˜¯å¦ä¸ºè—å“å®ç®±ï¼ˆåç§°åŒ¹é…ï¼‰
    if (treasure.name === "è—å“å®ç®±") {
        openTreasureBox(treasure);
    } 
    // æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºé‡‘å¸å®ç®±
    else if (treasure.name === "é‡‘å¸å®ç®±") {
        openGoldTreasureBox(treasure);
    } 
    // æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºåŒå€å¡åˆ¸
    else if (treasure.name === "åŒå€å¡åˆ¸" && treasure.isBuffItem) {
        useDoubleCoupon(treasure);
    } 
    // æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºè‡ªåŠ¨ç‚¹å‡»å¡
    else if (treasure.name === "è‡ªåŠ¨ç‚¹å‡»å¡") {
        useAutoClickCard(treasure);
    } else {
        showTreasureDetail(treasure);
    }
});

backpackItems.appendChild(item);
                });
            }
            
            // æ›´æ–°å›¾é‰´æ˜¾ç¤º - ä¿®æ”¹ï¼šæœªè·å¾—çš„è—å“ä¸æ˜¾ç¤ºåç§°
            function updateHandbookDisplay() {
                handbookItems.innerHTML = '';
                
                currentTreasures.forEach(treasure => {
                    const item = document.createElement('div');
                    const hasTreasure = backpack.some(item => item.name === treasure.name);
                    
                    item.className = `handbook-item ${hasTreasure ? '' : 'unknown'}`;
                    
                    const nameColor = qualityColors[treasure.quality];
                    
                    item.innerHTML = `
                        <img class="handbook-icon" src="${hasTreasure ? treasure.image : 'images/unknown.png'}" alt="${treasure.name}">
                        ${hasTreasure ? `<div class="handbook-name" style="color: ${nameColor}">${treasure.name}</div>` : ''}
                    `; 
                    
                    item.addEventListener('mouseover', function(e) {
                        const rect = this.getBoundingClientRect();
                        treasureTooltip.innerHTML = `
                            <div class="name" style="color: ${hasTreasure ? nameColor : '#ccc'}">${hasTreasure ? treasure.name : 'ï¼Ÿï¼Ÿï¼Ÿ'}</div>
                            <div class="quality" style="color: ${hasTreasure ? nameColor : '#ccc'}">å“è´¨ï¼š${hasTreasure ? qualityNames[treasure.quality] : 'ï¼Ÿï¼Ÿï¼Ÿ'}</div>
                            <div class="level">ç­‰çº§ï¼š${hasTreasure ? treasure.level : 'ï¼Ÿï¼Ÿï¼Ÿ'}</div>
                            <div class="description">${hasTreasure ? treasure.description : 'å°šæœªè·å¾—è¯¥è—å“'}</div>
                        `;
                        treasureTooltip.style.display = 'block';
                        treasureTooltip.style.left = (rect.left + rect.width/2 - 100) + 'px';
                        treasureTooltip.style.top = (rect.top - treasureTooltip.offsetHeight - 10) + 'px';
                    });
                    
                    item.addEventListener('mouseout', function() {
                        treasureTooltip.style.display = 'none';
                    });
                    
                    handbookItems.appendChild(item);
                });
            }
            
            // æ˜¾ç¤ºå®ç‰©è¯¦æƒ…
function showTreasureDetail(treasure, isDouble = false) {
    detailImage.src = treasure.image;
    detailImage.alt = treasure.name;
    
    // è®¾ç½®ç‰©å“åç§°å’Œå“è´¨çš„é¢œè‰²ä¸å“è´¨ä¸€è‡´
    const qualityColor = qualityColors[treasure.quality];
    detailName.style.color = qualityColor;
    detailQuality.style.color = qualityColor;
    
    // è®¾ç½®å…‰ç¯é¢œè‰²ä¸å“è´¨ä¸€è‡´
    detailGlow.style.backgroundColor = qualityColor;
    
    // è®¾ç½®è¾¹æ¡†é¢œè‰²ä¸å“è´¨ä¸€è‡´
    treasureDetail.style.borderColor = qualityColor;
    
    detailName.textContent = treasure.name;
    detailQuality.textContent = `å“è´¨ï¼š${qualityNames[treasure.quality]}`;
    detailLevel.textContent = `ç­‰çº§ï¼š${treasure.level}`;
    detailDescription.textContent = treasure.description;
    
    // æ·»åŠ åŒå€å¥–åŠ±æç¤º - æ–°å¢ä»£ç å¼€å§‹
    // å…ˆæ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§æç¤º
    const existingDoubleHint = document.getElementById('double-hint');
    if (existingDoubleHint) {
        existingDoubleHint.remove();
    }
    
    if (isDouble) {
        // åˆ›å»ºåŒå€æç¤ºå…ƒç´ 
        const doubleHint = document.createElement('div');
        doubleHint.id = 'double-hint';
        doubleHint.textContent = 'âœ¨ åŒå€å¥–åŠ±ï¼è·å¾—äº†2ä¸ªï¼';
        doubleHint.style.color = '#ffcc00';
        doubleHint.style.fontSize = '20px';
        doubleHint.style.fontWeight = 'bold';
        doubleHint.style.margin = '10px 0';
        doubleHint.style.textShadow = '0 0 10px rgba(255, 204, 0, 0.8)';
        doubleHint.style.animation = 'pulse 1s infinite';
        
        // æ’å…¥åˆ°å“è´¨ä¿¡æ¯åé¢
        detailQuality.insertAdjacentElement('afterend', doubleHint);
    }
    // æ·»åŠ åŒå€å¥–åŠ±æç¤º - æ–°å¢ä»£ç ç»“æŸ
    
    treasureDetail.style.display = 'block';
}
            
            // æ˜¾ç¤ºæ¶ˆæ¯
            function showMessage(text) {
                message.textContent = text;
                message.style.display = 'block';
                
                setTimeout(() => {
                    message.style.display = 'none';
                }, 3000);
            }
            
            // æ›´æ–°å±•è§ˆç»Ÿè®¡
            function updateExhibitionStats() {
    const totalTreasures = backpack.reduce((total, item) => total + item.count, 0);
    const orangeTreasures = backpack
        .filter(item => item.quality === "orange")
        .reduce((total, item) => total + item.count, 0);
    const purpleTreasures = backpack
        .filter(item => item.quality === "purple")
        .reduce((total, item) => total + item.count, 0);
    // æ–°å¢ï¼šç¨€æœ‰è—å“ç»Ÿè®¡
    const blueTreasures = backpack
        .filter(item => item.quality === "blue")
        .reduce((total, item) => total + item.count, 0);
    // æ–°å¢ï¼šç²¾è‰¯è—å“ç»Ÿè®¡
    const greenTreasures = backpack
        .filter(item => item.quality === "green")
        .reduce((total, item) => total + item.count, 0);
    // æ–°å¢ï¼šæ™®é€šè—å“ç»Ÿè®¡
    const whiteTreasures = backpack
        .filter(item => item.quality === "white")
        .reduce((total, item) => total + item.count, 0);
    
    totalTreasuresElement.textContent = totalTreasures;
    orangeTreasuresElement.textContent = orangeTreasures;
    purpleTreasuresElement.textContent = purpleTreasures;
    // æ–°å¢ï¼šæ›´æ–°æ–°å¢çš„ä¸‰ä¸ªç»Ÿè®¡
    blueTreasuresElement.textContent = blueTreasures;
    greenTreasuresElement.textContent = greenTreasures;
    whiteTreasuresElement.textContent = whiteTreasures;
    currentGoldElement.textContent = gold;
    researchKeysElement.textContent = researchKeys;
    
    const income = calculateIncome();
    incomeAmountElement.textContent = income;

// æ–°å¢ï¼šæ›´æ–°è¿ç»­æœªå‡ºæ©™è‰²æ¬¡æ•°æ˜¾ç¤º
    document.getElementById('orange-streak').textContent = orangeGuaranteeCounter;

    // æ–°å¢ï¼šæ›´æ–°ä¸‹æ¬¡é¢†å–é’¥åŒ™æ—¶é—´
    document.getElementById('next-key-giveaway').textContent = getNextKeyGiveawayTime();
}
            
// è®¡ç®—å±•è§ˆæ”¶å…¥
function calculateIncome() {
    let baseIncome = 0;
    
    // æŒ‰è—å“åç§°åˆ†ç»„ï¼Œè®¡ç®—æ¯ä¸ªç‹¬ç«‹è—å“çš„æ€»æ•°é‡
    const itemCounts = {};
    backpack.forEach(item => {
        if (!itemCounts[item.name]) {
            itemCounts[item.name] = 0;
        }
        itemCounts[item.name] += item.count;
    });
    
    // è®¡ç®—æ¯ä¸ªç‹¬ç«‹è—å“çš„ä»·å€¼
    Object.keys(itemCounts).forEach(itemName => {
        // æ‰¾åˆ°ç¬¬ä¸€ä¸ªè¯¥åç§°çš„è—å“è·å–å“è´¨ä¿¡æ¯
        const item = backpack.find(i => i.name === itemName);
        if (item) {
            const actualCount = itemCounts[itemName];
            const effectiveCount = calculateEffectiveCount(actualCount);
            const baseValue = qualityBaseValues[item.quality] || 0;
            
            baseIncome += baseValue * effectiveCount;
        }
    });
    
    const incomeBonus = upgrades.incomeRate.level * upgrades.incomeRate.effect;
    const totalIncome = Math.floor(baseIncome * (1 + incomeBonus));

    // å‡å°‘10%æ”¶å…¥
    const reducedIncome = Math.floor(totalIncome * 0.9);

    return reducedIncome;
}
            
            // æ›´æ–°ç ”å‘æ˜¾ç¤º
            function updateResearchDisplay() {
                researchItems.innerHTML = '';
                
                const treasureRateItem = document.createElement('div');
                treasureRateItem.className = 'upgrade-item';

                // è®¡ç®—æå‡ç™¾åˆ†æ¯”
                const currentBonusPercent = Math.floor(upgrades.treasureRate.level * upgrades.treasureRate.effect * 100);

                treasureRateItem.innerHTML = `
                    <div class="upgrade-name">ç´«è‰²åŠä»¥ä¸Šè—å“æ‰ç‡æå‡</div>
                    <div class="upgrade-desc">æ¯çº§æå‡10%ç´«è‰²åŠä»¥ä¸Šè—å“è·å¾—æ¦‚ç‡ï¼Œ10çº§æ»¡çº§æå‡100%</div>
                    <div class="upgrade-effect">å½“å‰æ•ˆæœï¼šæ©™è‰²æ¦‚ç‡ æå‡${currentBonusPercent}%ï¼Œç´«è‰²æ¦‚ç‡ æå‡${currentBonusPercent}%</div>
                    <div class="upgrade-level">ç­‰çº§: ${upgrades.treasureRate.level}/${upgrades.treasureRate.maxLevel} (æ¯çº§+10%)</div>
                    <div class="upgrade-cost">
                        <div class="cost-item">ğŸ’° ${upgrades.treasureRate.cost * (upgrades.treasureRate.level + 1)}</div>
                        <div class="cost-item">ğŸ”‘ ${upgrades.treasureRate.keyCost}</div>
                    </div>
                    <button class="upgrade-button" id="upgrade-treasure-rate" ${upgrades.treasureRate.level >= upgrades.treasureRate.maxLevel || 
                        gold < upgrades.treasureRate.cost * (upgrades.treasureRate.level + 1) || 
                        researchKeys < upgrades.treasureRate.keyCost ? 'disabled' : ''}>
                        ${upgrades.treasureRate.level >= upgrades.treasureRate.maxLevel ? 'å·²æ»¡çº§' : 'å‡çº§'}
                    </button>
                `;
                researchItems.appendChild(treasureRateItem);
                
                const incomeRateItem = document.createElement('div');
                incomeRateItem.className = 'upgrade-item';

                // è®¡ç®—é—¨ç¥¨æ”¶å…¥æå‡ç™¾åˆ†æ¯”
                const currentIncomeBonus = upgrades.incomeRate.level * upgrades.incomeRate.effect; // æ¯çº§5%æå‡
                const currentIncomeBonusPercent = Math.floor(currentIncomeBonus * 100); // è½¬æ¢ä¸ºç™¾åˆ†æ¯”æ•´æ•°

                incomeRateItem.innerHTML = `
                    <div class="upgrade-name">é—¨ç¥¨æ”¶å…¥æå‡</div>
                    <div class="upgrade-desc">æé«˜å±•è§ˆé—¨ç¥¨æ”¶å…¥</div>
                    <div class="upgrade-effect">å½“å‰æ•ˆæœï¼šé—¨ç¥¨æ”¶å…¥ æå‡${currentIncomeBonusPercent}%</div>
                    <div class="upgrade-level">ç­‰çº§: ${upgrades.incomeRate.level}/${upgrades.incomeRate.maxLevel}</div>
                    <div class="upgrade-cost">
                        <div class="cost-item">ğŸ’° ${upgrades.incomeRate.cost * (upgrades.incomeRate.level + 1)}</div>
                        <div class="cost-item">ğŸ”‘ ${upgrades.incomeRate.keyCost}</div>
                    </div>
                    <button class="upgrade-button" id="upgrade-income-rate" ${upgrades.incomeRate.level >= upgrades.incomeRate.maxLevel || 
                        gold < upgrades.incomeRate.cost * (upgrades.incomeRate.level + 1) || 
                        researchKeys < upgrades.incomeRate.keyCost ? 'disabled' : ''}>
                        ${upgrades.incomeRate.level >= upgrades.incomeRate.maxLevel ? 'å·²æ»¡çº§' : 'å‡çº§'}
                    </button>
                `;
                researchItems.appendChild(incomeRateItem);
                
                const doubleTreasureItem = document.createElement('div');
                doubleTreasureItem.className = 'upgrade-item';
                doubleTreasureItem.innerHTML = `
                    <div class="upgrade-name">åŒå€å®ç‰©æ¦‚ç‡</div>
                    <div class="upgrade-desc">å¯»å®æ—¶æœ‰æ¦‚ç‡è·å¾—åŒå€å®ç‰©</div>
                    <div class="upgrade-effect">å½“å‰æ•ˆæœï¼š${(upgrades.doubleTreasure.level * upgrades.doubleTreasure.effect * 100).toFixed(1)}%æ¦‚ç‡è·å¾—åŒå€å®ç‰©</div>
                    <div class="upgrade-level">ç­‰çº§: ${upgrades.doubleTreasure.level}/${upgrades.doubleTreasure.maxLevel}</div>
                    <div class="upgrade-cost">
                        <div class="cost-item">ğŸ’° ${upgrades.doubleTreasure.cost * (upgrades.doubleTreasure.level + 1)}</div>
                        <div class="cost-item">ğŸ”‘ ${upgrades.doubleTreasure.keyCost}</div>
                    </div>
                    <button class="upgrade-button" id="upgrade-double-treasure" ${upgrades.doubleTreasure.level >= upgrades.doubleTreasure.maxLevel || 
                        gold < upgrades.doubleTreasure.cost * (upgrades.doubleTreasure.level + 1) || 
                        researchKeys < upgrades.doubleTreasure.keyCost ? 'disabled' : ''}>
                        ${upgrades.doubleTreasure.level >= upgrades.doubleTreasure.maxLevel ? 'å·²æ»¡çº§' : 'å‡çº§'}
                    </button>
                `;
                researchItems.appendChild(doubleTreasureItem);
                
                // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const oldTreasureRateBtn = document.getElementById('upgrade-treasure-rate');
                const oldIncomeRateBtn = document.getElementById('upgrade-income-rate');
                const oldDoubleTreasureBtn = document.getElementById('upgrade-double-treasure');
                
                if (oldTreasureRateBtn) {
                    oldTreasureRateBtn.replaceWith(oldTreasureRateBtn.cloneNode(true));
                }
                if (oldIncomeRateBtn) {
                    oldIncomeRateBtn.replaceWith(oldIncomeRateBtn.cloneNode(true));
                }
                if (oldDoubleTreasureBtn) {
                    oldDoubleTreasureBtn.replaceWith(oldDoubleTreasureBtn.cloneNode(true));
                }
                
                // é‡æ–°ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
                document.getElementById('upgrade-treasure-rate').addEventListener('click', function() {
                    upgradeResearch('treasureRate');
                });
                
                document.getElementById('upgrade-income-rate').addEventListener('click', function() {
                    upgradeResearch('incomeRate');
                });
                
                document.getElementById('upgrade-double-treasure').addEventListener('click', function() {
                    upgradeResearch('doubleTreasure');
                });
            }
            
            // ç ”å‘å‡çº§ - ä¿®å¤ï¼šç¡®ä¿æ¶ˆè€—ç ”å‘å¯†åŒ™å¹¶ä»èƒŒåŒ…ä¸­ç§»é™¤
            function upgradeResearch(upgradeType) {
                const upgrade = upgrades[upgradeType];
                
                if (upgrade.level >= upgrade.maxLevel) {
                    showMessage('è¯¥å‡çº§å·²æ»¡çº§ï¼');
                    return;
                }
                
                const cost = upgrade.cost * (upgrade.level + 1);
                
                if (gold < cost) {
                    showMessage('é‡‘å¸ä¸è¶³ï¼');
                    return;
                }
                
                if (researchKeys < upgrade.keyCost) {
                    showMessage('ç ”å‘å¯†åŒ™ä¸è¶³ï¼');
                    return;
                }
                
                // ä»èƒŒåŒ…ä¸­ç§»é™¤ç ”å‘å¯†åŒ™
                const researchKeyIndex = backpack.findIndex(item => item.name === "ç ”å‘å¯†åŒ™");
                if (researchKeyIndex !== -1) {
                    if (backpack[researchKeyIndex].count > 1) {
                        backpack[researchKeyIndex].count -= upgrade.keyCost;
                    } else {
                        // å¦‚æœåªå‰©1ä¸ªï¼Œç§»é™¤æ•´ä¸ªç‰©å“
                        backpack.splice(researchKeyIndex, 1);
                    }
                }
                
                // æ›´æ–°ç ”å‘å¯†åŒ™è®¡æ•°
                researchKeys -= upgrade.keyCost;
                
                gold -= cost;
                upgrade.level++;
                
                // æ›´æ–°æ‰€æœ‰ç›¸å…³æ˜¾ç¤º
                updateBackpackDisplay();
                updateHandbookDisplay();
                updateExhibitionStats();
                updateResearchDisplay();
                
                showMessage(`${upgradeType === 'treasureRate' ? 'ç´«è‰²åŠä»¥ä¸Šè—å“æ‰ç‡' : upgradeType === 'incomeRate' ? 'é—¨ç¥¨æ”¶å…¥' : 'åŒå€å®ç‰©æ¦‚ç‡'}æå‡åˆ° ${upgrade.level} çº§ï¼`);
                
                saveGame();
            }
            
            // æ›´æ–°åœºæ™¯æ˜¾ç¤º
            function updateScenesDisplay() {
    scenesList.innerHTML = '';
    
    // è®¡ç®—å½“å‰æ€»è—å“æ•°
    const totalTreasures = backpack.reduce((total, item) => total + item.count, 0);
    
    scenes.forEach(scene => {
        const sceneItem = document.createElement('div');
        sceneItem.className = `scene-item ${scene.id === currentScene ? 'current' : ''}`;
        
        // è®¡ç®—é—¨æ§›ä¿¡æ¯
let requirementHtml = '';
if (scene.id === 4) {
    // åœºæ™¯4ç‰¹æ®Šå‡†å…¥é—¨æ§›ï¼šéœ€è¦ã€Šæ¢¦å›æ¢å±±ã€‹è§‚å½±åˆ¸
    const hasMovieTicket = backpack.some(item => item.name === "ã€Šæ¢¦å›æ¢å±±ã€‹è§‚å½±åˆ¸");
    const requirementClass = hasMovieTicket ? 'requirement-met' : 'requirement-not-met';
    requirementHtml = `<div class="scene-status ${requirementClass}">å‡†å…¥é—¨æ§›: ã€Šæ¢¦å›æ¢å±±ã€‹è§‚å½±åˆ¸ (${hasMovieTicket ? 'å·²æ»¡è¶³' : 'æœªæ»¡è¶³'})</div>`;
} else if (scene.id === 5) {
    // åœºæ™¯5ç‰¹æ®Šå‡†å…¥é—¨æ§›ï¼šéœ€è¦ã€Šé‡‘é™µè½¶äº‹å½•ã€‹
    const hasRecord = backpack.some(item => item.name === "ã€Šé‡‘é™µè½¶äº‹å½•ã€‹");
    const requirementClass = hasRecord ? 'requirement-met' : 'requirement-not-met';
    requirementHtml = `<div class="scene-status ${requirementClass}">å‡†å…¥é—¨æ§›: ã€Šé‡‘é™µè½¶äº‹å½•ã€‹ (${hasRecord ? 'å·²æ»¡è¶³' : 'æœªæ»¡è¶³'})</div>`;
} else if (scene.id === 6) {
    // åœºæ™¯6ç‰¹æ®Šå‡†å…¥é—¨æ§›ï¼šé’é“œé’¥åŒ™
    const hasRecord = backpack.some(item => item.name === "é’é“œé’¥åŒ™");
    const requirementClass = hasRecord ? 'requirement-met' : 'requirement-not-met';
    requirementHtml = `<div class="scene-status ${requirementClass}">å‡†å…¥é—¨æ§›: é’é“œé’¥åŒ™ (${hasRecord ? 'å·²æ»¡è¶³' : 'æœªæ»¡è¶³'})</div>`;
}
// åœ¨åœºæ™¯å…¥å£è¦æ±‚ä¸­æ·»åŠ åœºæ™¯8çš„å¤„ç†
else if (scene.entryRequirement.type === "special" && scene.entryRequirement.requiredItem === "ã€Šä¸–ç•Œé€šå²ã€‹") {
    const hasRecord = backpack.some(item => item.name === "ã€Šä¸–ç•Œé€šå²ã€‹");
    const requirementClass = hasRecord ? 'requirement-met' : 'requirement-not-met';
    requirementHtml = `<div class="scene-status ${requirementClass}">å‡†å…¥é—¨æ§›: ã€Šä¸–ç•Œé€šå²ã€‹ (${hasRecord ? 'å·²æ»¡è¶³' : 'æœªæ»¡è¶³'})</div>`;
}else if (scene.entryRequirement > 0) {
    const hasMetRequirement = totalTreasures >= scene.entryRequirement;
    const requirementClass = hasMetRequirement ? 'requirement-met' : 'requirement-not-met';
    requirementHtml = `<div class="scene-status ${requirementClass}">å‡†å…¥é—¨æ§›: ${scene.entryRequirement}ä»¶è—å“ (${hasMetRequirement ? 'å·²æ»¡è¶³' : `è¿˜éœ€${scene.entryRequirement - totalTreasures}ä»¶`})</div>`;
} else {
    requirementHtml = `<div class="scene-status">å‡†å…¥é—¨æ§›: æ— </div>`;
}
        
        // æ¶ˆè€—ä¿¡æ¯
        const costHtml = `<div class="scene-status">å¯»å®æ¶ˆè€—: ${scene.huntCost > 0 ? `${scene.huntCost}é‡‘å¸/æ¬¡` : 'å…è´¹'}</div>`;
        
        sceneItem.innerHTML = `
            <div class="scene-name">${scene.name}</div>
            <div class="scene-status">${scene.description}</div>
            ${requirementHtml}
            ${costHtml}
        `;
        
        sceneItem.addEventListener('click', function() {
            if (scene.id !== currentScene) {
// æ£€æŸ¥æ˜¯å¦æœ‰BUFFï¼Œå¦‚æœæœ‰åˆ™æç¤º
if (currentBuff) {
    // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼Œæ˜¾ç¤ºæç¤ºä½†ä¸åˆ‡æ¢
    if (!window.buffWarningShown) {
        showMessage("åˆ‡æ¢åœºæ™¯buffå°†æ¶ˆå¤±ï¼Œè¯·è°¨æ…åˆ‡æ¢");
        window.buffWarningShown = true; // è®¾ç½®æ ‡å¿—
        setTimeout(() => {
            window.buffWarningShown = false; // 3ç§’åé‡ç½®æ ‡å¿—
        }, 3000);
        return; // ä¸æ‰§è¡Œåˆ‡æ¢
    } else {
        // ç¬¬äºŒæ¬¡ç‚¹å‡»ï¼Œæ¸…é™¤BUFFå¹¶åˆ‡æ¢åœºæ™¯
        currentBuff = null;
        buffEffectElement.style.display = 'none';
        window.buffWarningShown = false; // é‡ç½®æ ‡å¿—
        showMessage("åˆ‡æ¢åœºæ™¯ï¼ŒBUFFæ•ˆæœå·²æ¶ˆå¤±");
    }
}
// æ–°å¢ï¼šæ¸…é™¤é­”æ³•å¸ˆæ•ˆæœ
        if (currentBuff) {
            currentBuff = null;
            buffEffectElement.style.display = 'none';
            showMessage("åˆ‡æ¢åœºæ™¯ï¼Œé­”æ³•å¸ˆæ•ˆæœå·²æ¶ˆå¤±", 3000);
        }
                switchScene(scene.id);
            }
        });
        
        scenesList.appendChild(sceneItem);
    });
}
            
            // åˆ‡æ¢åœºæ™¯
function switchScene(sceneId) {
    // è·å–ç›®æ ‡åœºæ™¯
    const targetScene = scenes[sceneId - 1];
    
    // ç‰¹æ®Šå¤„ç†åœºæ™¯4ï¼šéœ€è¦ã€Šæ¢¦å›æ¢å±±ã€‹è§‚å½±åˆ¸
    if (sceneId === 4) {
        const hasMovieTicket = backpack.some(item => item.name === "ã€Šæ¢¦å›æ¢å±±ã€‹è§‚å½±åˆ¸");
        
        if (!hasMovieTicket) {
            showMessage(`è¿›å…¥${targetScene.name}éœ€è¦æ‹¥æœ‰ã€Šæ¢¦å›æ¢å±±ã€‹è§‚å½±åˆ¸ï¼<br>è¯·å…ˆé€šè¿‡åˆæˆè·å¾—è§‚å½±åˆ¸ã€‚`);
            
            // åˆ·æ–°åœºæ™¯æ˜¾ç¤º
            updateScenesDisplay();
            return;
        }
    } 
    // ç‰¹æ®Šå¤„ç†åœºæ™¯5ï¼šéœ€è¦ã€Šé‡‘é™µè½¶äº‹å½•ã€‹
    else if (sceneId === 5) {
        const hasRecord = backpack.some(item => item.name === "ã€Šé‡‘é™µè½¶äº‹å½•ã€‹");
        
        if (!hasRecord) {
            showMessage(`è¿›å…¥${targetScene.name}éœ€è¦æ‹¥æœ‰ã€Šé‡‘é™µè½¶äº‹å½•ã€‹ï¼<br>è¯·å…ˆé€šè¿‡åˆæˆè·å¾—é‡‘é™µè½¶äº‹å½•ã€‚`);
            
            // åˆ·æ–°åœºæ™¯æ˜¾ç¤º
            updateScenesDisplay();
            return;
        }
    }
// ç‰¹æ®Šå¤„ç†åœºæ™¯6ï¼šéœ€è¦é’é“œé’¥åŒ™
    else if (sceneId === 6) {
        const hasRecord = backpack.some(item => item.name === "é’é“œé’¥åŒ™");
        
        if (!hasRecord) {
            showMessage(`è¿›å…¥${targetScene.name}éœ€è¦æ‹¥æœ‰é’é“œé’¥åŒ™ï¼<br>è¯·å…ˆé€šè¿‡åˆæˆè·å¾—é’é“œé’¥åŒ™ã€‚`);
            
            // åˆ·æ–°åœºæ™¯æ˜¾ç¤º
            updateScenesDisplay();
            return;
        }
    }
else if (sceneId === 8) {
    const hasRecord = backpack.some(item => item.name === "ã€Šä¸–ç•Œé€šå²ã€‹");
    
    if (!hasRecord) {
        showMessage(`è¿›å…¥${targetScene.name}éœ€è¦æ‹¥æœ‰ã€Šä¸–ç•Œé€šå²ã€‹ï¼<br>è¯·å…ˆé€šè¿‡åˆæˆè·å¾—ã€Šä¸–ç•Œé€šå²ã€‹ã€‚`);
        
        // åˆ·æ–°åœºæ™¯æ˜¾ç¤º
        updateScenesDisplay();
        return;
    }
}
else if (sceneId === 9) {
    // ç‰¹æ®Šå¤„ç†åœºæ™¯9ï¼šåªèƒ½é€šè¿‡ç‰¹å®šäº‹ä»¶è¿›å…¥
    showMessage(`æ— æ³•ç›´æ¥è¿›å…¥${targetScene.name}ï¼<br>å¬è¯´åœºæ™¯3ï¼ˆå¸é€šå¤ä»Šï¼‰å†…æœ‰æ‰‡å°é—¨ã€‚`);
    
    // åˆ·æ–°åœºæ™¯æ˜¾ç¤º
    updateScenesDisplay();
    return;
}
    else {
        // å…¶ä»–åœºæ™¯ï¼šæ£€æŸ¥å‡†å…¥é—¨æ§›ï¼ˆè—å“æ•°é‡ï¼‰
        const totalTreasures = backpack.reduce((total, item) => total + item.count, 0);
        
        if (totalTreasures < targetScene.entryRequirement) {
            const needed = targetScene.entryRequirement - totalTreasures;
            showMessage(`è¿›å…¥${targetScene.name}éœ€è¦æ‹¥æœ‰${targetScene.entryRequirement}ä»¶è—å“<br>å½“å‰æ‹¥æœ‰ï¼š${totalTreasures}ä»¶<br>è¿˜å·®ï¼š${needed}ä»¶`);
        
        // åˆ·æ–°åœºæ™¯æ˜¾ç¤º
        updateScenesDisplay();
        return;
    }
}
                // æ·»åŠ åœºæ™¯åˆ‡æ¢åŠ¨ç”»
                gameContainer.classList.add('scene-transition');
                
                setTimeout(() => {
                    // æ›´æ–°å½“å‰åœºæ™¯
                    currentScene = sceneId;
                    updateCurrentSceneTreasures();
                    
                    // æ›´æ–°åœºæ™¯æ˜¾ç¤º
                    updateSceneDisplay();
                    
                    // æ›´æ–°èƒŒæ™¯å›¾ç‰‡
                    gameContainer.style.backgroundImage = `url('${scenes[currentScene - 1].background}')`;
                    gameContainer.style.backgroundSize = 'cover';
                    gameContainer.style.backgroundPosition = 'center';
                    
                    // æ›´æ–°å›¾é‰´æ˜¾ç¤º
                    updateHandbookDisplay();
                    
                    // ä¿å­˜æ¸¸æˆ
                    saveGame();
                    
                    // ç§»é™¤åŠ¨ç”»ç±»
                    setTimeout(() => {
                        gameContainer.classList.remove('scene-transition');
                    }, 100);
                    
                    showMessage(`å·²åˆ‡æ¢åˆ°${scenes[currentScene - 1].name}`);
                    scenesModal.style.display = 'none';
                }, 500);
            }
            
            // æ›´æ–°åœºæ™¯æ˜¾ç¤º
function updateSceneDisplay() {
    const scene = scenes[currentScene - 1];
    const costText = scene.huntCost > 0 ? `æ¶ˆè€—${scene.huntCost}é‡‘å¸/æ¬¡` : 'å…è´¹å¯»å®';
    // ç®€åŒ–æ˜¾ç¤ºæ ¼å¼ï¼Œåªæ˜¾ç¤ºåœºæ™¯åç§°å’Œæ¶ˆè€—ä¿¡æ¯
    const sceneName = scene.name.split('ï¼š')[1] || scene.name;
    currentSceneElement.textContent = `${sceneName}ï¼ˆ${costText}ï¼‰`;
}
            
// åˆå§‹åŒ–é›‡ä½£ç›¸å…³DOMå…ƒç´ 
function initHireElements() {
    hireBtn = document.getElementById('hire-btn');
    hireModal = document.getElementById('hire-modal');
    closeHire = document.getElementById('close-hire');
    hireCountSelect = document.getElementById('hire-count');
    hireDurationSelect = document.getElementById('hire-duration');
    hireConfirmBtn = document.getElementById('hire-confirm');
    hireCollectBtn = document.getElementById('hire-collect');
    hireStatusContent = document.getElementById('hire-status-content');
    
    // ç»‘å®šäº‹ä»¶
    if (hireBtn) {
        hireBtn.addEventListener('click', function() {
            updateHireDisplay();
            hireModal.style.display = 'flex';
        });
    }
    
    if (closeHire) {
        closeHire.addEventListener('click', function() {
            hireModal.style.display = 'none';
        });
    }
    
    if (hireConfirmBtn) {
        hireConfirmBtn.addEventListener('click', function() {
            hireTreasureHunters();
        });
    }
    
    if (hireCollectBtn) {
        hireCollectBtn.addEventListener('click', function() {
            // æŸ¥æ‰¾å·²å®Œæˆçš„ä»»åŠ¡å¹¶æ”¶å–
            const now = Date.now();
            let collected = false;
            
            for (let i = hireJobs.length - 1; i >= 0; i--) {
                if (hireJobs[i].endTime <= now) {
                    collectHireResult(i);
                    collected = true;
                }
            }
            
            if (!collected) {
                showMessage('æ²¡æœ‰å¯æ”¶å–çš„ä»»åŠ¡ï¼');
            }
        });
    }
}

            // åˆå§‹åŒ–å­˜æ¡£ç›¸å…³DOMå…ƒç´ 
            function initSaveElements() {
                // è·å–å­˜æ¡£ç›¸å…³DOMå…ƒç´ 
                sceneBtn = document.getElementById('scene-btn');
                scenesModal = document.getElementById('scenes-modal');
                scenesList = document.getElementById('scenes-list');
                closeScenes = document.getElementById('close-scenes');
                saveBtn = document.getElementById('save-btn');
                saveModal = document.getElementById('save-modal');
                saveActions = document.getElementById('save-actions');
                closeSave = document.getElementById('close-save');
                
                console.log("å­˜æ¡£æŒ‰é’®å…ƒç´ :", saveBtn);
                console.log("å­˜æ¡£æ¨¡æ€æ¡†å…ƒç´ :", saveModal);
                
                // ç»‘å®šäº‹ä»¶
                if (saveBtn) {
                    saveBtn.addEventListener('click', handleSaveClick);
                    console.log("å­˜æ¡£æŒ‰é’®äº‹ä»¶å·²ç»‘å®š");
                }
                
                // ç»‘å®šå…¶ä»–æŒ‰é’®äº‹ä»¶
                if (sceneBtn) {
                    sceneBtn.addEventListener('click', function() {
                        updateScenesDisplay();
                        scenesModal.style.display = 'flex';
                    });
                }
                
                if (closeScenes) {
                    closeScenes.addEventListener('click', function() {
                        scenesModal.style.display = 'none';
                    });
                }
                
                if (closeSave) {
                    closeSave.addEventListener('click', function() {
                        saveModal.style.display = 'none';
                    });
                }
            }
            
            // å­˜æ¡£æŒ‰é’®ç‚¹å‡»å¤„ç†å‡½æ•°
            function handleSaveClick() {
                console.log("å­˜æ¡£æŒ‰é’®è¢«ç‚¹å‡»");
                if (!saveModal) {
                    console.error("å­˜æ¡£æ¨¡æ€æ¡†æœªæ‰¾åˆ°");
                    return;
                }
                updateSaveDisplay();
                saveModal.style.display = 'flex';
            }
            
            // æ›´æ–°å­˜æ¡£ç®¡ç†æ˜¾ç¤º - æ”¹ä¸ºæ–‡ä»¶æ“ä½œ
            function updateSaveDisplay() {
                saveActions.innerHTML = '';
                
                // å¯¼å‡ºå­˜æ¡£éƒ¨åˆ†
                const exportAction = document.createElement('div');
                exportAction.className = 'save-action';
                exportAction.innerHTML = `
                    <div class="save-action-title">å¯¼å‡ºå­˜æ¡£</div>
                    <div class="save-action-desc">å°†å½“å‰æ¸¸æˆè¿›åº¦å¯¼å‡ºä¸ºæ–‡ä»¶</div>
                    <button class="save-action-button" id="export-save-btn">å¯¼å‡ºå­˜æ¡£æ–‡ä»¶</button>
                    <div id="export-message"></div>
                    <div class="file-info">æ–‡ä»¶å°†ä¿å­˜ä¸º treasure_hunt_save.json</div>
                `;
                saveActions.appendChild(exportAction);
                
                // å¯¼å…¥å­˜æ¡£éƒ¨åˆ†
                const importAction = document.createElement('div');
                importAction.className = 'save-action';
                importAction.innerHTML = `
                    <div class="save-action-title">å¯¼å…¥å­˜æ¡£</div>
                    <div class="save-action-desc">ä»æ–‡ä»¶å¯¼å…¥æ¸¸æˆè¿›åº¦ï¼ˆä¼šè¦†ç›–å½“å‰è¿›åº¦ï¼‰</div>
                    <div class="file-upload-container">
                        <label for="import-file-input" class="file-input-label">é€‰æ‹©å­˜æ¡£æ–‡ä»¶</label>
                        <div id="selected-file-name" style="color:#ccc;margin-top:5px;font-size:12px;">æœªé€‰æ‹©æ–‡ä»¶</div>
                    </div>
                    <div id="import-message"></div>
                    <button class="save-action-button" id="import-save-btn" disabled>å¯¼å…¥å­˜æ¡£</button>
                    <div class="file-info">æ”¯æŒ JSON æˆ– TXT æ ¼å¼çš„å­˜æ¡£æ–‡ä»¶</div>
                `;
                saveActions.appendChild(importAction);
                
                // ç»‘å®šå¯¼å‡ºåŠŸèƒ½
                const exportSaveBtn = document.getElementById('export-save-btn');
                exportSaveBtn.addEventListener('click', exportSaveFile);
                
                // ç»‘å®šæ–‡ä»¶é€‰æ‹©åŠŸèƒ½
                const importFileBtn = document.getElementById('import-save-btn');
                const selectedFileName = document.getElementById('selected-file-name');
                
                importFileInput.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];
                        selectedFileName.textContent = `å·²é€‰æ‹©: ${file.name}`;
                        importFileBtn.disabled = false;
                    } else {
                        selectedFileName.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
                        importFileBtn.disabled = true;
                    }
                });
                
                // ç»‘å®šå¯¼å…¥åŠŸèƒ½
                importFileBtn.addEventListener('click', importSaveFile);
            }
            
            // å¯¼å‡ºå­˜æ¡£ä¸ºæ–‡ä»¶
            function exportSaveFile() {
                                const gameData = {
    backpack: backpack,  // ä¿ç•™èƒŒåŒ…æ•°æ®ï¼ˆåŒ…æ‹¬å®ç®±ï¼‰
    treasureCount: treasureCount,
    gold: gold,
    researchKeys: researchKeys,
    upgrades: upgrades,
    lastIncomeTime: lastIncomeTime,
    currentScene: currentScene,
    hasCollectedAllTreasures: hasCollectedAllTreasures,
    // ä¸ä¿å­˜buffçŠ¶æ€
    orangeGuaranteeCounter: orangeGuaranteeCounter,
    lastOrangeCount: lastOrangeCount,
    lastKeyGiveawayTime: lastKeyGiveawayTime,
    obtainedUniqueTreasures: obtainedUniqueTreasures,
    hireJobs: hireJobs,
    exportDate: new Date().toISOString(),
    gameName: "å¯»å®çŒäººLift"
};

                
                const dataStr = JSON.stringify(gameData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `treasure_hunt_save_${new Date().toISOString().slice(0,10)}.json`;
                
                // è§¦å‘ä¸‹è½½
                document.body.appendChild(a);
                a.click();
                
                // æ¸…ç†
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                const exportMessage = document.getElementById('export-message');
                exportMessage.textContent = "å­˜æ¡£å·²å¯¼å‡ºï¼";
                exportMessage.style.color = "#2ecc71";
                setTimeout(() => {
                    exportMessage.textContent = "";
                }, 3000);
                
                console.log("å­˜æ¡£å·²å¯¼å‡º");
            }
            
            // ä»æ–‡ä»¶å¯¼å…¥å­˜æ¡£
            function importSaveFile() {
                const file = importFileInput.files[0];
                if (!file) {
                    const importMessage = document.getElementById('import-message');
                    importMessage.textContent = "è¯·å…ˆé€‰æ‹©å­˜æ¡£æ–‡ä»¶ï¼";
                    importMessage.style.color = "#e74c3c";
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        // éªŒè¯å¯¼å…¥çš„æ•°æ®ç»“æ„
                        if (!importedData.backpack || !importedData.upgrades) {
                            throw new Error("å­˜æ¡£æ ¼å¼ä¸æ­£ç¡®");
                        }
                        
                        // ç¡®è®¤å¯¼å…¥
                        if (confirm("å¯¼å…¥å­˜æ¡£å°†è¦†ç›–å½“å‰æ¸¸æˆè¿›åº¦ï¼Œç¡®å®šè¦å¯¼å…¥å—ï¼Ÿ")) {
                        // å¯¼å…¥æ•°æ®
                        backpack = importedData.backpack || [];
                        treasureCount = importedData.treasureCount || 0;
                        gold = importedData.gold || 0;
                        researchKeys = importedData.researchKeys || 0;
                        upgrades = importedData.upgrades;
                        lastIncomeTime = importedData.lastIncomeTime || Date.now();
                        currentScene = importedData.currentScene || 1;
                        hasCollectedAllTreasures = importedData.hasCollectedAllTreasures || false;
                        // ä¸å¯¼å…¥buffçŠ¶æ€ï¼Œä¿æŒå½“å‰çŠ¶æ€
                        currentBuff = null; // é‡ç½®ä¸ºnull
                        
                        // æ–°å¢ï¼šå¯¼å…¥æ©™è‰²ä¿åº•è®¡æ•°å™¨
                        orangeGuaranteeCounter = importedData.orangeGuaranteeCounter || 0;
                        lastOrangeCount = importedData.lastOrangeCount || 0;
                        
                        // æ–°å¢ï¼šå¯¼å…¥ä¸Šæ¬¡èµ é€é’¥åŒ™æ—¶é—´
lastKeyGiveawayTime = importedData.lastKeyGiveawayTime || Date.now();

// æ–°å¢ï¼šå¯¼å…¥æ›¾ç»è·å¾—è¿‡çš„å”¯ä¸€è—å“è®°å½•
obtainedUniqueTreasures = importedData.obtainedUniqueTreasures || [];
                        
                        // å¼ºåˆ¶æ›´æ–°costä¸º10000
                        for (const key in upgrades) {
                            upgrades[key].cost = 10000;
                        }
                            
                            // æ›´æ–°å½“å‰åœºæ™¯çš„å®ç‰©æ•°æ®
                            updateCurrentSceneTreasures();
                            
                            // æ›´æ–°UI
                            updateBackpackDisplay();
                            updateHandbookDisplay();
                            updateExhibitionStats();
                            updateResearchDisplay();
                            updateSceneDisplay();
                            updateBuffDisplay(); // æ–°å¢ï¼šæ›´æ–°BUFFæ˜¾ç¤º
                            saveGame();
                            
                            const importMessage = document.getElementById('import-message');
                            importMessage.textContent = "å­˜æ¡£å¯¼å…¥æˆåŠŸï¼";
                            importMessage.style.color = "#2ecc71";
                            
                            showMessage("å­˜æ¡£å¯¼å…¥æˆåŠŸï¼");
                            
                            // é‡ç½®æ–‡ä»¶é€‰æ‹©
                            importFileInput.value = '';
                            document.getElementById('selected-file-name').textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
                            document.getElementById('import-save-btn').disabled = true;
                            
                            setTimeout(() => {
                                saveModal.style.display = 'none';
                            }, 2000);
                        }
                    } catch (error) {
                        const importMessage = document.getElementById('import-message');
                        importMessage.textContent = "å­˜æ¡£æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æ­£ç¡®ï¼";
                        importMessage.style.color = "#e74c3c";
                        console.error("å¯¼å…¥å­˜æ¡£é”™è¯¯:", error);
                    }
                };
                
                reader.onerror = function() {
                    const importMessage = document.getElementById('import-message');
                    importMessage.textContent = "è¯»å–æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•ï¼";
                    importMessage.style.color = "#e74c3c";
                };
                
                reader.readAsText(file);
            }
            
            // è·å–æ¸¸æˆåŒºåŸŸå°ºå¯¸
            const getContainerSize = () => {
                return {
                    width: gameContainer.clientWidth,
                    height: gameContainer.clientHeight
                };
            };
            
            // éšæœºç§»åŠ¨æ°”æ³¡ï¼ˆé™åˆ¶èŒƒå›´ï¼Œé¿å…é è¿‘è¾¹ç¼˜ï¼‰
            const moveBubble = () => {
                if (isReturning || isPopping) return;
                
                const containerSize = getContainerSize();
                const bubbleSize = {
                    width: bubble.offsetWidth,
                    height: bubble.offsetHeight
                };
                
                const margin = 20;
                const maxX = containerSize.width - bubbleSize.width - margin * 2;
                const maxY = containerSize.height - bubbleSize.height - margin * 2;
                
                const randomX = Math.floor(Math.random() * maxX) + margin;
                const randomY = Math.floor(Math.random() * maxY) + margin;
                
                bubble.style.left = randomX + 'px';
                bubble.style.top = randomY + 'px';
            };
            
            // æ£€æŸ¥ç©å®¶æ˜¯å¦æ‹¥æœ‰æŒ‡å®šå“è´¨çš„è—å“ - æ–°å¢
            function hasTreasureOfQuality(quality) {
                return backpack.some(item => item.quality === quality && item.count > 0);
            }
            
            // ç§»é™¤æŒ‡å®šå“è´¨çš„è—å“ - æ–°å¢
            function removeTreasureOfQuality(quality) {
                const treasureIndex = backpack.findIndex(item => item.quality === quality && item.count > 0);
                if (treasureIndex !== -1) {
                    if (backpack[treasureIndex].count > 1) {
                        backpack[treasureIndex].count--;
                    } else {
                        backpack.splice(treasureIndex, 1);
                    }
                    return true;
                }
                return false;
            }
            
            // æ£€æŸ¥ç©å®¶æ˜¯å¦æ‹¥æœ‰è¶³å¤Ÿçš„é’¥åŒ™ - æ–°å¢
            function hasEnoughKeys(amount) {
                const keyIndex = backpack.findIndex(item => item.name === "ç ”å‘å¯†åŒ™");
                if (keyIndex !== -1) {
                    return backpack[keyIndex].count >= amount;
                }
                return false;
            }
            
            // ç§»é™¤æŒ‡å®šæ•°é‡çš„é’¥åŒ™ - æ–°å¢
            function removeKeys(amount) {
                const keyIndex = backpack.findIndex(item => item.name === "ç ”å‘å¯†åŒ™");
                if (keyIndex !== -1) {
                    if (backpack[keyIndex].count >= amount) {
                        backpack[keyIndex].count -= amount;
                        if (backpack[keyIndex].count <= 0) {
                            backpack.splice(keyIndex, 1);
                        }
                        
                        // æ›´æ–°ç ”å‘å¯†åŒ™è®¡æ•°
                        researchKeys -= amount;
                        return true;
                    }
                }
                return false;
            }
            
            // è§¦å‘é­”æ³•å¸ˆäº‹ä»¶ - ä¿®æ”¹ï¼šéšæœºé€‰æ‹©ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„äº‹ä»¶
function triggerWizardEvent() {
    // å¦‚æœæœ‰å½“å‰BUFFï¼Œåˆ™ä¸è§¦å‘æ–°äº‹ä»¶
    if (currentBuff) {
        return false;
    }

// åœºæ™¯6ã€7ã€8ã€9ã€10ä¸è§¦å‘é­”æ³•å¸ˆäº‹ä»¶
    if (currentScene === 6 || currentScene === 7 || currentScene === 8 || currentScene === 9 || currentScene === 10) {
        return false;
    }
    
    // 1%çš„æ¦‚ç‡è§¦å‘äº‹ä»¶
    if (Math.random() < 0.01) { // æ³¨æ„ï¼šè¿™é‡Œåº”è¯¥æ”¹ä¸º0.01ï¼ŒåŸæ¥å†™é”™äº†æ˜¯1
        isEventTriggered = true;
        
        // éšæœºé€‰æ‹©ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„äº‹ä»¶
        const selectedEvent = getRandomWizardEvent();
        if (selectedEvent) {
            // æ›´æ–°å½“å‰é€‰æ‹©çš„äº‹ä»¶
            currentSelectedEvent = selectedEvent;
            // æ˜¾ç¤ºå•ä¸ªäº‹ä»¶é€‰é¡¹
            showSingleWizardEvent(selectedEvent);
            return true;
        } else {
            // å¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„äº‹ä»¶ï¼Œåˆ™äº‹ä»¶ä¸è§¦å‘
            isEventTriggered = false;
            return false;
        }
    }
    return false;
}
            
            // æ˜¾ç¤ºé­”æ³•å¸ˆäº‹ä»¶æ¨¡æ€æ¡† - ä¿®æ”¹ï¼šä¸å†ç›´æ¥è°ƒç”¨updateWizardEventOptions
function showWizardEventModal() {
    // æ³¨æ„ï¼šç°åœ¨è¿™ä¸ªå‡½æ•°å¯èƒ½ä¸å†éœ€è¦ï¼Œå› ä¸ºäº‹ä»¶æ˜¾ç¤ºé€»è¾‘åœ¨showSingleWizardEventä¸­
    // ä¿ç•™å‡½æ•°ä»¥é˜²å…¶ä»–åœ°æ–¹è°ƒç”¨
    console.log("showWizardEventModal called");
}
            
            // æ–°å¢ï¼šå¼€å§‹è—å“é€‰æ‹©æµç¨‹
function startTreasureSelection(event) {
    // å…³é—­é­”æ³•å¸ˆäº‹ä»¶æ¨¡æ€æ¡†
    wizardEventModal.style.display = 'none';
    isEventTriggered = false;
    
    // ä¿å­˜å½“å‰äº‹ä»¶
    currentSelectedEvent = event;
    
    // è®¾ç½®èƒŒåŒ…ä¸ºé€‰æ‹©æ¨¡å¼
    backpackModal.style.display = 'flex';
    
    // æ›´æ–°èƒŒåŒ…æ˜¾ç¤ºï¼Œåªæ˜¾ç¤ºç¬¦åˆæ¡ä»¶çš„è—å“
    updateBackpackForSelection(event.costType);
    
    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
    showMessage(`è¯·é€‰æ‹©ä¸€ä¸ª${getQualityNameFromEventType(event.costType)}å“è´¨çš„è—å“è¿›è¡Œäº¤æ˜“`);
}

// æ–°å¢ï¼šä¸ºé€‰æ‹©æ¨¡å¼æ›´æ–°èƒŒåŒ…æ˜¾ç¤º
function updateBackpackForSelection(costType) {
    // è·å–éœ€è¦ç­›é€‰çš„å“è´¨
    let targetQuality;
    if (costType === 'blueTreasure') {
        targetQuality = 'blue';
    } else if (costType === 'purpleTreasure') {
        targetQuality = 'purple';
    } else if (costType === 'orangeTreasure') {
        targetQuality = 'orange';
    }
    
    // ç­›é€‰å‡ºç¬¦åˆæ¡ä»¶çš„è—å“
    const filteredBackpack = backpack.filter(item => item.quality === targetQuality);
    
    // æ¸…ç©ºèƒŒåŒ…æ˜¾ç¤º
    backpackItems.innerHTML = '';
    
    // æ˜¾ç¤ºç­›é€‰åçš„è—å“
    filteredBackpack.forEach((treasure, index) => {
        const item = document.createElement('div');
        item.className = 'treasure-item selection-mode';
        item.setAttribute('data-index', index);
        
        const nameColor = qualityColors[treasure.quality];
        
        item.innerHTML = `
            <img class="treasure-icon" src="${treasure.image}" alt="${treasure.name}">
            <div class="treasure-name" style="color: ${nameColor}">${treasure.name}</div>
            <div class="treasure-count">${treasure.count}</div>
        `;
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼šé€‰æ‹©è¯¥è—å“
        item.addEventListener('click', function() {
            selectTreasureForEvent(treasure);
        });
        
        backpackItems.appendChild(item);
    });
    
    // ä¿®æ”¹å…³é—­æŒ‰é’®è¡Œä¸º
    const closeBtn = document.getElementById('close-backpack');
    const originalOnClick = closeBtn.onclick;
    closeBtn.onclick = function() {
        // å–æ¶ˆé€‰æ‹©æ¨¡å¼
        currentSelectedEvent = null;
        updateBackpackDisplay(); // æ¢å¤æ­£å¸¸æ˜¾ç¤º
        closeBtn.onclick = originalOnClick; // æ¢å¤åŸäº‹ä»¶
        backpackModal.style.display = 'none';
    };
}

// æ–°å¢ï¼šä»äº‹ä»¶ç±»å‹è·å–å“è´¨åç§°
function getQualityNameFromEventType(costType) {
    if (costType === 'blueTreasure') return 'è“è‰²';
    if (costType === 'purpleTreasure') return 'ç´«è‰²';
    if (costType === 'orangeTreasure') return 'æ©™è‰²';
    return '';
}

// æ–°å¢ï¼šé€‰æ‹©è—å“è¿›è¡Œäº¤æ˜“
function selectTreasureForEvent(selectedTreasure) {
    if (!currentSelectedEvent) return;
    
    // å…³é—­èƒŒåŒ…æ¨¡æ€æ¡†
    backpackModal.style.display = 'none';
    
    // ä»èƒŒåŒ…ä¸­ç§»é™¤é€‰ä¸­çš„è—å“
    const treasureIndex = backpack.findIndex(item => 
        item.name === selectedTreasure.name && item.quality === selectedTreasure.quality
    );
    
    if (treasureIndex !== -1) {
        if (backpack[treasureIndex].count > 1) {
            backpack[treasureIndex].count--;
        } else {
            backpack.splice(treasureIndex, 1);
        }
        
        // æ›´æ–°UI
        updateBackpackDisplay();
        updateExhibitionStats();
        
        // åº”ç”¨BUFFæ•ˆæœ
currentBuff = {
    type: currentSelectedEvent.effect.type,
    rate: currentSelectedEvent.effect.rate,
    remainingHunts: currentSelectedEvent.effect.hunts,
    orangeCount: 0 // æ–°å¢ï¼šæ©™è‰²ç‰©å“è®¡æ•°å™¨
};
        
        // æ›´æ–°BUFFæ˜¾ç¤º
        updateBuffDisplay();
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        const buffTypeNames = {
            blue: "è“è‰²è—å“",
            purple: "ç´«è‰²è—å“", 
            orange: "æ©™è‰²è—å“"
        };
        showMessage(`äº¤æ˜“æˆåŠŸï¼ç”¨${selectedTreasure.name}æ¢å–äº†æœªæ¥${currentSelectedEvent.effect.hunts}æ¬¡å¯»å®çš„${buffTypeNames[currentSelectedEvent.effect.type]}çˆ†ç‡æå‡`);
        
        // ä¿å­˜æ¸¸æˆ
        saveGame();
        
        // æ¸…ç©ºå½“å‰äº‹ä»¶
        currentSelectedEvent = null;
    } else {
        showMessage("é€‰æ‹©å¤±è´¥ï¼Œè¯¥è—å“ä¸å­˜åœ¨ï¼");
    }
}
function getRandomWizardEvent() {
    let attempts = 0;
    const maxAttempts = 20; // æœ€å¤šå°è¯•20æ¬¡ï¼Œé¿å…æ­»å¾ªç¯
    
    while (attempts < maxAttempts) {
        // æŒ‰ç…§æ¦‚ç‡éšæœºé€‰æ‹©äº‹ä»¶
        const randomValue = Math.random();
        let cumulativeProbability = 0;
        
        for (const event of wizardEvents) {
            cumulativeProbability += event.probability;
            if (randomValue <= cumulativeProbability) {
                // æ£€æŸ¥æ¡ä»¶æ˜¯å¦æ»¡è¶³
                if (checkEventConditions(event)) {
                    return event;
                } else {
                    // æ¡ä»¶ä¸æ»¡è¶³ï¼Œç»§ç»­éšæœº
                    break;
                }
            }
        }
        
        attempts++;
    }
    
    // å°è¯•å¤šæ¬¡åä»æ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„äº‹ä»¶
    return null;
}

// æ–°å¢ï¼šæ£€æŸ¥äº‹ä»¶æ¡ä»¶æ˜¯å¦æ»¡è¶³
function checkEventConditions(event) {
    if (event.costType === 'key') {
        return hasEnoughKeys(event.costAmount);
    } else if (event.costType === 'blueTreasure') {
        return hasTreasureOfQuality('blue');
    } else if (event.costType === 'purpleTreasure') {
        return hasTreasureOfQuality('purple');
    } else if (event.costType === 'orangeTreasure') {
        return hasTreasureOfQuality('orange');
    }
    return false;
}

// æ–°å¢ï¼šæ˜¾ç¤ºå•ä¸ªäº‹ä»¶é€‰é¡¹
function showSingleWizardEvent(event) {
    // æ¸…ç©ºå®¹å™¨
    eventOptionsContainer.innerHTML = '';
    
    const option = document.createElement('div');
    option.className = 'event-option';
    
    // æ£€æŸ¥ç©å®¶æ˜¯å¦æ»¡è¶³æ¡ä»¶
    let canAfford = checkEventConditions(event);
    let costText = '';
    
    if (event.costType === 'key') {
        costText = `æ¶ˆè€—ï¼š${event.costAmount}æŠŠç ”å‘å¯†åŒ™`;
    } else if (event.costType === 'blueTreasure') {
        costText = `æ¶ˆè€—ï¼š1ä¸ªè“è‰²å“è´¨è—å“ï¼ˆéœ€é€‰æ‹©å…·ä½“è—å“ï¼‰`;
    } else if (event.costType === 'purpleTreasure') {
        costText = `æ¶ˆè€—ï¼š1ä¸ªç´«è‰²å“è´¨è—å“ï¼ˆéœ€é€‰æ‹©å…·ä½“è—å“ï¼‰`;
    } else if (event.costType === 'orangeTreasure') {
        costText = `æ¶ˆè€—ï¼š1ä¸ªæ©™è‰²å“è´¨è—å“ï¼ˆéœ€é€‰æ‹©å…·ä½“è—å“ï¼‰`;
    }
    
    if (!canAfford) {
        option.classList.add('disabled');
    }
    
    option.innerHTML = `
    <div class="event-option-header">
        <div class="event-option-title">${event.title}</div>
    </div>
    <div class="event-option-cost">${costText}</div>
    <div class="event-option-effect">æ•ˆæœï¼š${event.description}</div>
`;
    
    // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªå¯é€‰é¡¹
    if (canAfford) {
        option.classList.add('selected');
        // è®°å½•é€‰ä¸­çš„äº‹ä»¶
        currentSelectedEvent = event;
        
        // å¯ç”¨ç¡®è®¤äº¤æ˜“æŒ‰é’®
        if (confirmEventBtn) {
            confirmEventBtn.disabled = false;
        }
    } else {
        // å¦‚æœæ¡ä»¶ä¸æ»¡è¶³ï¼Œç¦ç”¨ç¡®è®¤æŒ‰é’®
        if (confirmEventBtn) {
            confirmEventBtn.disabled = true;
        }
    }
    
    // ä¿ç•™ç‚¹å‡»é€‰æ‹©åŠŸèƒ½
    if (canAfford) {
        option.addEventListener('click', function() {
            // ç§»é™¤å…¶ä»–é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.event-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            // æ·»åŠ å½“å‰é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
            option.classList.add('selected');
            // è®°å½•é€‰ä¸­çš„äº‹ä»¶
            currentSelectedEvent = event;
            
            // å¯ç”¨ç¡®è®¤äº¤æ˜“æŒ‰é’®
            if (confirmEventBtn) {
                confirmEventBtn.disabled = false;
            }
        });
    }
    
    eventOptionsContainer.appendChild(option);
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    wizardEventModal.style.display = 'flex';
}
            
            // æ¥å—é­”æ³•å¸ˆäº‹ä»¶ - ä¿®æ”¹ï¼šæ¥å—å½“å‰é€‰æ‹©çš„äº‹ä»¶
function acceptWizardEvent(event) {
    let success = false;
    
    // æ ¹æ®äº‹ä»¶ç±»å‹æ‰£é™¤æ¶ˆè€—
    if (event.costType === 'key') {
        success = removeKeys(event.costAmount);
    } else if (event.costType === 'blueTreasure') {
        success = removeTreasureOfQuality('blue');
    } else if (event.costType === 'purpleTreasure') {
        success = removeTreasureOfQuality('purple');
    } else if (event.costType === 'orangeTreasure') {
        success = removeTreasureOfQuality('orange');
    }
    
    if (success) {
        // åº”ç”¨BUFFæ•ˆæœ
currentBuff = {
    type: event.effect.type,
    rate: event.effect.rate,
    remainingHunts: event.effect.hunts,
    orangeCount: 0 // æ–°å¢ï¼šæ©™è‰²ç‰©å“è®¡æ•°å™¨
};
        
        // æ›´æ–°UI
        updateBackpackDisplay();
        updateExhibitionStats();
        updateBuffDisplay();
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        const buffTypeNames = {
            blue: "è“è‰²è—å“",
            purple: "ç´«è‰²è—å“", 
            orange: "æ©™è‰²è—å“"
        };
        showMessage(`äº¤æ˜“æˆåŠŸï¼æœªæ¥${event.effect.hunts}æ¬¡å¯»å®ï¼Œ${buffTypeNames[event.effect.type]}çˆ†ç‡æå‡è‡³${(event.effect.rate * 100).toFixed(1)}%`);
        
        // å…³é—­æ¨¡æ€æ¡†
        wizardEventModal.style.display = 'none';
        isEventTriggered = false;
        currentSelectedEvent = null; // æ¸…ç©ºå½“å‰é€‰æ‹©çš„äº‹ä»¶
        
        // ä¿å­˜æ¸¸æˆ
        saveGame();
    } else {
        showMessage("äº¤æ˜“å¤±è´¥ï¼Œç‰©å“ä¸è¶³ï¼");
    }
}
            
            // å¼€å§‹å¯»å®
            const startTreasureHunt = () => {
                if (isMoving || isReturning || isPopping) return;

                // æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦è§¦å‘é­”æ³•å¸ˆäº‹ä»¶ï¼ˆ1%æ¦‚ç‡ï¼‰
// åœ¨åœºæ™¯3ï¼ˆå¸é€šå¤ä»Šï¼‰å¯»å®æ—¶ï¼Œæœ‰1/1000æ¦‚ç‡è§¦å‘è¿›å…¥åœºæ™¯9çš„äº‹ä»¶
if (currentScene === 3) { // ç¡®ä¿å½“å‰åœ¨åœºæ™¯3
    // 1/1000çš„æ¦‚ç‡è§¦å‘äº‹ä»¶
    if (Math.random() < 0.001) {
        // åˆ›å»ºäº‹ä»¶æç¤ºæ¡†
        const eventDialog = document.createElement('div');
        eventDialog.className = 'modal';
        eventDialog.id = 'special-event-modal';
        eventDialog.style.display = 'flex';
        eventDialog.innerHTML = `
            <div class="modal-content" style="max-width: 400px; text-align: center;">
                <div class="modal-header">
                    <div class="modal-title">ç¥ç§˜äº‹ä»¶</div>
                    <button class="close-modal" id="close-special-event">Ã—</button>
                </div>
                <div style="padding: 20px;">
                    <div style="font-size: 18px; margin-bottom: 15px; color: #ffcc00;">
                        ğŸ­ æ„å¤–æƒŠå–œ
                    </div>
                    <div style="margin-bottom: 20px; line-height: 1.5;">
                        å½“ä½ åœ¨é’±å¸é¦†ç–¯ç‹‚å¯»å®æ—¶ï¼Œæœ‰ä¸ªå·¥ä½œäººå‘˜ç¥ç§˜å…®å…®åœ°é€’ç»™ä½ ä¸€å¼ çº¸æ¡ï¼Œä¸Šé¢å†™ç€<br>
                        <strong>'æ­å–œè·å¾—å…§é¦†å¯»å®æœºä¼šï¼Œé—¨ç¥¨500w'</strong>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                        <button id="enter-inner-museum" style="background: linear-gradient(to right, #2ecc71, #27ae60); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; flex: 1;">è¿›å…¥</button>
                        <button id="close-event-dialog" style="background: linear-gradient(to right, #e74c3c, #c0392b); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; flex: 1;">å…³é—­</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(eventDialog);

        // ç»‘å®šå…³é—­æŒ‰é’®äº‹ä»¶
        document.getElementById('close-special-event').addEventListener('click', function() {
            document.body.removeChild(eventDialog);
        });
        
        document.getElementById('close-event-dialog').addEventListener('click', function() {
            document.body.removeChild(eventDialog);
        });

        // ç»‘å®šè¿›å…¥æŒ‰é’®äº‹ä»¶
        document.getElementById('enter-inner-museum').addEventListener('click', function() {
            // æ£€æŸ¥é‡‘å¸æ˜¯å¦è¶³å¤Ÿ
            if (gold >= 5000000) {
                // æ‰£é™¤500ä¸‡é‡‘å¸
                gold -= 5000000;
                
                // åˆ‡æ¢åˆ°åœºæ™¯9
                currentScene = 9;
                updateCurrentSceneTreasures();
                updateSceneDisplay();
                
                // æ›´æ–°èƒŒæ™¯å›¾ç‰‡
                gameContainer.style.backgroundImage = `url('${scenes[8].background}')`; // åœºæ™¯9çš„èƒŒæ™¯
                gameContainer.style.backgroundSize = 'cover';
                gameContainer.style.backgroundPosition = 'center';
                
                // æ›´æ–°UI
                updateExhibitionStats();
                updateHandbookDisplay();
                
                // ä¿å­˜æ¸¸æˆ
                saveGame();
                
                showMessage("æˆåŠŸè¿›å…¥é’±å¸å…§é¦†ï¼èŠ±è´¹äº†500ä¸‡é‡‘å¸");
                
                // ç§»é™¤å¯¹è¯æ¡†
                document.body.removeChild(eventDialog);
            } else {
                showMessage("é‡‘å¸ä¸è¶³ï¼éœ€è¦500ä¸‡é‡‘å¸æ‰èƒ½è¿›å…¥é’±å¸å…§é¦†");
            }
        });
    }
}
                if (!isEventTriggered && triggerWizardEvent()) {
                    // å¦‚æœè§¦å‘äº†äº‹ä»¶ï¼Œä¸è¿›è¡Œæ­£å¸¸å¯»å®
                    return;
                }

                // æ–°å¢ï¼šæ£€æŸ¥é‡‘å¸æ¶ˆè€—
                const currentSceneData = scenes[currentScene - 1];
                
                if (currentSceneData.huntCost > 0) {
                    if (gold < currentSceneData.huntCost) {
                        showMessage(`é‡‘å¸ä¸è¶³ï¼å¯»å®éœ€è¦æ¶ˆè€—${currentSceneData.huntCost}é‡‘å¸ã€‚`);
                        return;
                    }
                    
                    // æ‰£é™¤é‡‘å¸
                    gold -= currentSceneData.huntCost;
                    updateExhibitionStats(); // æ›´æ–°é‡‘å¸æ˜¾ç¤º
                    saveGame(); // ä¿å­˜æ¸¸æˆ
                }
                
                isMoving = true;
                instructions.textContent = 'æ­£åœ¨å¯»æ‰¾å®è—...';
                
                question.style.display = 'block';
                exclamation.style.display = 'none';
                
                bubble.style.transition = 'all 2s linear';
                
                moveBubble();
                moveInterval = setInterval(moveBubble, 3000);
                
                const waitTime = Math.floor(Math.random() * 2000) + 1000;
                treasureTimeout = setTimeout(() => {
                    clearInterval(moveInterval);
                    question.style.display = 'none';
                    exclamation.style.display = 'block';
                    instructions.textContent = 'å‘ç°å®è—ï¼ç‚¹å‡»è·å–ï¼';
                }, waitTime);
            };
            
            // æ°”æ³¡çˆ†ç ´æ•ˆæœ
            const popBubble = () => {
                return new Promise((resolve) => {
                    isPopping = true;
                    bubble.classList.add('bubble-pop');
                    
                    setTimeout(() => {
                        bubble.classList.remove('bubble-pop');
                        isPopping = false;
                        resolve();
                    }, 500);
                });
            };
            
            // å®Œæˆå¯»å®
const completeTreasureHunt = async () => {
    if (!isMoving || exclamation.style.display !== 'block' || isPopping) return;
    
    isMoving = false;
    isReturning = true;
    clearInterval(moveInterval);
    clearTimeout(treasureTimeout);
    
    exclamation.style.display = 'none';
    treasureCount++; // å¢åŠ æ€»å¯»å®æ¬¡æ•°
    
    const foundTreasure = getRandomTreasure();
    
    // æ›´æ–°æ©™è‰²ä¿åº•è®¡æ•°å™¨
    if (foundTreasure.quality === "orange") {
        // è·å¾—äº†æ©™è‰²ç‰©å“ï¼Œé‡ç½®è®¡æ•°å™¨
        orangeGuaranteeCounter = 0;
        lastOrangeCount = treasureCount;
    } else {
        // æœªè·å¾—æ©™è‰²ç‰©å“ï¼Œè®¡æ•°å™¨+1
        orangeGuaranteeCounter++;
    }
                
                await popBubble();
                
                addToBackpack(foundTreasure);
                
                // æ–°å¢ï¼šåº”ç”¨BUFFå¹¶å‡å°‘å‰©ä½™æ¬¡æ•°
                applyBuffAndDecrease();

// æ–°å¢ï¼šå¦‚æœåœ¨æ©™è‰²BUFFæœŸé—´è·å¾—æ©™è‰²ç‰©å“ï¼Œè®°å½•è®¡æ•°
if (currentBuff && currentBuff.type === 'orange' && foundTreasure.quality === 'orange') {
    currentBuff.orangeCount++;
}
                
                bubble.style.transition = 'all 0.5s ease';
                bubble.style.left = '50%';
                bubble.style.top = '50%';
                
                const onTransitionEnd = () => {
                    question.style.display = 'block';
                    isReturning = false;
                    bubble.removeEventListener('transitionend', onTransitionEnd);
                };
                
                bubble.addEventListener('transitionend', onTransitionEnd);
                
                setTimeout(() => {
                    instructions.textContent = 'ç‚¹å‡»å¼€å§‹æ–°çš„å¯»å®ï¼';
                }, 3000);
            };
            
            // å±•è§ˆæ”¶å…¥è®¡æ—¶å™¨
            function startIncomeTimer() {
                if (incomeInterval) clearInterval(incomeInterval);
                
                incomeInterval = setInterval(() => {
                    const now = Date.now();
                    const timeDiff = now - lastIncomeTime;
                    const fiveMinutes = 5 * 60 * 1000;
                    
                    if (timeDiff >= fiveMinutes) {
                        const income = calculateIncome();
                        gold += income;
                        lastIncomeTime = now;
                        
                        updateExhibitionStats();
                        saveGame();
                    }
                    
                    const timeLeft = fiveMinutes - timeDiff;
                    if (timeLeft > 0) {
                        const minutes = Math.floor(timeLeft / 60000);
                        const seconds = Math.floor((timeLeft % 60000) / 1000);
                        incomeTimerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    } else {
                        incomeTimerElement.textContent = '0:00';
                    }
                }, 1000);
            }
            
            // ç‚¹å‡»äº‹ä»¶å¤„ç†
            bubble.addEventListener('click', function() {
                if (!isMoving && !isReturning && !isPopping) {
                    startTreasureHunt();
                } else if (isMoving && exclamation.style.display === 'block') {
                    completeTreasureHunt();
                }
            });
            
            // æ·»åŠ è§¦æ‘¸äº‹ä»¶æ”¯æŒ
            bubble.addEventListener('touchstart', function(e) {
                e.preventDefault();
                if (!isMoving && !isReturning && !isPopping) {
                    startTreasureHunt();
                } else if (isMoving && exclamation.style.display === 'block') {
                    completeTreasureHunt();
                }
            });
            
            // æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            handbookBtn.addEventListener('click', function() {
                updateHandbookDisplay();
                handbookModal.style.display = 'flex';
            });
            
            closeHandbook.addEventListener('click', function() {
                handbookModal.style.display = 'none';
            });
            
            exhibitionBtn.addEventListener('click', function() {
                updateExhibitionStats();
                exhibitionModal.style.display = 'flex';
            });
            
            closeExhibition.addEventListener('click', function() {
                exhibitionModal.style.display = 'none';
            });
            
            researchBtn.addEventListener('click', function() {
                updateResearchDisplay();
                researchModal.style.display = 'flex';
            });
            
            closeResearch.addEventListener('click', function() {
                researchModal.style.display = 'none';
            });
            
            backpackBtn.addEventListener('click', function() {
                backpackModal.style.display = 'flex';
            });
            
            closeBackpack.addEventListener('click', function() {
                backpackModal.style.display = 'none';
            });
            
            closeDetail.addEventListener('click', function() {
                treasureDetail.style.display = 'none';
            });

// åˆæˆæŒ‰é’®äº‹ä»¶ - æ–°å¢
synthesisBtn = document.getElementById('synthesis-btn');
synthesisModal = document.getElementById('synthesis-modal');
closeSynthesis = document.getElementById('close-synthesis');
synthesisIconsContainer = document.getElementById('synthesis-icons');

if (synthesisBtn) {
    synthesisBtn.addEventListener('click', function() {
        updateSynthesisDisplay();
        synthesisModal.style.display = 'flex';
    });
}

if (closeSynthesis) {
    closeSynthesis.addEventListener('click', function() {
        synthesisModal.style.display = 'none';
    });
}

// å•†åº—æŒ‰é’®äº‹ä»¶ - æ–°å¢
shopBtn = document.getElementById('shop-btn');
shopModal = document.getElementById('shop-modal');
closeShop = document.getElementById('close-shop');
shopItemsContainer = document.getElementById('shop-items');

if (shopBtn) {
    shopBtn.addEventListener('click', function() {
        updateShopDisplay();
        shopModal.style.display = 'flex';
    });
}

if (closeShop) {
    closeShop.addEventListener('click', function() {
        shopModal.style.display = 'none';
    });
}

            // ç¦»çº¿æ”¶å…¥ç»“ç®—æ¡†å…³é—­äº‹ä»¶
            closeOfflineIncomeBtn.addEventListener('click', function() {
                offlineIncomeModal.style.display = 'none';
            });
            
            closeOfflineIncome.addEventListener('click', function() {
                offlineIncomeModal.style.display = 'none';
            });
            
            // å“è´¨ç­›é€‰æ ‡ç­¾ç‚¹å‡»äº‹ä»¶
            qualityTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    qualityTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentQualityFilter = this.getAttribute('data-quality');
                    updateBackpackDisplay();
                });
            });
            
            // åˆå§‹åŒ–é­”æ³•å¸ˆäº‹ä»¶ç›¸å…³DOMå…ƒç´  - ä¿®æ”¹ï¼šæ¸…ç©ºé€‰æ‹©çš„äº‹ä»¶
function initWizardEventElements() {
    wizardEventModal = document.getElementById('wizard-event-modal');
    closeWizardEvent = document.getElementById('close-wizard-event');
    confirmEventBtn = document.getElementById('confirm-event-btn'); // æ–°å¢
    cancelEventBtn = document.getElementById('cancel-event-btn');
    eventOptionsContainer = document.getElementById('event-options');
    
    // ç»‘å®šäº‹ä»¶
    if (closeWizardEvent) {
        closeWizardEvent.addEventListener('click', function() {
            wizardEventModal.style.display = 'none';
            isEventTriggered = false;
            currentSelectedEvent = null; // æ¸…ç©ºå½“å‰é€‰æ‹©çš„äº‹ä»¶
        });
    }
    
        // æ–°å¢ï¼šç¡®è®¤äº¤æ˜“æŒ‰é’®äº‹ä»¶
    if (confirmEventBtn) {
        confirmEventBtn.addEventListener('click', function() {
            // åˆå§‹çŠ¶æ€ä¸ºç¦ç”¨
            this.disabled = true;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„äº‹ä»¶
            if (!currentSelectedEvent) {
                showMessage("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªäº¤æ˜“é€‰é¡¹ï¼");
                this.disabled = false;
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æ»¡è¶³æ¡ä»¶
            if (!checkEventConditions(currentSelectedEvent)) {
                showMessage("æ¡ä»¶ä¸æ»¡è¶³ï¼Œæ— æ³•è¿›è¡Œäº¤æ˜“ï¼");
                this.disabled = false;
                return;
            }
            
            // å¦‚æœæ˜¯é’¥åŒ™äº‹ä»¶ï¼Œç›´æ¥æ¥å—
            if (currentSelectedEvent.costType === 'key') {
                acceptWizardEvent(currentSelectedEvent);
            } else {
                // å¦‚æœæ˜¯è—å“äº‹ä»¶ï¼Œå…ˆæ‰“å¼€èƒŒåŒ…é€‰æ‹©å…·ä½“è—å“
                startTreasureSelection(currentSelectedEvent);
            }
            
            // å¤„ç†å®Œæˆåé‡æ–°å¯ç”¨æŒ‰é’®
            setTimeout(() => {
                this.disabled = false;
            }, 1000);
        });
    }
    
    if (cancelEventBtn) {
        cancelEventBtn.addEventListener('click', function() {
            wizardEventModal.style.display = 'none';
            isEventTriggered = false;
            currentSelectedEvent = null; // æ¸…ç©ºå½“å‰é€‰æ‹©çš„äº‹ä»¶
            
            // é‡ç½®ç¡®è®¤æŒ‰é’®çŠ¶æ€
            if (confirmEventBtn) {
                confirmEventBtn.disabled = true;
            }
            
            // å¦‚æœèƒŒåŒ…å¤„äºé€‰æ‹©æ¨¡å¼ï¼Œæ¢å¤åŸçŠ¶
            if (backpackModal.style.display === 'flex') {
                updateBackpackDisplay();
                backpackModal.style.display = 'none';
            }
            
            showMessage("ä½ æ”¾å¼ƒäº†é­”æ³•å¸ˆçš„äº¤æ˜“ã€‚");
        });
    }
}
            
// æ–°å¢ï¼šæ£€æŸ¥å¹¶èµ é€12å°æ—¶ç ”å‘å¯†åŒ™
function checkAndGiveDailyKey() {
    const now = Date.now();
    const timeSinceLastGiveaway = now - lastKeyGiveawayTime;
    
    // å¦‚æœè·ç¦»ä¸Šæ¬¡èµ é€å·²ç»è¶…è¿‡12å°æ—¶
    if (timeSinceLastGiveaway >= TWELVE_HOURS) {
        // èµ é€ç ”å‘å¯†åŒ™
        giveResearchKey();
        
        // æ›´æ–°ä¸Šæ¬¡èµ é€æ—¶é—´
        lastKeyGiveawayTime = now;
        
        // ä¿å­˜æ¸¸æˆ
        saveGame();
        
        // æ˜¾ç¤ºèµ é€æ¶ˆæ¯
        showMessage("ğŸ 12å°æ—¶ç™»å½•å¥–åŠ±ï¼šè·å¾—1æŠŠç ”å‘å¯†åŒ™ï¼");
        
        return true;
    }
    
    return false;
}

// æ–°å¢ï¼šèµ é€ç ”å‘å¯†åŒ™çš„å…·ä½“å®ç°
function giveResearchKey() {
    // åˆ›å»ºç ”å‘å¯†åŒ™ç‰©å“
    const researchKeyItem = {
        name: "ç ”å‘å¯†åŒ™",
        quality: "cyan",
        level: 65,
        icon: "ğŸ”‘",
        description: "ç ”å‘å‡çº§æŠ€èƒ½æ‰€éœ€çš„å…³é”®ææ–™ï¼Œæ¯æ—¥ç™»å½•èµ é€",
        image: "images/treasures/ç ”å‘å¯†åŒ™.png",
        count: 1
    };
    
    // æ£€æŸ¥èƒŒåŒ…ä¸­æ˜¯å¦å·²æœ‰ç ”å‘å¯†åŒ™
    const existingItemIndex = backpack.findIndex(item => 
        item.name === researchKeyItem.name && item.quality === researchKeyItem.quality
    );
    
    if (existingItemIndex !== -1) {
        // å¦‚æœå·²æœ‰ï¼Œå¢åŠ æ•°é‡
        backpack[existingItemIndex].count += 1;
    } else {
        // å¦‚æœæ²¡æœ‰ï¼Œæ·»åŠ åˆ°èƒŒåŒ…
        backpack.push(researchKeyItem);
    }
    
    // å¢åŠ ç ”å‘å¯†åŒ™è®¡æ•°
    researchKeys += 1;
    
    // æ›´æ–°UIæ˜¾ç¤º
    updateBackpackDisplay();
    updateHandbookDisplay();
    updateExhibitionStats();
    
    // æ˜¾ç¤ºç ”å‘å¯†åŒ™è¯¦æƒ…ï¼ˆå¯é€‰ï¼‰
    showTreasureDetail({
        name: "ç ”å‘å¯†åŒ™",
        quality: "cyan",
        level: 65,
        icon: "ğŸ”‘",
        description: "ç ”å‘å‡çº§æŠ€èƒ½æ‰€éœ€çš„å…³é”®ææ–™ï¼Œæ¯æ—¥ç™»å½•èµ é€",
        image: "images/treasures/ç ”å‘å¯†åŒ™.png"
    });
}

// æ–°å¢ï¼šæ˜¾ç¤ºè·ç¦»ä¸‹æ¬¡èµ é€çš„æ—¶é—´ï¼ˆå¯é€‰ï¼Œå¯ä»¥åœ¨å±•è§ˆæ¨¡æ€æ¡†æ˜¾ç¤ºï¼‰
function getNextKeyGiveawayTime() {
    const nextGiveawayTime = lastKeyGiveawayTime + TWELVE_HOURS;
    const now = Date.now();
    const timeRemaining = nextGiveawayTime - now;
    
    if (timeRemaining <= 0) {
        return "ç«‹å³é¢†å–";
    }
    
    const hours = Math.floor(timeRemaining / (60 * 60 * 1000));
    const minutes = Math.floor((timeRemaining % (60 * 60 * 1000)) / (60 * 1000));
    
    return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
}

// åˆå§‹åŒ–æŒ‰é’®æ”¶çº³åŠŸèƒ½
createExpandButton();

            // åˆ›å»ºå¼€æœºé¡µé¢æ°”æ³¡
            createSplashBubbles();

            // è°ƒè¯•ä¿¡æ¯
            console.log("DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–æ¸¸æˆ");
        });
    </script>
</body>
</html>
